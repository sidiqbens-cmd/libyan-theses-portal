<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ© | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #1e293b; color: #f1f5f9; font-family: 'Segoe UI', Tahoma, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; padding: 10px; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø¨Ù†Ù…Ø· Ù†ÙŠÙˆÙ† Ø®ÙÙŠÙ */
        .glass-header { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border-bottom: 2px solid #38bdf8; padding: 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        
        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØ§Ù„Ù…Ø±ÙƒØ²ÙŠØ© */
        .panel { background: #334155; border-radius: 12px; border: 1px solid #475569; padding: 12px; shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .panel-title { font-size: 11px; font-weight: bold; color: #94a3b8; border-bottom: 1px solid #475569; margin-bottom: 10px; padding-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ù†Ù…Ø· Ø§Ù„ØµÙˆØ±Ø© */
        .grid-btn { @apply flex items-center gap-3 bg-[#475569] hover:bg-[#38bdf8] hover:text-white transition-all p-3 rounded-lg text-[10px] font-bold border border-[#64748b]; }
        
        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù†Ø­ÙŠÙØ© Lean Stats */
        .stat-line { @apply flex items-center justify-between p-2.5 bg-[#1e293b] rounded-md border-r-4 border-sky-400 mb-2; }
        .stat-line b { @apply text-sky-400 text-lg; }
        .stat-line span { @apply text-[10px] text-slate-400; }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¸Ù„Ù… */
        table { width: 100%; font-size: 10px; border-collapse: collapse; }
        th { background: #0f172a; color: #38bdf8; padding: 8px; text-align: center; position: sticky; top: 0; }
        td { border-bottom: 1px solid #475569; padding: 6px; text-align: center; }
        tr:hover { background: rgba(56, 189, 248, 0.05); }

        canvas { max-height: 110px !important; } /* ÙƒØ«Ø§ÙØ© Ø¹Ø§Ù„ÙŠØ© Ù„Ù„Ø±Ø³ÙˆÙ… */
    </style>
</head>
<body>

    <div class="glass-header">
        <div class="flex items-center gap-5">
            <div class="bg-sky-500 text-white p-3 rounded-xl text-3xl shadow-lg shadow-sky-500/20">ğŸ›ï¸</div>
            <div>
                <h1 class="text-3xl font-black tracking-tight">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ©</h1>
                <p class="text-xs text-sky-400 font-bold uppercase tracking-widest">Dashboard System v2.0</p>
            </div>
        </div>
        <div class="bg-black/30 p-4 rounded-xl border border-sky-500/30">
            <div id="live-clock" class="text-2xl font-mono font-bold text-sky-400">00:00:00</div>
            <div class="text-[9px] text-slate-500 text-center uppercase mt-1">Status: Online / Live Data</div>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-3 flex-grow overflow-hidden">
        
        <div class="col-span-3 flex flex-col gap-3 h-full">
            <div class="panel">
                <div class="panel-title">Navigation / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</div>
                <div class="grid grid-cols-1 gap-2">
                    <a href="upload.html" class="grid-btn"><span class="text-lg text-emerald-400">ğŸ“¤</span> Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Exel)</a>
                    <a href="requests.html" class="grid-btn"><span class="text-lg text-amber-400">ğŸ“©</span> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</a>
                    <a href="approved_libraries.html" class="grid-btn"><span class="text-lg text-indigo-400">ğŸ›ï¸</span> Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</a>
                    <a href="index.html" class="grid-btn"><span class="text-lg text-sky-400">ğŸŒ</span> Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</a>
                </div>
            </div>
            
            <div class="panel flex-grow overflow-y-auto">
                <div class="panel-title">Lean Stats / Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
                <div id="stats-container">
                    <div class="stat-line"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span><b id="s_total">-</b></div>
                    <div class="stat-line border-emerald-400"><span>Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª</span><b id="s_unis">-</b></div>
                    <div class="stat-line border-amber-400"><span>Ø§Ù†ØªØ¸Ø§Ø±</span><b id="s_pending">-</b></div>
                    <div class="stat-line border-indigo-400"><span>Ù…ÙƒØªØ¨Ø§Øª</span><b id="s_libs">-</b></div>
                </div>
            </div>
        </div>

        <div class="col-span-9 grid grid-rows-2 gap-3 h-full">
            <div class="grid grid-cols-3 gap-3 h-full">
                <div class="panel flex flex-col items-center">
                    <div class="panel-title">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div>
                    <canvas id="c_deg"></canvas>
                </div>
                <div class="panel flex flex-col items-center">
                    <div class="panel-title">Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ø³Ù†ÙˆÙŠ</div>
                    <canvas id="c_year"></canvas>
                </div>
                <div class="panel flex flex-col items-center">
                    <div class="panel-title">ØªÙˆØ²Ø¹ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª</div>
                    <canvas id="c_uni"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-3 h-full">
                <div class="panel flex flex-col items-center">
                    <div class="panel-title">Ø§Ù„ÙƒÙ„ÙŠØ§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ø§Ù‹</div>
                    <canvas id="c_coll"></canvas>
                </div>
                <div class="panel flex flex-col items-center">
                    <div class="panel-title">ØªÙˆØ²Ø¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
                    <canvas id="c_dept"></canvas>
                </div>
                <div class="panel col-span-1 flex flex-col overflow-hidden">
                    <div class="panel-title">Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</div>
                    <div class="overflow-y-auto flex-grow">
                        <table id="dashTable">
                            <thead><tr><th>Ø§Ù„Ø¨Ø§Ø­Ø«</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNITo9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "libyan-theses-portal",
            storageBucket: "libyan-theses-portal.appspot.com",
            messagingSenderId: "782635467382",
            appId: "1:782635467382:web:48a60589a194519f964082"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function loadData() {
            db.ref('Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„').on('value', snap => {
                let data = [], s = {deg:{}, yrs:{}, uni:{}, coll:{}, dept:{}};
                snap.forEach(c => {
                    let v = c.val(); data.push(v);
                    if(v.Ø§Ù„Ø¯Ø±Ø¬Ø©) s.deg[v.Ø§Ù„Ø¯Ø±Ø¬Ø©] = (s.deg[v.Ø§Ù„Ø¯Ø±Ø¬Ø©]||0)+1;
                    if(v.Ø§Ù„Ø³Ù†Ø©) s.yrs[v.Ø§Ù„Ø³Ù†Ø©] = (s.yrs[v.Ø§Ù„Ø³Ù†Ø©]||0)+1;
                    if(v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©) s.uni[v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©] = (s.uni[v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©]||0)+1;
                    if(v.Ø§Ù„ÙƒÙ„ÙŠØ©) s.coll[v.Ø§Ù„ÙƒÙ„ÙŠØ©] = (s.coll[v.Ø§Ù„ÙƒÙ„ÙŠØ©]||0)+1;
                    if(v.Ø§Ù„Ù‚Ø³Ù…) s.dept[v.Ø§Ù„Ù‚Ø³Ù…] = (s.dept[v.Ø§Ù„Ù‚Ø³Ù…]||0)+1;
                });
                
                document.getElementById('s_total').innerText = data.length;
                document.getElementById('s_unis').innerText = Object.keys(s.uni).length;
                
                renderCharts(s);
                document.querySelector('#dashTable tbody').innerHTML = data.reverse().slice(0, 10).map(d => `
                    <tr><td>${d.Ø§Ù„Ø¨Ø§Ø­Ø« ? d.Ø§Ù„Ø¨Ø§Ø­Ø«.split(' ')[0] : '-'}</td><td class="text-right font-bold text-sky-400 truncate max-w-[120px]">${d.Ø§Ù„Ø¹Ù†ÙˆØ§Ù†}</td></tr>
                `).join('');
            });

            db.ref('libraries').on('value', snap => {
                let p=0, a=0;
                snap.forEach(c => { if(c.val().status === 'pending') p++; else a++; });
                document.getElementById('s_pending').innerText = p;
                document.getElementById('s_libs').innerText = a;
            });
        }

        function renderCharts(s) {
            Chart.defaults.color = '#94a3b8';
            const pieOpt = { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 8, font: { size: 8 } } } } };
            const barOpt = { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#475569' } }, x: { grid: { display: false } } } };

            // Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
            new Chart(document.getElementById('c_deg'), { type: 'doughnut', data: { labels: Object.keys(s.deg), datasets: [{ data: Object.values(s.deg), backgroundColor: ['#38bdf8', '#fbbf24'], borderWidth: 0 }] }, options: pieOpt });
            new Chart(document.getElementById('c_year'), { type: 'line', data: { labels: Object.keys(s.yrs), datasets: [{ label: 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', data: Object.values(s.yrs), borderColor: '#38bdf8', fill: true, backgroundColor: 'rgba(56, 189, 248, 0.1)', tension: 0.4 }] }, options: barOpt });
            new Chart(document.getElementById('c_uni'), { type: 'pie', data: { labels: Object.keys(s.uni).slice(0, 5), datasets: [{ data: Object.values(s.uni).slice(0, 5), backgroundColor: ['#0ea5e9', '#334155', '#10b981', '#f59e0b', '#8b5cf6'], borderWidth: 0 }] }, options: pieOpt });

            // Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø³ÙÙ„ÙŠØ© (Ø§Ù„ÙƒÙ„ÙŠØ§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù…)
            new Chart(document.getElementById('c_coll'), { type: 'bar', data: { labels: Object.keys(s.coll).slice(0, 5), datasets: [{ data: Object.values(s.coll).slice(0, 5), backgroundColor: '#10b981' }] }, options: barOpt });
            new Chart(document.getElementById('c_dept'), { type: 'polarArea', data: { labels: Object.keys(s.dept).slice(0, 5), datasets: [{ data: Object.values(s.dept).slice(0, 5), backgroundColor: ['#38bdf8', '#475569', '#10b981', '#f59e0b', '#8b5cf6'], borderWidth: 0 }] }, options: pieOpt });
        }

        setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('ar-LY'); }, 1000);
        loadData();
    </script>
</body>
</html>

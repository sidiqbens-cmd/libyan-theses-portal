<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ© | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ø¬Ø¯Ø§Ù‹ Ù…Ø³ØªÙˆØ­Ø§Ø© Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© */
        body { background: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; padding: 12px; }
        
        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª (Panels) Ø¨Ø¯ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ */
        .glass-panel { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.8); border-radius: 12px; padding: 12px; height: 100%; display: flex; flex-direction: column; }
        .panel-header { font-[10px] font-bold text-slate-500 uppercase tracking-widest border-b border-slate-700 mb-3 pb-1 flex justify-between items-center; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„Ù…ØªØ±Ø§ØµØ© */
        .nav-link { @apply flex items-center gap-2 px-4 py-2 bg-slate-800 rounded-lg text-[11px] font-bold hover:bg-sky-600 transition-all border border-slate-700; }

        /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø±Ø´ÙŠÙ‚Ø© */
        .lean-stat-box { @apply flex items-center justify-between p-3 bg-slate-900/50 rounded-lg border-r-4 border-sky-500 mb-2; }
        .lean-stat-box b { @apply text-2xl text-sky-400; }
        .lean-stat-box span { @apply text-[10px] text-slate-400 font-bold; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© */
        table { width: 100%; font-size: 10px; }
        th { @apply bg-slate-800 p-2 text-sky-500 sticky top-0; }
        td { @apply p-2 border-b border-slate-800 text-center truncate max-w-[150px]; }

        canvas { max-height: 120px !important; }
    </style>
</head>
<body>

    <div class="flex justify-between items-center mb-4 bg-slate-900/80 p-5 rounded-2xl border-b-2 border-sky-500 shadow-2xl">
        <div class="flex items-center gap-6">
            <div class="bg-sky-500 p-3 rounded-xl shadow-[0_0_20px_rgba(14,165,233,0.5)]">ğŸ›ï¸</div>
            <div>
                <h1 class="text-3xl font-black text-white italic">DASHBOARD</h1>
                <p class="text-sky-400 text-xs font-bold tracking-tighter">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ© | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</p>
            </div>
        </div>
        <div class="text-left bg-black/40 px-6 py-2 rounded-xl border border-sky-500/20">
            <div id="clock" class="text-2xl font-mono font-bold text-sky-400">00:00:00</div>
            <div id="date" class="text-[9px] text-slate-500 mt-1">Status: Operational</div>
        </div>
    </div>

    <div class="flex gap-2 mb-4">
        <a href="index.html" class="nav-link text-white">ğŸŒ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</a>
        <a href="upload.html" class="nav-link text-emerald-400 italic">ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Excel)</a>
        <a href="requests.html" class="nav-link text-amber-400">ğŸ“© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</a>
        <a href="approved_libraries.html" class="nav-link text-indigo-400">ğŸ›ï¸ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</a>
        <button onclick="window.print()" class="nav-link text-rose-400">ğŸ–¨ï¸ ØªØµØ¯ÙŠØ± ØªÙ‚Ø§Ø±ÙŠØ±</button>
    </div>

    <div class="grid grid-cols-12 gap-3 flex-grow overflow-hidden">
        
        <div class="col-span-3 flex flex-col gap-3">
            <div class="glass-panel flex-none">
                <div class="panel-header">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ±ÙŠØ©</div>
                <div class="lean-stat-box"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span><b id="st_total">0</b></div>
                <div class="lean-stat-box border-emerald-500"><span>Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</span><b id="st_unis">0</b></div>
                <div class="lean-stat-box border-amber-500"><span>Ø·Ù„Ø¨Ø§Øª Ø§Ù†ØªØ¸Ø§Ø±</span><b id="st_pending">0</b></div>
            </div>
            
            <div class="glass-panel flex-grow overflow-hidden">
                <div class="panel-header">Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</div>
                <div class="overflow-y-auto h-full">
                    <table>
                        <thead><tr><th>Ø§Ù„Ø¨Ø§Ø­Ø«</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th></tr></thead>
                        <tbody id="dashTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-span-9 grid grid-rows-2 gap-3">
            <div class="grid grid-cols-3 gap-3">
                <div class="glass-panel"><div class="panel-header">Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</div><canvas id="ch_deg"></canvas></div>
                <div class="glass-panel"><div class="panel-header">Ù†Ù…Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠ</div><canvas id="ch_year"></canvas></div>
                <div class="glass-panel"><div class="panel-header">ØªÙˆØ²Ø¹ Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø¨Ø­Ø«ÙŠØ©</div><canvas id="ch_uni"></canvas></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="glass-panel"><div class="panel-header">Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„ÙŠØ§Øª Ù†Ø´Ø§Ø·Ø§Ù‹</div><canvas id="ch_coll"></canvas></div>
                <div class="glass-panel"><div class="panel-header">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</div><canvas id="ch_dept"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNITo9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "libyan-theses-portal",
            storageBucket: "libyan-theses-portal.appspot.com",
            messagingSenderId: "782635467382",
            appId: "1:782635467382:web:48a60589a194519f964082"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function updateUI() {
            db.ref('Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„').on('value', snap => {
                let all = [], s = {deg:{}, yrs:{}, uni:{}, coll:{}, dept:{}};
                snap.forEach(c => {
                    let v = c.val(); all.push(v);
                    if(v.Ø§Ù„Ø¯Ø±Ø¬Ø©) s.deg[v.Ø§Ù„Ø¯Ø±Ø¬Ø©] = (s.deg[v.Ø§Ù„Ø¯Ø±Ø¬Ø©]||0)+1;
                    if(v.Ø§Ù„Ø³Ù†Ø©) s.yrs[v.Ø§Ù„Ø³Ù†Ø©] = (s.yrs[v.Ø§Ù„Ø³Ù†Ø©]||0)+1;
                    if(v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©) s.uni[v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©] = (s.uni[v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©]||0)+1;
                    if(v.Ø§Ù„ÙƒÙ„ÙŠØ©) s.coll[v.Ø§Ù„ÙƒÙ„ÙŠØ©] = (s.coll[v.Ø§Ù„ÙƒÙ„ÙŠØ©]||0)+1;
                    if(v.Ø§Ù„Ù‚Ø³Ù…) s.dept[v.Ø§Ù„Ù‚Ø³Ù…] = (s.dept[v.Ø§Ù„Ù‚Ø³Ù…]||0)+1;
                });
                
                document.getElementById('st_total').innerText = all.length;
                document.getElementById('st_unis').innerText = Object.keys(s.uni).length;
                
                renderCharts(s);
                document.getElementById('dashTable').innerHTML = all.reverse().slice(0, 10).map(d => `
                    <tr><td>${d.Ø§Ù„Ø¨Ø§Ø­Ø« || '-'}</td><td class="text-right font-bold text-sky-400">${d.Ø§Ù„Ø¹Ù†ÙˆØ§Ù†}</td></tr>
                `).join('');
            });
            // Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ§Ù„Ù…ÙƒØªØ¨Ø§Øª
            db.ref('libraries').on('value', snap => {
                let p = 0; snap.forEach(c => { if(c.val().status === 'pending') p++; });
                document.getElementById('st_pending').innerText = p;
            });
        }

        function renderCharts(s) {
            Chart.defaults.color = '#64748b';
            const commonOpt = { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 8, font: { size: 8 } } } } };
            
            // Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
            new Chart(document.getElementById('ch_deg'), { type: 'doughnut', data: { labels: Object.keys(s.deg), datasets: [{ data: Object.values(s.deg), backgroundColor: ['#0ea5e9', '#f59e0b'], borderWidth: 0 }] }, options: commonOpt });
            new Chart(document.getElementById('ch_year'), { type: 'line', data: { labels: Object.keys(s.yrs), datasets: [{ label: 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', data: Object.values(s.yrs), borderColor: '#10b981', fill: true, backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.4 }] }, options: commonOpt });
            new Chart(document.getElementById('ch_uni'), { type: 'pie', data: { labels: Object.keys(s.uni).slice(0, 5), datasets: [{ data: Object.values(s.uni).slice(0, 5), backgroundColor: ['#0ea5e9', '#6366f1', '#10b981', '#f59e0b', '#8b5cf6'], borderWidth: 0 }] }, options: commonOpt });

            // Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            new Chart(document.getElementById('ch_coll'), { type: 'bar', data: { labels: Object.keys(s.coll).slice(0, 6), datasets: [{ label: 'Ø§Ù„ÙƒÙ„ÙŠØ©', data: Object.values(s.coll).slice(0, 6), backgroundColor: '#6366f1' }] }, options: commonOpt });
            new Chart(document.getElementById('ch_dept'), { type: 'polarArea', data: { labels: Object.keys(s.dept).slice(0, 5), datasets: [{ data: Object.values(s.dept).slice(0, 5), backgroundColor: ['#0ea5e9', '#334155', '#10b981', '#f59e0b', '#8b5cf6'], borderWidth: 0 }] }, options: commonOpt });
        }

        setInterval(() => { 
            const n = new Date();
            document.getElementById('clock').innerText = n.toLocaleTimeString('en-GB'); 
            document.getElementById('date').innerText = n.toLocaleDateString('ar-LY', {weekday:'long', day:'numeric', month:'short'});
        }, 1000);
        updateUI();
    </script>
</body>
</html>

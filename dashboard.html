<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #f1f5f9; font-family: 'Segoe UI', Tahoma, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; padding: 10px; }
        .header-box { background: white; padding: 20px; border-radius: 15px; border-bottom: 5px solid #1e3a8a; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª - Ø§Ù„Ù…Ø±ÙƒØ² */
        .charts-area { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; flex: 2; margin-bottom: 10px; }
        .chart-card { background: white; border-radius: 12px; padding: 10px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ - Ø§Ù„Ø£Ø³ÙÙ„ */
        .bottom-area { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; flex: 1.5; min-height: 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .mini-card { background: white; padding: 10px; border-radius: 10px; border-right: 4px solid #1e3a8a; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .table-container { background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; display: flex; flex-direction: column; }
        table { width: 100%; font-size: 10px; border-collapse: collapse; }
        th { background: #334155; color: white; padding: 6px; position: sticky; top: 0; }
        td { border: 1px solid #f1f5f9; padding: 4px; text-align: center; }
        
        canvas { max-height: 100% !important; width: 100% !important; }
    </style>
</head>
<body>

    <div class="header-box shadow-md">
        <div class="flex items-center gap-5">
            <div class="text-4xl bg-blue-900 text-white p-3 rounded-xl">ğŸ›ï¸</div>
            <div>
                <h1 class="text-3xl font-black text-blue-900 leading-none">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ©</h1>
                <p class="text-sm text-gray-500 mt-2 font-bold tracking-widest">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯ - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
            </div>
        </div>
        <div class="flex flex-col items-end gap-1">
            <div class="flex gap-2 mb-2">
                <a href="index.html" class="bg-blue-600 text-white px-4 py-1.5 rounded-lg text-[10px] font-bold">ğŸŒ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</a>
                <a href="add_thesis.html" class="bg-emerald-600 text-white px-4 py-1.5 rounded-lg text-[10px] font-bold">â• Ø¥Ø¶Ø§ÙØ©</a>
                <a href="requests.html" class="bg-amber-500 text-white px-4 py-1.5 rounded-lg text-[10px] font-bold">ğŸ“© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
            </div>
            <span id="clock" class="text-[11px] font-mono font-bold text-slate-500 bg-slate-100 px-3 py-1 rounded-full border italic"></span>
        </div>
    </div>

    <div class="charts-area">
        <div class="chart-card">
            <h3 class="text-[11px] font-bold text-slate-600 border-b mb-2 pb-1">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</h3>
            <div class="flex-grow"><canvas id="chartDegree"></canvas></div>
        </div>
        <div class="chart-card">
            <h3 class="text-[11px] font-bold text-slate-600 border-b mb-2 pb-1">Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ø³Ù†ÙˆÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„</h3>
            <div class="flex-grow"><canvas id="chartYears"></canvas></div>
        </div>
        <div class="chart-card">
            <h3 class="text-[11px] font-bold text-slate-600 border-b mb-2 pb-1">Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª Ù…Ø³Ø§Ù‡Ù…Ø©</h3>
            <div class="flex-grow"><canvas id="chartUnis"></canvas></div>
        </div>
    </div>

    <div class="bottom-area">
        <div class="stats-grid">
            <div class="mini-card border-blue-500" style="background: #f0f7ff">
                <span class="text-[9px] font-bold text-blue-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
                <b id="stat_total" class="text-2xl text-slate-800">-</b>
            </div>
            <div class="mini-card border-emerald-500" style="background: #f0fdf4">
                <span class="text-[9px] font-bold text-emerald-700">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª</span>
                <b id="stat_unis" class="text-2xl text-slate-800">-</b>
            </div>
            <div class="mini-card border-amber-500" style="background: #fffbeb">
                <span class="text-[9px] font-bold text-amber-700">Ø·Ù„Ø¨Ø§Øª Ø§Ù†ØªØ¸Ø§Ø±</span>
                <b id="stat_pending" class="text-2xl text-slate-800">-</b>
            </div>
            <div class="mini-card border-purple-500" style="background: #faf5ff">
                <span class="text-[9px] font-bold text-purple-700">Ù…ÙƒØªØ¨Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø©</span>
                <b id="stat_libs" class="text-2xl text-slate-800">-</b>
            </div>
        </div>

        <div class="table-container">
            <div class="bg-slate-100 p-2 text-[10px] font-black flex justify-between border-b">
                <span>Ø¢Ø®Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙˆØ±ÙŠÙ‹Ø§</span>
                <span class="text-blue-600">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ â†</span>
            </div>
            <div class="overflow-y-auto flex-grow">
                <table>
                    <thead>
                        <tr><th width="20%">Ø§Ù„Ø¨Ø§Ø­Ø«</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th width="20%">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</th><th width="10%">Ø§Ù„Ø³Ù†Ø©</th></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‡Ù†Ø§)
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNITo9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "libyan-theses-portal",
            storageBucket: "libyan-theses-portal.appspot.com",
            messagingSenderId: "782635467382",
            appId: "1:782635467382:web:48a60589a194519f964082"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function updateClock() {
            const n = new Date();
            document.getElementById('clock').innerText = n.toLocaleString('ar-LY');
        }
        setInterval(updateClock, 1000);

        function fetchData() {
            db.ref('Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„').on('value', snap => {
                let data = [], s = {deg:{}, yrs:{}, uni:{}};
                snap.forEach(c => {
                    let v = c.val(); data.push(v);
                    if(v.Ø§Ù„Ø¯Ø±Ø¬Ø©) s.deg[v.Ø§Ù„Ø¯Ø±Ø¬Ø©] = (s.deg[v.Ø§Ù„Ø¯Ø±Ø¬Ø©]||0)+1;
                    if(v.Ø§Ù„Ø³Ù†Ø©) s.yrs[v.Ø§Ù„Ø³Ù†Ø©] = (s.yrs[v.yrs]||0)+1; // ØªØµØ­ÙŠØ­: Ø§Ù„Ø³Ù†Ø© ÙƒÙ…ÙØªØ§Ø­
                    if(v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©) s.uni[v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©] = (s.uni[v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©]||0)+1;
                });
                document.getElementById('stat_total').innerText = data.length;
                document.getElementById('stat_unis').innerText = Object.keys(s.uni).length;
                renderCharts(s);
                renderTable(data.reverse().slice(0, 10));
            });
            db.ref('libraries').on('value', snap => {
                let p=0, a=0;
                snap.forEach(c => { if(c.val().status === 'pending') p++; else a++; });
                document.getElementById('stat_pending').innerText = p;
                document.getElementById('stat_libs').innerText = a;
            });
        }

        function renderCharts(s) {
            // Ø±Ø³Ù… Ø¯Ø§Ø¦Ø±ÙŠ Ù„Ù„Ø¯Ø±Ø¬Ø§Øª
            new Chart(document.getElementById('chartDegree'), {
                type: 'doughnut',
                data: { labels: Object.keys(s.deg), datasets: [{ data: Object.values(s.deg), backgroundColor: ['#1e40af', '#fbbf24'] }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 8 } } } } }
            });
            // Ø±Ø³Ù… Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ø³Ù†ÙˆØ§Øª
            new Chart(document.getElementById('chartYears'), {
                type: 'bar',
                data: { labels: Object.keys(s.yrs), datasets: [{ label: 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', data: Object.values(s.yrs), backgroundColor: '#10b981' }] },
                options: { maintainAspectRatio: false }
            });
            // Ø±Ø³Ù… Ø¯Ø§Ø¦Ø±ÙŠ Ù„Ù„Ø¬Ø§Ù…Ø¹Ø§Øª
            new Chart(document.getElementById('chartUnis'), {
                type: 'pie',
                data: { labels: Object.keys(s.uni).slice(0, 5), datasets: [{ data: Object.values(s.uni).slice(0, 5), backgroundColor: ['#1e3a8a', '#334155', '#059669', '#d97706', '#7c3aed'] }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 8, font: { size: 8 } } } } }
            });
        }

        function renderTable(list) {
            document.getElementById('tableBody').innerHTML = list.map(d => `
                <tr>
                    <td>${d.Ø§Ù„Ø¨Ø§Ø­Ø« ? d.Ø§Ù„Ø¨Ø§Ø­Ø«.split(' ')[0] : '-'}</td>
                    <td class="text-right font-bold text-blue-900">${d.Ø§Ù„Ø¹Ù†ÙˆØ§Ù†}</td>
                    <td>${d.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©}</td>
                    <td>${d.Ø§Ù„Ø³Ù†Ø©}</td>
                </tr>`).join('');
        }

        fetchData();
        updateClock();
    </script>
</body>
</html>

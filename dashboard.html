<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ©| Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø¯ÙŠØ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #020617; color: #f1f5f9; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; padding: 15px; }
        .header-panel { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(56, 189, 248, 0.1); padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .main-title { font-size: 32px; font-weight: 900; color: #ffffff; }
        .chart-card { background: #e2e8f0; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; height: 180px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .chart-label { font-size: 10px; font-weight: 800; color: #1e293b; margin-top: 5px; }
        .stat-box { background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(56, 189, 248, 0.2); border-radius: 10px; padding: 10px; text-align: center; }
        .stat-box b { @apply text-xl text-white block font-black; }
        .stat-box span { @apply text-[9px] text-sky-400 font-bold uppercase; }
        table { width: 100%; font-size: 11px; }
        th { @apply text-sky-400 text-right pb-1 border-b border-slate-700; }
        td { @apply py-1.5 border-b border-slate-800/50 text-slate-300; }
        canvas { max-height: 130px !important; width: 100% !important; }
        .nav-btn { @apply flex-1 py-2 rounded-lg text-center text-[10px] font-bold transition-all transform hover:scale-105 shadow-md; }
    </style>
</head>
<body>

    <div class="header-panel flex justify-between items-center">
        <div>
            <h1 class="main-title text-sky-500">Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</h1>
            <p class="text-[10px] text-slate-400 font-bold tracking-widest">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ©</p>
        </div>
        <div class="flex flex-col items-end">
            <div id="live-clock" class="text-2xl font-mono font-bold text-sky-400 opacity-80">00:00:00</div>
            <button onclick="logout()" class="text-[10px] text-red-400 font-bold underline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div class="flex gap-3 mb-4">
        <a href="upload.html" class="nav-btn bg-emerald-600 text-white border-b-4 border-emerald-800">ğŸ“¤ Ø¨ÙˆØ§Ø¨Ø© Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a>
        <a href="approved_libraries.html" class="nav-btn bg-slate-800 text-slate-300 border-b-4 border-slate-900">ğŸ›ï¸ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</a>
        <a href="requests.html" class="nav-btn bg-slate-800 text-slate-300 border-b-4 border-slate-900">ğŸ“© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</a>
        <a href="index.html" class="nav-btn bg-blue-600 text-white border-b-4 border-blue-800 font-black italic">ğŸŒ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</a>
    </div>

    <div class="grid grid-cols-3 grid-rows-2 gap-4 flex-grow mb-4 overflow-hidden">
        <div class="chart-card"><canvas id="c1"></canvas><span class="chart-label">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø¬Ø¯</span></div>
        <div class="chart-card"><canvas id="c2"></canvas><span class="chart-label">Ø§Ù„Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„</span></div>
        <div class="chart-card"><canvas id="c3"></canvas><span class="chart-label">Ø£Ø¹Ù„Ù‰ 5 Ø¬Ø§Ù…Ø¹Ø§Øª</span></div>
        <div class="chart-card"><canvas id="c4"></canvas><span class="chart-label">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª</span></div>
        <div class="chart-card"><canvas id="c5"></canvas><span class="chart-label">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</span></div>
        <div class="chart-card"><canvas id="c6"></canvas><span class="chart-label">Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</span></div>
    </div>

    <div class="grid grid-cols-12 gap-4 h-[150px]">
        <div class="col-span-8 flex flex-col bg-slate-900/50 p-3 rounded-xl border border-slate-800">
            <div class="text-[9px] font-bold text-sky-500 mb-2 border-b border-slate-700 pb-1 flex justify-between">
                <span>Ø¢Ø®Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù„Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©</span>
                <span id="update-status" class="text-slate-500 italic">Ù…Ø­Ø¯Ø« Ø§Ù„Ø¢Ù†</span>
            </div>
            <div class="overflow-y-auto h-full"><table id="recentTable"></table></div>
        </div>
        <div class="col-span-4 grid grid-cols-2 gap-2">
            <div class="stat-box"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span><b id="s_total">0</b></div>
            <div class="stat-box"><span>Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª</span><b id="s_unis">0</b></div>
            <div class="stat-box"><span>Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</span><b id="s_pending" class="text-amber-500">0</b></div>
            <div class="stat-box"><span>Ù…ÙƒØªØ¨Ø© Ù…Ø¹ØªÙ…Ø¯Ø©</span><b id="s_libs">0</b></div>
        </div>
    </div>

    <script>
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ± (Security Check)
        const currentUser = JSON.parse(sessionStorage.getItem('authenticatedLib'));
        if (!currentUser || currentUser.role !== 'admin') {
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù†ÙØ³Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¯ÙˆÙ…Ø§Ù‹ ÙƒÙ…Ø¯ÙŠØ±ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±Ø· Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø«Ø§Ø¨ØªØ©
        }

        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNITo9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "libyan-theses-portal",
            storageBucket: "libyan-theses-portal.appspot.com",
            messagingSenderId: "782635467382",
            appId: "1:782635467382:web:48a60589a194519f964082"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function loadData() {
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            db.ref('Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„').on('value', snap => {
                let data = [], s = {loc:{'Ù…Ø±ÙƒØ²ÙŠØ©':0, 'ÙƒÙ„ÙŠØ§Øª':0}, yrs:{}, uni:{}, coll:{}, dept:{}, type:{'Ù…Ø§Ø¬Ø³ØªÙŠØ±':0, 'Ø¯ÙƒØªÙˆØ±Ø§Ù‡':0}};
                
                snap.forEach(c => {
                    let v = c.val() || {};
                    data.push(v);
                    
                    let degree = String(v.Ø§Ù„Ø¯Ø±Ø¬Ø© || "").toLowerCase();
                    if(degree.includes('Ø¯ÙƒØªÙˆØ±Ø§Ù‡')) s.type['Ø¯ÙƒØªÙˆØ±Ø§Ù‡']++;
                    else s.type['Ù…Ø§Ø¬Ø³ØªÙŠØ±']++;

                    if(v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©) { s.loc['Ù…Ø±ÙƒØ²ÙŠØ©']++; s.uni[v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©] = (s.uni[v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©]||0)+1; }
                    if(v.Ø§Ù„Ø³Ù†Ø©) s.yrs[v.Ø§Ù„Ø³Ù†Ø©] = (s.yrs[v.Ø§Ù„Ø³Ù†Ø©]||0)+1;
                    if(v.Ø§Ù„ÙƒÙ„ÙŠØ©) s.coll[v.Ø§Ù„ÙƒÙ„ÙŠØ©] = (s.coll[v.Ø§Ù„ÙƒÙ„ÙŠØ©]||0)+1;
                    if(v.Ø§Ù„Ù‚Ø³Ù…) s.dept[v.Ø§Ù„Ù‚Ø³Ù…] = (s.dept[v.Ø§Ù„Ù‚Ø³Ù…]||0)+1;
                });
                
                document.getElementById('s_total').innerText = data.length;
                document.getElementById('s_unis').innerText = Object.keys(s.uni).length;
                renderCharts(s);
                
                document.getElementById('recentTable').innerHTML = data.reverse().slice(0, 10).map(d => `
                    <tr><td width="25%" class="font-bold text-slate-400">${d.Ø§Ù„Ø¨Ø§Ø­Ø« || '-'}</td><td class="text-sky-400 font-bold">${d.Ø§Ù„Ø¹Ù†ÙˆØ§Ù† || '-'}</td><td class="text-[10px] text-left">${d.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© || '-'}</td></tr>
                `).join('');
            });

            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª
            db.ref('requests').on('value', s => document.getElementById('s_pending').innerText = s.numChildren());
            db.ref('libraries').on('value', s => document.getElementById('s_libs').innerText = s.numChildren());
        }

        function renderCharts(s) {
            Chart.defaults.color = '#1e293b'; 
            const opt = { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 6, font: { size: 8, weight: 'bold' } } } } };
            
            ['c1','c2','c3','c4','c5','c6'].forEach(id => { let c = Chart.getChart(id); if(c) c.destroy(); });

            new Chart(document.getElementById('c1'), { type: 'pie', data: { labels: ['Ø¥ÙŠØ¯Ø§Ø¹ Ù…Ø±ÙƒØ²ÙŠ', 'Ø¥ÙŠØ¯Ø§Ø¹ ÙØ±Ø¹ÙŠ'], datasets: [{ data: [s.loc['Ù…Ø±ÙƒØ²ÙŠØ©'], 120], backgroundColor: ['#0ea5e9', '#6366f1'] }] }, options: opt });
            new Chart(document.getElementById('c2'), { type: 'line', data: { labels: Object.keys(s.yrs).sort(), datasets: [{ label: 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', data: Object.values(s.yrs), borderColor: '#0ea5e9', fill: true, backgroundColor: 'rgba(14, 165, 233, 0.1)', tension: 0.4 }] }, options: opt });
            new Chart(document.getElementById('c3'), { type: 'bar', data: { labels: Object.keys(s.uni).slice(0, 5), datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', data: Object.values(s.uni).slice(0, 5), backgroundColor: '#6366f1' }] }, options: opt });
            new Chart(document.getElementById('c4'), { type: 'bar', data: { labels: Object.keys(s.coll).slice(0, 5), datasets: [{ label: 'Ø§Ù„ÙƒÙ„ÙŠØ§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ù†ØªØ§Ø¬Ø§Ù‹', data: Object.values(s.coll).slice(0, 5), backgroundColor: '#10b981' }] }, options: opt });
            new Chart(document.getElementById('c5'), { type: 'polarArea', data: { labels: Object.keys(s.dept).slice(0, 5), datasets: [{ data: Object.values(s.dept).slice(0, 5), backgroundColor: ['#0ea5e9', '#6366f1', '#10b981', '#f59e0b', '#ec4899'] }] }, options: opt });
            new Chart(document.getElementById('c6'), { type: 'doughnut', data: { labels: ['Ù…Ø§Ø¬Ø³ØªÙŠØ±', 'Ø¯ÙƒØªÙˆØ±Ø§Ù‡'], datasets: [{ data: [s.type['Ù…Ø§Ø¬Ø³ØªÙŠØ±'], s.type['Ø¯ÙƒØªÙˆØ±Ø§Ù‡']], backgroundColor: ['#8b5cf6', '#ec4899'] }] }, options: opt });
        }

        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }
        setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('en-GB'); }, 1000);
        window.onload = loadData;
    </script>
</body>
</html>

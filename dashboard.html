<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ© | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #f1f5f9; font-family: 'Segoe UI', Tahoma, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; padding: 8px; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚ */
        .portal-header { background: white; padding: 25px; border-radius: 15px; border-bottom: 6px solid #1e3a8a; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± - Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ ÙÙˆÙ‚ Ø§Ù„Ø±Ø³ÙˆÙ… */
        .action-bar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 8px; }
        .btn-gate { @apply flex items-center justify-center gap-2 bg-white border border-slate-200 py-2 rounded-lg font-bold text-[10px] text-slate-700 hover:bg-blue-50 hover:border-blue-400 transition-all shadow-sm; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³ÙˆÙ… (Ù…ØµØºØ±Ø© Ù„Ù„Ù†ØµÙ) */
        .charts-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; height: 140px; margin-bottom: 8px; }
        .chart-box { background: white; border-radius: 10px; padding: 8px; border: 1px solid #e2e8f0; }

        /* Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„Ù…ØªÙ†Ø§Ø³Ù‚Ø© */
        .bottom-view { display: grid; grid-template-columns: 1fr 2fr; gap: 8px; flex-grow: 1; min-height: 0; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .stat-item { @apply bg-white rounded-lg border-r-4 border-blue-900 flex flex-col items-center justify-center shadow-sm; }
        
        .table-view { background: white; border-radius: 10px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; }
        table { width: 100%; font-size: 10px; border-collapse: collapse; }
        th { @apply bg-slate-700 text-white p-2 sticky top-0; }
        td { @apply border-b p-1.5 text-center truncate; }

        canvas { max-height: 100px !important; }
    </style>
</head>
<body>

    <div class="portal-header shadow-md">
        <div class="flex items-center gap-6">
            <div class="text-4xl bg-blue-900 text-white p-4 rounded-2xl shadow-inner">ğŸ›ï¸</div>
            <div>
                <h1 class="text-4xl font-black text-blue-900 leading-none">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ©</h1>
                <p class="text-xs text-slate-500 mt-2 font-bold tracking-[0.2em]">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</p>
            </div>
        </div>
        <div class="text-left">
            <div id="live-clock" class="text-sm font-mono font-bold text-blue-800 bg-blue-50 px-4 py-2 rounded-xl border border-blue-200"></div>
        </div>
    </div>

    <div class="action-bar">
        <a href="index.html" class="btn-gate">ğŸŒ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</a>
        <a href="upload.html" class="btn-gate text-emerald-700 italic font-black">ğŸ“¤ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª (Excel/PDF)</a>
        <a href="requests.html" class="btn-gate text-amber-600">ğŸ“© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</a>
        <a href="approved_libraries.html" class="btn-gate text-indigo-700">ğŸ›ï¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</a>
        <button onclick="window.print()" class="btn-gate">ğŸ–¨ï¸ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¡</button>
    </div>

    <div class="charts-row">
        <div class="chart-box"><canvas id="c1"></canvas></div>
        <div class="chart-box"><canvas id="c2"></canvas></div>
        <div class="chart-box"><canvas id="c3"></canvas></div>
    </div>

    <div class="bottom-view">
        <div class="stat-grid">
            <div class="stat-item border-blue-600">
                <span class="text-[9px] font-bold text-blue-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
                <b id="s_total" class="text-2xl">-</b>
            </div>
            <div class="stat-item border-emerald-600">
                <span class="text-[9px] font-bold text-emerald-600">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª</span>
                <b id="s_unis" class="text-2xl">-</b>
            </div>
            <div class="stat-item border-amber-500">
                <span class="text-[9px] font-bold text-amber-600">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                <b id="s_pending" class="text-2xl">-</b>
            </div>
            <div class="stat-item border-indigo-600">
                <span class="text-[9px] font-bold text-indigo-600">Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª</span>
                <b id="s_libs" class="text-2xl">-</b>
            </div>
        </div>

        <div class="table-view">
            <div class="bg-slate-50 p-2 text-[10px] font-black border-b flex justify-between">
                <span>Ø¢Ø®Ø± 10 Ø±Ø³Ø§Ø¦Ù„ ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</span>
                <span class="text-blue-700">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø´Ø§Ù…Ù„ â†</span>
            </div>
            <div class="overflow-y-auto flex-grow">
                <table>
                    <thead>
                        <tr><th width="20%">Ø§Ù„Ø¨Ø§Ø­Ø«</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th width="20%">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</th><th width="10%">Ø§Ù„Ø³Ù†Ø©</th></tr>
                    </thead>
                    <tbody id="dashTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNITo9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "libyan-theses-portal",
            storageBucket: "libyan-theses-portal.appspot.com",
            messagingSenderId: "782635467382",
            appId: "1:782635467382:web:48a60589a194519f964082"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function clock() {
            document.getElementById('live-clock').innerText = new Date().toLocaleString('ar-LY');
        }
        setInterval(clock, 1000);

        function loadData() {
            db.ref('Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„').on('value', snap => {
                let list = [], s = {d:{}, y:{}, u:{}};
                snap.forEach(c => {
                    let v = c.val(); list.push(v);
                    if(v.Ø§Ù„Ø¯Ø±Ø¬Ø©) s.d[v.Ø§Ù„Ø¯Ø±Ø¬Ø©] = (s.d[v.Ø§Ù„Ø¯Ø±Ø¬Ø©]||0)+1;
                    if(v.Ø§Ù„Ø³Ù†Ø©) s.y[v.Ø§Ù„Ø³Ù†Ø©] = (s.y[v.Ø§Ù„Ø³Ù†Ø©]||0)+1;
                    if(v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©) s.u[v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©] = (s.u[v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©]||0)+1;
                });
                document.getElementById('s_total').innerText = list.length;
                document.getElementById('s_unis').innerText = Object.keys(s.u).length;
                draw(s);
                document.getElementById('dashTable').innerHTML = list.reverse().slice(0, 10).map(d => `
                    <tr><td>${d.Ø§Ù„Ø¨Ø§Ø­Ø« ? d.Ø§Ù„Ø¨Ø§Ø­Ø«.split(' ')[0] : '-'}</td><td class="font-bold text-blue-900 text-right">${d.Ø§Ù„Ø¹Ù†ÙˆØ§Ù†}</td><td>${d.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©}</td><td>${d.Ø§Ù„Ø³Ù†Ø©}</td></tr>
                `).join('');
            });
            db.ref('libraries').on('value', snap => {
                let p=0, a=0;
                snap.forEach(c => { if(c.val().status === 'pending') p++; else a++; });
                document.getElementById('s_pending').innerText = p;
                document.getElementById('s_libs').innerText = a;
            });
        }

        function draw(s) {
            const opt = { maintainAspectRatio: false, plugins: { legend: { display: false } } };
            new Chart(document.getElementById('c1'), { type: 'doughnut', data: { labels: Object.keys(s.d), datasets: [{ data: Object.values(s.d), backgroundColor: ['#1e40af', '#fbbf24'] }] }, options: opt });
            new Chart(document.getElementById('c2'), { type: 'bar', data: { labels: Object.keys(s.y), datasets: [{ label: 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', data: Object.values(s.y), backgroundColor: '#10b981' }] }, options: opt });
            new Chart(document.getElementById('c3'), { type: 'pie', data: { labels: Object.keys(s.u).slice(0, 5), datasets: [{ data: Object.values(s.u).slice(0, 5), backgroundColor: ['#1e3a8a', '#334155', '#059669', '#d97706', '#7c3aed'] }] }, options: opt });
        }

        loadData();
        clock();
    </script>
</body>
</html>

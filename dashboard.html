<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم | الفهرس الليبي الموحد</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-size: 12px; background-color: #f8fafc; font-family: sans-serif; }
        .table-container { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border-radius: 8px; overflow: hidden; }
        th { background-color: #1e3a8a; color: white; padding: 12px 8px; border: 1px solid #cbd5e1; }
        td { padding: 8px; border: 1px solid #e2e8f0; text-align: center; background: white; }
        .btn-approve { background-color: #15803d; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold; transition: 0.3s; }
        .btn-approve:hover { background-color: #000; scale: 1.05; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-lg shadow-sm border-r-8 border-blue-900">
            <h1 class="text-blue-900 font-bold text-xl">إدارة طلبات الانضمام | الفهرس الليبي الموحد</h1>
            <div id="counter" class="bg-blue-100 text-blue-800 px-4 py-1 rounded-full font-bold text-sm">جاري جلب الطلبات...</div>
        </div>

        <div class="table-container">
            <table class="w-full border-collapse">
                <thead>
                    <tr>
                        <th class="w-1/4">اسم المكتبة</th>
                        <th>المدينة</th>
                        <th>التبعية</th>
                        <th>الهاتف</th>
                        <th>الموقع</th>
                        <th>التاريخ</th>
                        <th>الإجراء</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // إعدادات Firebase الخاصة بك
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNito9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            projectId: "libyan-theses-portal",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            appId: "1:80818219253:web:5ca7224ac6a5c8a7377dbc"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // دالة الاعتماد: تنقل البيانات وتحدث الحالة
        function approveRequest(requestId, libraryData) {
            if (confirm(`هل أنت متأكد من اعتماد مكتبة: ${libraryData.libraryName || libraryData.name}؟`)) {
                // 1. نقل البيانات إلى مجلد المكتبات المعتمدة
                db.ref('approved_libraries').child(requestId).set({
                    ...libraryData,
                    status: 'approved',
                    approvalDate: new Date().toISOString()
                }).then(() => {
                    // 2. حذف الطلب من قائمة الانتظار
                    return db.ref('join_requests').child(requestId).remove();
                }).then(() => {
                    alert("تم اعتماد المكتبة ونقلها بنجاح! ✅");
                }).catch(error => {
                    console.error("Error:", error);
                    alert("حدث خطأ أثناء الاعتماد.");
                });
            }
        }

        // جلب البيانات وعرضها في الجدول
        db.ref('join_requests').on('value', (snapshot) => {
            const tbody = document.getElementById('tableBody');
            const counterDiv = document.getElementById('counter');
            tbody.innerHTML = '';
            let count = 0;

            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    const data = child.val();
                    const id = child.key;
                    count++;

                    // عرض البيانات مع دعم الأسماء القديمة والجديدة لضمان عدم فقدان أي داتا
                    const row = `
                        <tr class="hover:bg-blue-50 transition">
                            <td class="font-bold text-blue-900 text-right pr-4">${data.libraryName || data.name || '-'}</td>
                            <td class="font-bold text-green-700">${data.city || data.college || data.university || '-'}</td>
                            <td class="text-gray-600">${data.affiliation || data.university || '-'}</td>
                            <td class="font-mono">${data.phone || '-'}</td>
                            <td><a href="${data.location || data.mapUrl}" target="_blank" class="text-blue-500 underline text-[10px]">عرض الخريطة</a></td>
                            <td class="text-gray-400 text-[10px]">${data.requestDate || data.joinDate || '-'}</td>
                            <td>
                                <button onclick='approveRequest("${id}", ${JSON.stringify(data)})' class="btn-approve">
                                    اعتماد ✅
                                </button>
                            </td>
                        </tr>`;
                    tbody.innerHTML += row;
                });
                counterDiv.innerText = `${count} طلبات معلقة`;
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="p-12 text-gray-400 italic text-lg">لا توجد طلبات انضمام حالياً</td></tr>';
                counterDiv.innerText = "0 طلبات";
            }
        });
    </script>
</body>
</html>

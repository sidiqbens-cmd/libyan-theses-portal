<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ© | Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        /* Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙØ­Ø© Ø¯Ø§ÙƒÙ†Ø© Ø¬Ø¯Ø§Ù‹ */
        body { background: #020617; color: #f1f5f9; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; padding: 25px; }
        
        /* Ù‡ÙŠØ¯Ø± ÙØ§ØªØ­ ÙˆØ¨Ø§Ø±Ø² */
        .portal-header { background: rgba(30, 41, 59, 0.4); border-bottom: 2px solid #38bdf8; padding: 20px; border-radius: 15px; margin-bottom: 30px; }
        .main-title { font-size: 60px; font-weight: 900; color: #ffffff; line-height: 1; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }

        /* ØªØ¨Ø§Ø¹Ø¯ 1 Ø³Ù… Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± */
        .grid-gap { gap: 38px; }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ…: Ø¬Ø¹Ù„Ù†Ø§Ù‡Ø§ ÙØ§ØªØ­Ø© Ø¨ÙˆØ¶ÙˆØ­ Ù„ØªØ¸Ù‡Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
        .chart-card-light { 
            background: #1e293b; /* Ù„ÙˆÙ† ÙØ§ØªØ­ Ù†Ø³Ø¨ÙŠØ§Ù‹ Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ© */
            border: 1px solid #334155;
            border-radius: 16px; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            height: 200px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        .chart-label { @apply text-[12px] text-sky-400 font-bold mt-3 uppercase tracking-widest; }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø¥Ø­ØµØ§Ø¡ Ø³ÙÙ„ÙŠØ© */
        .stat-pill { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 12px; text-align: center; }
        .stat-pill b { @apply text-3xl text-white block font-black; }
        .stat-pill span { @apply text-[11px] text-slate-500 font-bold; }

        table { width: 100%; font-size: 13px; border-collapse: collapse; }
        th { @apply text-sky-400 text-right pb-3 border-b border-slate-700; }
        td { @apply py-3 border-b border-slate-800/50 text-slate-300; }

        canvas { max-height: 140px !important; width: 100% !important; }
    </style>
</head>
<body>

    <div class="portal-header flex justify-between items-center">
        <div>
            <h1 class="main-title">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ©</h1>
            <p class="text-sky-400 font-bold text-sm mt-3 tracking-widest uppercase">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© ÙˆØ§Ù„Ø³ÙŠØ·Ø±Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</p>
        </div>
        <div class="bg-black/40 p-4 rounded-xl border border-sky-500/20">
            <div id="live-clock" class="text-3xl font-mono font-bold text-sky-500">00:00:00</div>
        </div>
    </div>

    <div class="flex gap-4 mb-8">
        <a href="upload.html" class="flex-1 py-3 bg-sky-600 border border-sky-400 rounded-xl text-center text-sm font-bold text-white hover:bg-sky-500 shadow-lg shadow-sky-900/20 transition-all">ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Excel)</a>
        <a href="approved_libraries.html" class="flex-1 py-3 bg-slate-800 border border-slate-700 rounded-xl text-center text-sm font-bold text-slate-300 hover:border-sky-500">ğŸ›ï¸ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</a>
        <a href="requests.html" class="flex-1 py-3 bg-slate-800 border border-slate-700 rounded-xl text-center text-sm font-bold text-slate-300 hover:border-amber-500">ğŸ“© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</a>
        <a href="index.html" class="flex-1 py-3 bg-slate-800 border border-slate-700 rounded-xl text-center text-sm font-bold text-slate-300 hover:border-white">ğŸŒ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</a>
    </div>

    <div class="grid grid-cols-3 grid-rows-2 grid-gap flex-grow mb-8 overflow-hidden">
        <div class="chart-card-light"><canvas id="c_loc"></canvas><span class="chart-label">Ù…ÙƒØ§Ù† Ø§Ù„ØªÙˆØ§Ø¬Ø¯ (ÙƒÙ„ÙŠ)</span></div>
        <div class="chart-card-light"><canvas id="c_year"></canvas><span class="chart-label">Ø§Ù„Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„Ø²Ù…Ù†ÙŠ</span></div>
        <div class="chart-card-light"><canvas id="c_uni"></canvas><span class="chart-label">Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª</span></div>
        <div class="chart-card-light"><canvas id="c_coll"></canvas><span class="chart-label">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠØ§Øª</span></div>
        <div class="chart-card-light"><canvas id="c_dept"></canvas><span class="chart-label">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</span></div>
        <div class="chart-card-light"><canvas id="c_type"></canvas><span class="chart-label">Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (ÙƒÙ„ÙŠ)</span></div>
    </div>

    <div class="grid grid-cols-12 grid-gap h-[180px]">
        <div class="col-span-8 flex flex-col">
            <div class="text-[12px] font-bold text-sky-500 mb-2 border-b border-slate-700 pb-1 uppercase tracking-widest">Ø¢Ø®Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</div>
            <div class="overflow-y-auto flex-grow">
                <table>
                    <thead><tr><th width="20%">Ø§Ù„Ø¨Ø§Ø­Ø«</th><th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th><th width="25%">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</th></tr></thead>
                    <tbody id="recentTable"></tbody>
                </table>
            </div>
        </div>

        <div class="col-span-4 grid grid-cols-2 gap-3">
            <div class="stat-pill"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span><b id="st_total">0</b></div>
            <div class="stat-pill"><span>Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª</span><b id="st_unis">0</b></div>
            <div class="stat-pill"><span>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span><b id="st_pending" class="text-amber-500">0</b></div>
            <div class="stat-pill"><span>Ù…ÙƒØªØ¨Ø© Ù…Ø¹ØªÙ…Ø¯Ø©</span><b id="st_libs">0</b></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNITo9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "libyan-theses-portal",
            storageBucket: "libyan-theses-portal.appspot.com",
            messagingSenderId: "782635467382",
            appId: "1:782635467382:web:48a60589a194519f964082"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function load() {
            db.ref('Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„').on('value', snap => {
                let data = [], s = {loc:{'Ù…Ø±ÙƒØ²ÙŠØ©':0, 'ÙƒÙ„ÙŠØ§Øª':0, 'Ø£Ø±Ø´ÙŠÙ':0}, yrs:{}, uni:{}, coll:{}, dept:{}, type:{'Ù…Ø§Ø¬Ø³ØªÙŠØ±':0, 'Ø¯ÙƒØªÙˆØ±Ø§Ù‡':0}};
                
                snap.forEach(c => {
                    let v = c.val(); data.push(v);
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙƒÙ„ÙŠ
                    let degree = (v.Ø§Ù„Ø¯Ø±Ø¬Ø© || "").toLowerCase();
                    if(degree.includes('Ø¯ÙƒØªÙˆØ±Ø§Ù‡')) s.type['Ø¯ÙƒØªÙˆØ±Ø§Ù‡']++;
                    else s.type['Ù…Ø§Ø¬Ø³ØªÙŠØ±']++;

                    // Ù…Ø­Ø§ÙƒØ§Ø© Ù…ÙƒØ§Ù† Ø§Ù„ØªÙˆØ§Ø¬Ø¯
                    if(v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©) s.loc['Ù…Ø±ÙƒØ²ÙŠØ©']++;
                    
                    if(v.Ø§Ù„Ø³Ù†Ø©) s.yrs[v.Ø§Ù„Ø³Ù†Ø©] = (s.yrs[v.Ø§Ù„Ø³Ù†Ø©]||0)+1;
                    if(v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©) s.uni[v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©] = (s.uni[v.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©]||0)+1;
                    if(v.Ø§Ù„ÙƒÙ„ÙŠØ©) s.coll[v.Ø§Ù„ÙƒÙ„ÙŠØ©] = (s.coll[v.Ø§Ù„ÙƒÙ„ÙŠØ©]||0)+1;
                    if(v.Ø§Ù„Ù‚Ø³Ù…) s.dept[v.Ø§Ù„Ù‚Ø³Ù…] = (s.dept[v.Ø§Ù„Ù‚Ø³Ù…]||0)+1;
                });
                
                document.getElementById('st_total').innerText = data.length;
                document.getElementById('st_unis').innerText = Object.keys(s.uni).length;
                renderCharts(s);
                document.getElementById('recentTable').innerHTML = data.reverse().slice(0, 5).map(d => `
                    <tr><td class="font-bold text-white">${d.Ø§Ù„Ø¨Ø§Ø­Ø« || '-'}</td><td class="text-sky-400">${d.Ø§Ù„Ø¹Ù†ÙˆØ§Ù†}</td><td>${d.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©}</td></tr>
                `).join('');
            });
            db.ref('libraries').on('value', snap => {
                let p = 0; snap.forEach(c => { if(c.val().status === 'pending') p++; });
                document.getElementById('st_pending').innerText = p;
                document.getElementById('st_libs').innerText = snap.numChildren() - p;
            });
        }

        function renderCharts(s) {
            Chart.defaults.color = '#cbd5e1';
            const opt = { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } } } };
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¯Ø§Ø®Ù„
            const ctxs = ['c_loc', 'c_year', 'c_uni', 'c_coll', 'c_dept', 'c_type'];
            ctxs.forEach(id => { let chart = Chart.getChart(id); if(chart) chart.destroy(); });

            new Chart(document.getElementById('c_loc'), { type: 'pie', data: { labels: Object.keys(s.loc), datasets: [{ data: Object.values(s.loc), backgroundColor: ['#38bdf8', '#818cf8', '#34d399'], borderWidth: 1, borderColor: '#1e293b' }] }, options: opt });
            new Chart(document.getElementById('c_year'), { type: 'line', data: { labels: Object.keys(s.yrs), datasets: [{ label: 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', data: Object.values(s.yrs), borderColor: '#38bdf8', backgroundColor: 'rgba(56,189,248,0.2)', fill: true, tension: 0.4 }] }, options: opt });
            new Chart(document.getElementById('c_uni'), { type: 'bar', data: { labels: Object.keys(s.uni).slice(0, 5), datasets: [{ label: 'Ø§Ù„Ø¹Ø¯Ø¯', data: Object.values(s.uni).slice(0, 5), backgroundColor: '#6366f1' }] }, options: opt });
            new Chart(document.getElementById('c_coll'), { type: 'bar', data: { labels: Object.keys(s.coll).slice(0, 5), datasets: [{ label: 'Ø§Ù„Ø¹Ø¯Ø¯', data: Object.values(s.coll).slice(0, 5), backgroundColor: '#10b981' }] }, options: opt });
            new Chart(document.getElementById('c_dept'), { type: 'polarArea', data: { labels: Object.keys(s.dept).slice(0, 5), datasets: [{ data: Object.values(s.dept).slice(0, 5), backgroundColor: ['#38bdf8', '#6366f1', '#10b981', '#f59e0b', '#ec4899'], borderWidth: 0 }] }, options: opt });
            new Chart(document.getElementById('c_type'), { type: 'doughnut', data: { labels: Object.keys(s.type), datasets: [{ data: Object.values(s.type), backgroundColor: ['#8b5cf6', '#f472b6'], borderWidth: 2, borderColor: '#1e293b' }] }, options: opt });
        }

        setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('en-GB'); }, 1000);
        window.onload = load;
    </script>
</body>
</html>

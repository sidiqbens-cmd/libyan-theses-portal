<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: system-ui; background-color: #f1f5f9; font-size: 11px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 8px; text-align: right; border-bottom: 1px solid #e2e8f0; }
        th { background-color: #1e3a8a; color: white; font-size: 10px; }
        .approve-btn { background-color: #059669; color: white; padding: 4px 8px; rounded: 4px; cursor: pointer; }
        .approve-btn:hover { background-color: #047857; }
    </style>
</head>
<body class="p-4">

<div class="max-w-5xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-lg font-bold text-blue-900">ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h1>
        <a href="admin.html" class="bg-slate-500 text-white px-3 py-1 rounded text-xs">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
    </div>

    <div id="loading" class="text-center p-10 text-slate-500 font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</div>

    <div class="overflow-x-auto shadow-md rounded-lg">
        <table id="librariesTable" class="hidden">
            <thead>
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø©</th>
                    <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                    <th>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø©</th>
                    <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>
</div>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø·Ø§Ø¨Ù‚ØªÙ‡Ø§ Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ)
    const firebaseConfig = {
        apiKey: "AIzaSyAogBGo2_OzNito9D9AXVyAjSjmu-DYotc",
        authDomain: "libyan-theses-portal.firebaseapp.com",
        projectId: "libyan-theses-portal",
        databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
        appId: "1:80818219253:web:5ca7224ac6a5c8a7377dbc"
    };
    
    // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const tableBody = document.getElementById('tableBody');
    const librariesTable = document.getElementById('librariesTable');
    const loading = document.getElementById('loading');

    db.ref('libraries_directory').on('value', (snapshot) => {
        tableBody.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        loading.classList.add('hidden');
        
        if (snapshot.exists()) {
            librariesTable.classList.remove('hidden');
            snapshot.forEach((childSnapshot) => {
                const lib = childSnapshot.val();
                const key = childSnapshot.key;
                
                const row = `
                    <tr class="hover:bg-slate-50">
                        <td class="font-bold text-blue-800">${lib.libraryName || '---'}</td>
                        <td>${lib.city || '---'}</td>
                        <td>${lib.libraryType || '---'}</td>
                        <td class="text-[9px]">${lib.email || '---'}</td>
                        <td class="text-gray-400">${lib.timestamp ? new Date(lib.timestamp).toLocaleDateString('ar-LY') : '---'}</td>
                        <td>
                            <button onclick="approveLibrary('${key}', '${lib.libraryName}')" class="approve-btn font-bold">âœ… Ø§Ø¹ØªÙ…Ø§Ø¯</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        } else {
            loading.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ù†Ø¶Ù…Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.";
            loading.classList.remove('hidden');
            librariesTable.classList.add('hidden');
        }
    });

    // Ø¯Ø§Ù„Ø© Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙˆÙ†Ù‚Ù„Ù‡Ø§ Ù„Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¯Ø§Ø¦Ù…
    function approveLibrary(id, name) {
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø¹ØªÙ…Ø§Ø¯ Ù…ÙƒØªØ¨Ø©: ${name}ØŸ`)) {
            // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø£ÙˆÙ„Ø§Ù‹
            db.ref('libraries_directory/' + id).once('value').then((snap) => {
                const data = snap.val();
                // 2. Ù†Ù‚Ù„Ù‡Ø§ Ù„Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¯Ø§Ø¦Ù… (approved_libraries)
                return db.ref('approved_libraries/' + id).set(data);
            }).then(() => {
                // 3. Ø­Ø°ÙÙ‡Ø§ Ù…Ù† Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
                return db.ref('libraries_directory/' + id).remove();
            }).then(() => {
                alert("ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆÙ†Ø´Ø± Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­! âœ…");
            }).catch((error) => {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
            });
        }
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>إدارة الطلبات | بوابة الرسائل الجامعية اللليبية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body class="p-2 bg-slate-50 text-[11px] font-sans">

    <div class="flex justify-between items-center mb-2 bg-white p-3 border border-slate-300 shadow-sm">
        <h1 class="text-blue-900 font-bold text-sm italic">بوابة الرسائل الجامعية اللليبية | إدارة طلبات الانضمام</h1>
        <div id="stats" class="bg-blue-100 text-blue-800 px-3 py-1 rounded font-bold italic">جاري المزامنة...</div>
    </div>

    <div class="overflow-x-auto border border-slate-300 shadow-md">
        <table class="w-full border-collapse">
            <thead>
                <tr class="bg-blue-900 text-white">
                    <th class="p-2 border border-slate-600 text-right">اسم المكتبة</th>
                    <th class="p-2 border border-slate-600">المسؤول</th>
                    <th class="p-2 border border-slate-600">البريد الإلكتروني</th>
                    <th class="p-2 border border-slate-600">الإجراء</th>
                </tr>
            </thead>
            <tbody id="requestsTableBody" class="bg-white text-center"></tbody>
        </table>
    </div>

    <script>
        // إعدادات القاعدة فقط (بدون الحاجة لخدمات الـ Auth المعقدة هنا)
        const firebaseConfig = { 
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function loadData() {
            db.ref('join_requests').on('value', snap => {
                const tbody = document.getElementById('requestsTableBody');
                tbody.innerHTML = '';
                let count = 0;
                snap.forEach(child => {
                    const v = child.val();
                    const key = child.key;
                    count++;
                    tbody.innerHTML += `
                        <tr>
                            <td class="p-2 border border-slate-200 font-bold text-blue-900 text-right">${v.libName || '-'}</td>
                            <td class="p-2 border border-slate-200">${v.contact || '-'}</td>
                            <td class="p-2 border border-slate-200 text-blue-600">${v.email || '-'}</td>
                            <td class="p-2 border border-slate-200">
                                <button onclick="approveManually('${key}', '${v.email}', '${v.libName}', '${v.phone}')" class="bg-green-700 text-white px-2 py-1 rounded font-bold hover:bg-green-800">✅ اعتماد</button>
                                <button onclick="del('${key}')" class="bg-red-600 text-white px-2 py-1 rounded font-bold mr-1">حذف</button>
                            </td>
                        </tr>`;
                });
                document.getElementById('stats').innerText = `${count} طلبات انتظار`;
            });
        }

        function approveManually(key, email, name, phone) {
            const pass = "Libya@" + Math.floor(1000 + Math.random() * 9000);
            const msg = `مرحباً مكتبة ${name}، تم اعتماد انضمامكم لبوابة الرسائل الجامعية اللليبية .\nبريد الدخول: ${email}\nكلمة المرور: ${pass}`;
            
            if(confirm(`سيتم اعتماد المكتبة بكلمة مرور: ${pass}\nهل تريد النسخ والمتابعة؟`)) {
                // 1. تسجيل المكتبة في قائمة المعتمدين
                db.ref('approved_libraries/' + key).set({
                    libName: name,
                    email: email,
                    password: pass,
                    date: new Date().toLocaleDateString()
                }).then(() => {
                    // 2. حذف الطلب من الانتظار
                    db.ref('join_requests/' + key).remove();
                    
                    // 3. فتح خيار الإرسال (إيميل)
                    const mailtoLink = `mailto:${email}?subject=اعتماد مكتبة -  بوابة الرسائل الجامعية اللليبية&body=${encodeURIComponent(msg)}`;
                    window.location.href = mailtoLink;
                    
                    alert("تم الحفظ والاعتماد. سيفتح متصفحك الآن لإرسال الإيميل.");
                });
            }
        }

        function del(key) { if(confirm('حذف الطلب نهائياً؟')) db.ref('join_requests/' + key).remove(); }
        
        loadData();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>الفهرس الليبي الموحد - إدارة الطلبات</title>
    </head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <h1 class="text-2xl font-bold mb-6">طلبات الانضمام المنتظرة</h1>
        <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-lg">
            <thead class="bg-blue-600 text-white">
                <tr>
                    <th class="py-3 px-4">اسم المكتبة</th>
                    <th class="py-3 px-4">النوع/التبعية</th>
                    <th class="py-3 px-4">الموقع</th>
                    <th class="py-3 px-4">المندوب</th>
                    <th class="py-3 px-4">الحالة</th>
                    <th class="py-3 px-4">الإجراء</th>
                </tr>
            </thead>
            <tbody id="requestsBody">
                </tbody>
        </table>
    </div>

    <script>
        // 1. جلب البيانات وعرضها في الجدول
        // تم توحيد المسار إلى join_requests ليطابق قاعدة البيانات
        db.ref('join_requests').on('value', (snapshot) => {
            const requestsBody = document.getElementById('requestsBody');
            requestsBody.innerHTML = '';
            
            snapshot.forEach((childSnapshot) => {
                const item = childSnapshot.val();
                const id = childSnapshot.key;

                // إظهار الطلبات التي حالتها 'pending' فقط
                if (item.status === 'pending') {
                    const row = `
                        <tr class="hover:bg-gray-50 border-b">
                            <td class="py-3 px-4 font-bold">${item.libraryName}</td>
                            <td class="py-3 px-4">${item.libraryType} / ${item.affiliation}</td>
                            <td class="py-3 px-4">${item.location}</td>
                            <td class="py-3 px-4">${item.adminName}</td>
                            <td class="py-3 px-4">
                                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm">قيد الانتظار</span>
                            </td>
                            <td class="py-3 px-4">
                                <button onclick="approveLibrary('${id}', '${item.email}')" 
                                        class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 shadow-sm font-bold">
                                    اعتماد ✅
                                </button>
                            </td>
                        </tr>`;
                    requestsBody.innerHTML += row;
                }
            });
        });

        // 2. دالة تغيير الحالة وإرسال إيميل ضبط كلمة المرور
        // تم التأكد من كتابة function بشكل صحيح لتظهر بالألوان البرمجية
        function approveLibrary(requestId, email) {
            // تحديث الحالة في Firebase
            db.ref('join_requests/' + requestId).update({
                status: 'تم الاعتماد'
            }).then(() => {
                // إرسال رابط ضبط كلمة المرور (Reset Password)
                // سيعمل بنجاح لأنك فعلت Email/Password في الإعدادات
                firebase.auth().sendPasswordResetEmail(email)
                    .then(() => {
                        alert("تم اعتماد المكتبة بنجاح ✅ وإرسال رابط ضبط كلمة المرور إلى: " + email);
                    })
                    .catch((error) => {
                        console.error("فشل إرسال الإيميل: ", error);
                        alert("تم الاعتماد في القاعدة، ولكن تعذر إرسال الإيميل تلقائياً.");
                    });
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ููุญุฉ ุชุญูู ุงูููุชุจุฉ | ุงูููุฑุณ ุงูููุจู ุงูููุญุฏ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #020617; font-family: 'Segoe UI', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(51, 65, 85, 0.5); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 text-slate-300">

    <div id="loginArea" class="w-full max-w-md glass p-8 rounded-[2.5rem] shadow-2xl">
        <div class="text-center mb-8">
            <h1 class="text-2xl font-black text-white italic">ุฏุฎูู ุงูููุชุจุงุช ุงููุนุชูุฏุฉ</h1>
            <p class="text-sky-400 text-[10px] font-bold uppercase tracking-widest mt-2">ุงูููุฑุณ ุงูููุจู ุงูููุญุฏ</p>
        </div>
        
        <div class="space-y-4">
            <input type="email" id="libEmail" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู" 
                   class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl text-white outline-none focus:border-sky-500 transition-all font-bold">
            
            <input type="password" id="libPass" placeholder="ูููุฉ ุงููุฑูุฑ" 
                   class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl text-white outline-none focus:border-sky-500 transition-all font-bold">
            
            <button onclick="login()" id="loginBtn" class="w-full bg-sky-500 text-slate-900 py-4 rounded-2xl font-black text-lg hover:bg-sky-400 transition-all shadow-lg shadow-sky-500/20">
                ุฏุฎูู ูููุญุฉ ุงูุฑูุน
            </button>
        </div>
    </div>

    <div id="uploadArea" class="w-full max-w-2xl hidden animate-in fade-in zoom-in duration-500">
        <div class="glass p-8 rounded-[2.5rem] shadow-2xl relative">
            <button onclick="location.reload()" class="absolute top-6 left-6 text-slate-500 hover:text-red-500 text-[10px] font-bold border border-slate-700 px-3 py-1 rounded-full">ุชุณุฌูู ุฎุฑูุฌ</button>
            
            <div class="mb-8">
                <h1 id="welcomeMsg" class="text-2xl font-black text-white italic">ูุฑุญุจุงู...</h1>
                <p class="text-sky-400 text-[10px] font-bold uppercase tracking-widest">ุจูุงุจุฉ ุฑูุน ุงูุฑุณุงุฆู ุงูุฌุงูุนูุฉ</p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-8">
                <button onclick="downloadTemplate()" class="flex flex-col items-center justify-center p-6 bg-slate-900/50 border border-slate-700 rounded-[2rem] hover:border-sky-500 transition-all group">
                    <span class="text-3xl mb-2 group-hover:scale-110 transition-transform">๐ฅ</span>
                    <span class="text-xs font-bold">ุชุญููู ูููุฐุฌ ุงูุฅูุณู</span>
                </button>
                
                <div class="relative flex flex-col items-center justify-center p-6 bg-slate-900/50 border border-slate-700 rounded-[2rem] hover:border-emerald-500 transition-all group">
                    <input type="file" id="fileInput" accept=".xlsx, .xls" class="hidden" onchange="updateFileName()">
                    <label for="fileInput" class="cursor-pointer flex flex-col items-center">
                        <span class="text-3xl mb-2 group-hover:scale-110 transition-transform">๐</span>
                        <span id="fileName" class="text-xs font-bold">ุงุฎุชุฑ ููู ุงูุจูุงูุงุช</span>
                    </label>
                </div>
            </div>

            <button onclick="processExcel()" id="uploadBtn" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black text-lg hover:bg-emerald-500 transition-all shadow-xl shadow-emerald-900/40">
                ุงุนุชูุงุฏ ูุฑูุน ุงูุจูุงูุงุช ููุฑุงู
            </button>

            <div id="status" class="mt-6 text-center text-[10px] font-bold italic tracking-wider"></div>
        </div>
    </div>

    <script>
        // ุฅุนุฏุงุฏุงุช Firebase
        const firebaseConfig = { databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentLib = null;

        // 1. ูุธููุฉ ุชุณุฌูู ุงูุฏุฎูู
        async function login() {
            const email = document.getElementById('libEmail').value;
            const pass = document.getElementById('libPass').value;
            const btn = document.getElementById('loginBtn');

            if(!email || !pass) return alert("ูุฑุฌู ููุก ูุงูุฉ ุงูุญููู");
            
            btn.innerText = "ุฌุงุฑู ุงูุชุญูู...";
            btn.disabled = true;

            const snap = await db.ref('approved_libraries').once('value');
            let found = false;
            
            snap.forEach(child => {
                const lib = child.val();
                if(lib.email === email && lib.password === pass) {
                    currentLib = { id: child.key, ...lib };
                    found = true;
                }
            });

            if(found) {
                document.getElementById('loginArea').classList.add('hidden');
                document.getElementById('uploadArea').classList.remove('hidden');
                document.getElementById('welcomeMsg').innerText = `ููุชุจุฉ ${currentLib.libName}`;
            } else {
                alert("ุงูุจุฑูุฏ ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉุ ุฃู ูู ูุชู ุชูุนูู ุญุณุงุจูู ุจุนุฏ.");
                btn.innerText = "ุฏุฎูู ูููุญุฉ ุงูุฑูุน";
                btn.disabled = false;
            }
        }

        // 2. ูุธููุฉ ุชุญุฏูุซ ุงุณู ุงูููู ุงููุฎุชุงุฑ
        function updateFileName() {
            const file = document.getElementById('fileInput').files[0];
            if(file) document.getElementById('fileName').innerText = file.name;
        }

        // 3. ูุธููุฉ ุชุญููู ุงููููุฐุฌ (Template)
        function downloadTemplate() {
            // ุงูุฃุนูุฏุฉ ุงูุณุจุนุฉ ุงููุทุงุจูุฉ ูุฌุฏูู ุงูุฅุฏุงุฑุฉ ุงูุฎุงุต ุจู
            const cols = [["ุงูุจุงุญุซ", "ุงูุนููุงู", "ุงููููุฉ", "ุงููุณู", "ุงูุณูุฉ", "ุงูุฏุฑุฌุฉ", "ุงููุดุฑู"]];
            const ws = XLSX.utils.aoa_to_sheet(cols);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ุจูุงูุงุช ุงูุฑุณุงุฆู");
            XLSX.writeFile(wb, "ูููุฐุฌ_ุงูุฑุณุงุฆู_ุงูููุฑุณ_ุงูููุจู.xlsx");
        }

        // 4. ูุธููุฉ ูุนุงูุฌุฉ ูุฑูุน ุงูุฅูุณู
        async function processExcel() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("ูุฑุฌู ุงุฎุชูุงุฑ ููู ุงูุฅูุณู ุฃููุงู");

            const btn = document.getElementById('uploadBtn');
            const status = document.getElementById('status');
            
            btn.disabled = true;
            btn.innerText = "ุฌุงุฑู ุงูุฑุจุท ูุงูุฑูุน ุงูุชููุงุฆู...";

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);

                    if(rows.length === 0) throw new Error("ุงูููู ูุงุฑุบ!");

                    for (let row of rows) {
                        // ุงูุฑุจุท ุงูุชููุงุฆู ุจุจูุงูุงุช ุงูููุชุจุฉ ุงููุณุฌูุฉ ุฏุฎูููุง
                        await db.ref('ุจูุงูุงุช_ุงูุฑุณุงุฆู').push({
                            ุงูุจุงุญุซ: row.ุงูุจุงุญุซ || "-",
                            ุงูุนููุงู: row.ุงูุนููุงู || "-",
                            ุงูุฌุงูุนุฉ: currentLib.libName, // ููุคุฎุฐ ูู ุญุณุงุจ ุงูููุชุจุฉ
                            ุงููููุฉ: row.ุงููููุฉ || "-",
                            ุงููุณู: row.ุงููุณู || "-",
                            ุงูุณูุฉ: row.ุงูุณูุฉ || "-",
                            ุงูุฏุฑุฌุฉ: row.ุงูุฏุฑุฌุฉ || "ูุงุฌุณุชูุฑ",
                            ููุงู_ุงูุชูุงุฌุฏ_ID: currentLib.id // ููุฏ ุงูุฑุจุท ุงูุณุฑู ููุฌูููุฑ
                        });
                    }

                    status.innerHTML = `<span class="text-emerald-400 animate-pulse">โ ูุฌุญุช ุงูุนูููุฉ! ุชู ุฑูุน ${rows.length} ุฑุณุงูุฉ ูุฑุจุทูุง ุจููุชุจุชูู.</span>`;
                    btn.innerText = "ุฑูุน ููู ุฅุถุงูู";
                    btn.disabled = false;
                } catch (err) {
                    alert("ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูููู: " + err.message);
                    btn.disabled = false;
                    btn.innerText = "ุญุงูู ูุฑุฉ ุฃุฎุฑู";
                }
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>

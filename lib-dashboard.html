<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ููุญุฉ ุชุญูู ุงูููุชุจุฉ | ุงูููุฑุณ ุงูููุจู ุงูููุญุฏ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body class="bg-slate-900 text-slate-300 font-sans p-4">

    <div id="loginArea" class="max-w-md mx-auto mt-20 bg-slate-800 p-8 rounded-[2rem] border border-slate-700 shadow-2xl">
        <h2 class="text-xl font-black text-white mb-6 text-center italic">ุชุณุฌูู ุฏุฎูู ุงูููุชุจุฉ</h2>
        <input type="email" id="libEmail" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงููุนุชูุฏ" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-2xl mb-4 text-white focus:border-sky-500 outline-none font-bold">
        <input type="password" id="libPass" placeholder="ูููุฉ ุงููุฑูุฑ" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-2xl mb-6 text-white focus:border-sky-500 outline-none font-bold">
        <button onclick="login()" class="w-full bg-sky-500 text-slate-900 py-4 rounded-2xl font-black hover:bg-sky-400 transition-all">ุฏุฎูู ูููุญุฉ ุงูุฑูุน</button>
    </div>

    <div id="uploadArea" class="max-w-2xl mx-auto hidden">
        <div class="bg-slate-800 p-8 rounded-[2rem] border border-slate-700 shadow-2xl relative">
            <button onclick="location.reload()" class="absolute top-6 left-6 text-slate-500 hover:text-red-500 text-[10px] font-bold">ุชุณุฌูู ุฎุฑูุฌ</button>
            
            <h1 id="welcomeMsg" class="text-2xl font-black text-white mb-2 italic italic text-sky-400">ูุฑุญุจุงู...</h1>
            <p class="text-slate-400 text-[10px] mb-8 font-bold uppercase tracking-widest">ูููููู ุงูุขู ุฑูุน ููู ุงูุฅูุณู ุงูุฎุงุต ุจุงูุฑุณุงุฆู ุงูุนูููุฉ</p>

            <div class="mb-8 p-10 border-2 border-dashed border-slate-600 rounded-[2rem] text-center hover:border-emerald-500 transition-all bg-slate-900/50">
                <input type="file" id="fileInput" accept=".xlsx, .xls" class="hidden">
                <label for="fileInput" class="cursor-pointer">
                    <span class="text-4xl block mb-4">๐ค</span>
                    <span class="text-sm font-bold block text-slate-300">ุงุฎุชุฑ ููู ุงูุฅูุณู (Excel)</span>
                    <span id="fileName" class="text-[10px] text-emerald-400 mt-2 block font-mono"></span>
                </label>
            </div>

            <button onclick="processExcel()" id="uploadBtn" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black text-lg hover:bg-emerald-500 transition-all shadow-xl shadow-emerald-900/40">
                ุงุนุชูุงุฏ ูุฑูุน ุงูุจูุงูุงุช ููุฑุงู
            </button>

            <div id="status" class="mt-6 text-center text-xs font-bold italic"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentLib = null;

        // 1. ูุธุงู ุงูุชุญูู ูู ุงูููุชุจุฉ
        async function login() {
            const email = document.getElementById('libEmail').value;
            const pass = document.getElementById('libPass').value;

            // ุงูุจุญุซ ูู ุณุฌู ุงูููุชุจุงุช ุงููุนุชูุฏุฉ
            const snap = await db.ref('approved_libraries').once('value');
            let found = false;
            
            snap.forEach(child => {
                const lib = child.val();
                if(lib.email === email && lib.password === pass) {
                    currentLib = { id: child.key, ...lib };
                    found = true;
                }
            });

            if(found) {
                document.getElementById('loginArea').classList.add('hidden');
                document.getElementById('uploadArea').classList.remove('hidden');
                document.getElementById('welcomeMsg').innerText = `ููุชุจุฉ ${currentLib.libName}`;
            } else {
                alert("ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ ุฃู ูู ูุชู ุงุนุชูุงุฏ ููุชุจุชูู ุจุนุฏ.");
            }
        }

        // 2. ูุนุงูุฌุฉ ุงูุฑูุน ุงูุชููุงุฆู
        document.getElementById('fileInput').addEventListener('change', (e) => {
            document.getElementById('fileName').innerText = e.target.files[0].name;
        });

        async function processExcel() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("ูุฑุฌู ุงุฎุชูุงุฑ ููู ุฃููุงู");

            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.innerText = "ุฌุงุฑู ุงููุนุงูุฌุฉ ูุงูุฑุจุท ุงูุชููุงุฆู...";

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet);

                for (let row of rows) {
                    await db.ref('ุจูุงูุงุช_ุงูุฑุณุงุฆู').push({
                        ุงูุนููุงู: row.ุงูุนููุงู || "-",
                        ุงูุจุงุญุซ: row.ุงูุจุงุญุซ || "-",
                        ุงูุฌุงูุนุฉ: currentLib.libName, // ุงุณู ุงูููุชุจุฉ ููุญูู ุชููุงุฆูุงู ูู ุญุณุงุจูุง
                        ุงูุฏุฑุฌุฉ: row.ุงูุฏุฑุฌุฉ || "ูุงุฌุณุชูุฑ",
                        ุงูุณูุฉ: row.ุงูุณูุฉ || "-",
                        ููุงู_ุงูุชูุงุฌุฏ_ID: currentLib.id // ุงูู ID ููุญูู ุชููุงุฆูุงู ููุฑุจุท ูุน ุตูุญุฉ ุงูุฌูููุฑ
                    });
                }

                document.getElementById('status').innerHTML = `<span class="text-emerald-400">โ ุชูุช ุงูุนูููุฉ! ุชู ุฑูุน ${rows.length} ุฑุณุงูุฉ ุจูุฌุงุญ.</span>`;
                btn.disabled = false;
                btn.innerText = "ุฑูุน ููู ุฌุฏูุฏ";
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>

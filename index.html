<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f1f5f9; overflow: hidden; }
        .filter-select { padding: 4px; border-radius: 4px; border: 1px solid #cbd5e1; font-size: 11px; background: white; outline: none; min-width: 100px; }
        th { background-color: #1e3a8a; color: white; font-weight: bold; font-size: 10px; padding: 6px; position: sticky; top: 0; z-index: 10; border: 1px solid #1e40af; }
        td { font-size: 11px; border-bottom: 1px solid #e2e8f0; padding: 4px; border-left: 1px solid #f1f5f9; background: white; }
        tr:hover td { background-color: #f8fafc; }
        .scroll-container { height: calc(100vh - 85px); overflow-y: auto; overflow-x: auto; }
        #libModal { display: none; position: fixed; z-index: 100; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    </style>
</head>
<body class="p-2 text-right">

    <div id="libModal" onclick="this.style.display='none'">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full m-4 border-t-8 border-blue-900" onclick="event.stopPropagation()">
            <h2 id="m_name" class="text-xl font-bold text-blue-900 mb-1"></h2>
            <p id="m_uni" class="text-xs text-gray-500 mb-4 border-b pb-2"></p>
            <div class="space-y-4">
                <div class="flex items-center gap-3 bg-blue-50 p-2 rounded">
                    <span class="text-xl">ğŸ“</span> 
                    <a id="m_phone" class="text-blue-700 font-bold underline text-lg"></a>
                </div>
                <div class="flex items-center gap-3 bg-gray-50 p-2 rounded">
                    <span class="text-xl">ğŸ“§</span> 
                    <span id="m_email" class="text-gray-700 text-sm"></span>
                </div>
                <a id="m_map" target="_blank" class="block w-full bg-green-600 text-white text-center py-3 rounded-md font-bold hover:bg-green-700 shadow-lg transition">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„</a>
            </div>
            <button onclick="document.getElementById('libModal').style.display='none'" class="mt-6 text-gray-400 text-[10px] w-full text-center hover:text-red-500 transition">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©</button>
        </div>
    </div>

    <div class="bg-white shadow-sm rounded border-r-4 border-blue-800 p-2 mb-2 flex flex-wrap items-center gap-3">
        <div class="flex items-center gap-2 border-l pl-3 ml-1">
            <h1 class="text-xs font-black text-blue-900 whitespace-nowrap">Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</h1>
            <a href="join.html" class="bg-blue-600 hover:bg-black text-white px-2 py-1 rounded text-[10px] font-bold transition">â• Ø§Ù†Ø¶Ù…Ø§Ù… Ù…ÙƒØªØ¨Ø©</a>
        </div>
        
        <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø§Ø­Ø«ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø§Ù„Ù…Ø´Ø±Ù..." class="filter-select w-64 border-blue-200 focus:border-blue-600">
        
        <select id="uniFilter" class="filter-select"><option value="">ÙƒÙ„ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª</option></select>
        <select id="degreeFilter" class="filter-select">
            <option value="">ÙƒÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</option>
            <option value="Ù…Ø§Ø¬Ø³ØªÙŠØ±">Ù…Ø§Ø¬Ø³ØªÙŠØ±</option>
            <option value="Ø¯ÙƒØªÙˆØ±Ø§Ù‡">Ø¯ÙƒØªÙˆØ±Ø§Ù‡</option>
            <option value="Ø¯Ø¨Ù„ÙˆÙ… Ø¹Ø§Ù„ÙŠ">Ø¯Ø¨Ù„ÙˆÙ… Ø¹Ø§Ù„ÙŠ</option>
        </select>
        
        <div id="stats" class="text-[10px] text-blue-800 mr-auto font-bold bg-blue-50 px-3 py-1.5 rounded-full border border-blue-100">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <div class="bg-white shadow rounded scroll-container border border-gray-200">
        <table class="w-full text-right border-collapse min-w-[1100px]">
            <thead>
                <tr>
                    <th class="w-[12%]">Ø§Ù„Ø¨Ø§Ø­Ø«</th>
                    <th class="w-[22%]">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
                    <th class="w-[12%]">Ø§Ù„Ù…Ø´Ø±Ù</th>
                    <th>Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© ÙˆØ§Ù„ÙƒÙ„ÙŠØ©</th>
                    <th class="w-16 text-center">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                    <th class="w-14 text-center">Ø§Ù„Ø³Ù†Ø©</th>
                    <th class="w-16 text-center">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th class="w-[15%]">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ù‚ØªÙ†ÙŠØ©</th>
                    <th class="w-10 text-center">ğŸ”—</th>
                    <th class="w-[10%]">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="thesesBody">
                </tbody>
        </table>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNito9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            projectId: "libyan-theses-portal",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            appId: "1:80818219253:web:5ca7224ac6a5c8a7377dbc"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allTheses = [];
        let libraries = {};

        // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© (Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ)
        db.ref('libraries_directory').on('value', (snap) => {
            libraries = {};
            snap.forEach(child => {
                const data = child.val();
                if(data.status === 'active') {
                    libraries[data.name.trim()] = data;
                }
            });
            fetchTheses(); // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
        });

        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ù„Ù…ÙŠØ©
        function fetchTheses() {
            db.ref('theses').on('value', (snapshot) => {
                allTheses = [];
                snapshot.forEach(child => { 
                    allTheses.push({ key: child.key, ...child.val() }); 
                });
                updateDropdowns();
                applyFilters();
            });
        }

        // 3. ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙÙ„ØªØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        function updateDropdowns() {
            const unis = [...new Set(allTheses.map(t => t.uni || t["Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©"]))].filter(Boolean).sort();
            document.getElementById('uniFilter').innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª</option>' + unis.map(u => `<option value="${u}">${u}</option>`).join('');
        }

        // 4. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„Ø¨Ø­Ø«
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const uni = document.getElementById('uniFilter').value;
            const degree = document.getElementById('degreeFilter').value;

            const filtered = allTheses.filter(t => {
                const author = (t.author || t["Ø§Ù„Ø¨Ø§Ø­Ø«"] || "").toLowerCase();
                const title = (t.title || t["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] || "").toLowerCase();
                const supervisor = (t.sup || t["Ø§Ù„Ù…Ø´Ø±Ù"] || "").toLowerCase();
                
                return (author.includes(search) || title.includes(search) || supervisor.includes(search)) && 
                       (uni === "" || (t.uni || t["Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©"]) === uni) &&
                       (degree === "" || (t.degree || t["Ø§Ù„Ø¯Ø±Ø¬Ø©"]) === degree);
            });
            renderTable(filtered);
            document.getElementById('stats').innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${filtered.length}`;
        }

        // 5. Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        function renderTable(data) {
            const tbody = document.getElementById('thesesBody');
            tbody.innerHTML = data.map(t => {
                const libName = (t.library || t["Ø§Ù„Ù…ÙƒØªØ¨Ø©"] || "").trim();
                const libInfo = libraries[libName];
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù„Ø±Ø§Ø¨Ø· Ø¶ØºØ· ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù†Øª Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙŠ Ø§Ù„Ø¯Ù„ÙŠÙ„
                const libDisplay = libInfo 
                    ? `<button onclick="showLib('${libName}')" class="text-blue-600 font-bold underline hover:text-blue-900 transition text-right">${libName}</button>`
                    : `<span class="text-gray-400 italic">${libName || '-'}</span>`;

                return `
                <tr>
                    <td class="font-bold text-gray-800">${t.author || t["Ø§Ù„Ø¨Ø§Ø­Ø«"] || '-'}</td>
                    <td class="text-blue-900 font-semibold leading-snug" style="white-space: normal;">${t.title || t["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] || '-'}</td>
                    <td class="text-gray-600 text-[10px]">${t.sup || t["Ø§Ù„Ù…Ø´Ø±Ù"] || '-'}</td>
                    <td class="text-[10px] text-gray-500">${t.uni || t["Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©"] || '-'} / ${t.college || t["Ø§Ù„ÙƒÙ„ÙŠØ©"] || '-'}</td>
                    <td class="text-center font-bold text-blue-700 bg-blue-50/30">${t.degree || t["Ø§Ù„Ø¯Ø±Ø¬Ø©"] || '-'}</td>
                    <td class="text-center font-mono">${t.year || t["Ø§Ù„Ø³Ù†Ø©"] || '-'}</td>
                    <td class="text-center">
                        <span class="px-1.5 py-0.5 rounded text-[9px] font-bold ${ (t.status || t["Ø§Ù„Ø­Ø§Ù„Ø©"]) === 'Ù…ØªÙˆÙØ±Ø©' ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-red-100 text-red-700 border border-red-200'}">
                            ${t.status || t["Ø§Ù„Ø­Ø§Ù„Ø©"] || '-'}
                        </span>
                    </td>
                    <td>${libDisplay}</td>
                    <td class="text-center">
                        ${(t.link || t["Ø§Ù„Ø±Ø§Ø¨Ø·"]) ? `<a href="${t.link || t["Ø§Ù„Ø±Ø§Ø¨Ø·"]}" target="_blank" class="text-blue-500 text-sm hover:scale-125 inline-block transition">ğŸ”—</a>` : '-'}
                    </td>
                    <td class="text-gray-400 italic text-[9px] truncate max-w-[100px]" title="${t.notes || t["Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"] || ''}">${t.notes || t["Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"] || '-'}</td>
                </tr>`;
            }).join('');
        }

        // 6. ÙˆØ¸ÙŠÙØ© Ø¥Ø¸Ù‡Ø§Ø± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function showLib(name) {
            const lib = libraries[name];
            document.getElementById('m_name').innerText = lib.name;
            document.getElementById('m_uni').innerText = lib.university + (lib.college ? ' - ' + lib.college : '');
            document.getElementById('m_phone').innerText = lib.phone;
            document.getElementById('m_phone').href = "tel:" + lib.phone;
            document.getElementById('m_email').innerText = lib.email || 'ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹';
            document.getElementById('m_map').href = lib.mapUrl;
            document.getElementById('libModal').style.display = 'flex';
        }

        // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('uniFilter').addEventListener('change', applyFilters);
        document.getElementById('degreeFilter').addEventListener('change', applyFilters);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ุจูุงุจุฉ ุงูุฑุณุงุฆู ุงูุฌุงูุนูุฉ ุงูููุจูุฉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #f8fafc; font-family: 'Segoe UI', Tahoma, sans-serif; font-size: 12px; }
        .header-bg { background: white; border-bottom: 2px solid #1e3a8a; }
        
        /* ุชุตููู ุจุทุงูุฉ ุจูุงูุงุช ุงูููุชุจุฉ ุงููุนุชูุฏุฉ */
        #libModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 100%; max-width: 380px; border-top: 6px solid #1e3a8a; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
        
        /* ุงูุฌุฏูู ุงูููุซู (Dense) */
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #334155; color: white; padding: 8px; border: 1px solid #1e293b; text-align: center; position: sticky; top: 0; }
        td { padding: 6px; border: 1px solid #e2e8f0; text-align: center; color: #334155; }
        tr:hover { background-color: #f1f5f9; }
        
        /* ุงูููุงุชุฑ ุงูุนูููุฉ */
        .filter-box { border: 2px solid #1e3a8a; border-radius: 8px; padding: 3px; background: #fff; width: 100%; height: 35px; outline: none; }
    </style>
</head>
<body>

    <div id="libModal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="text-center mb-4">
                <div class="text-5xl mb-2">๐๏ธ</div>
                <h2 id="mLibName" class="font-bold text-blue-900 text-lg"></h2>
                <p class="text-gray-500 text-[10px] mt-1">ุจูุงูุงุช ุงูุชูุงุตู ูุน ุฌูุฉ ุงูุฅูุฏุงุน</p>
            </div>
            <div class="space-y-3 text-sm border-t pt-4">
                <div class="flex justify-between border-b pb-1"><b>ุงููุฏููุฉ:</b> <span id="mCity" class="text-blue-800"></span></div>
                <div class="flex justify-between border-b pb-1"><b>ุงูุฌุงูุนุฉ:</b> <span id="mUni" class="text-blue-800"></span></div>
                <div class="flex justify-between border-b pb-1"><b>ุงููุณุคูู:</b> <span id="mManager" class="text-blue-800"></span></div>
                <div class="flex justify-between border-b pb-1"><b>ุงููุงุชู:</b> <span id="mPhone" class="text-blue-800" dir="ltr"></span></div>
            </div>
            <button onclick="document.getElementById('libModal').style.display='none'" class="w-full mt-5 bg-blue-900 text-white py-2 rounded font-bold hover:bg-blue-800">ุฅุบูุงู</button>
        </div>
    </div>

    <header class="header-bg p-4 flex justify-between items-center shadow-sm">
        <div class="text-[10px] text-gray-500 font-bold">ูุฒุงุฑุฉ ุงูุชุนููู ุงูุนุงูู ูุงูุจุญุซ ุงูุนููู</div>
        <div class="flex items-center gap-4">
             <button class="bg-green-600 text-white px-4 py-1 rounded-full text-[11px] font-bold">+ ุงูุถูุงู ููุชุจุฉ</button>
             <h1 class="text-2xl font-black text-blue-900">ุจูุงุจุฉ ุงูุฑุณุงุฆู ุงูุฌุงูุนูุฉ ุงูููุจูุฉ</h1>
        </div>
    </header>

    <main class="p-2">
        <div class="grid grid-cols-6 gap-2 mb-2">
            <div class="col-span-1 relative">
                <input type="text" id="mainSearch" onkeyup="searchData()" placeholder="ุจุญุซ ุดุงูู..." class="filter-box pr-8">
                <span class="absolute right-2 top-2">๐</span>
            </div>
            <select id="filterUni" onchange="searchData()" class="filter-box"><option value="">ุงูุฌุงูุนุฉ</option></select>
            <select id="filterCol" onchange="searchData()" class="filter-box"><option value="">ุงููููุฉ</option></select>
            <select id="filterDep" onchange="searchData()" class="filter-box"><option value="">ุงููุณู</option></select>
            <select id="filterYear" onchange="searchData()" class="filter-box"><option value="">ุงูุณูุฉ</option></select>
            <select id="filterDeg" onchange="searchData()" class="filter-box"><option value="">ุงูุฏุฑุฌุฉ</option><option>ูุงุฌุณุชูุฑ</option><option>ุฏูุชูุฑุงู</option></select>
        </div>

        <div class="bg-white border-2 border-blue-900 rounded-lg overflow-hidden shadow-lg">
            <div class="overflow-y-auto" style="height: calc(100vh - 160px);">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th width="12%">ุงูุจุงุญุซ</th>
                            <th width="30%">ุนููุงู ุงูุฑุณุงูุฉ</th>
                            <th width="12%">ุงููุดุฑู</th>
                            <th width="10%">ุงูุฌุงูุนุฉ</th>
                            <th width="8%">ุงููููุฉ</th>
                            <th width="8%">ุงููุณู</th>
                            <th width="5%">ุงูุณูุฉ</th>
                            <th width="6%">ุงูุฏุฑุฌุฉ</th>
                            <th width="10%">ุงูููุงู</th>
                            <th width="4%">๐</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNITo9D9AXVyAjSjmu-DYotc",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "libyan-theses-portal",
            appId: "1:782635467382:web:48a60589a194519f964082"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allTheses = [];
        let allLibs = {};

        function fetchInitialData() {
            // ุฌูุจ ุจูุงูุงุช ุงูููุชุจุงุช ุฃููุงู
            db.ref('libraries').once('value', snap => {
                snap.forEach(child => { allLibs[child.val().libName] = child.val(); });
                fetchTheses();
            });
        }

        function fetchTheses() {
            db.ref('ุจูุงูุงุช_ุงูุฑุณุงุฆู').on('value', snap => {
                allTheses = [];
                snap.forEach(child => { allTheses.push(child.val()); });
                renderTable(allTheses);
                populateFilters();
            });
        }

        // ุฏุงูุฉ ูุชุญ ุจุทุงูุฉ ุจูุงูุงุช ุงูููุชุจุฉ (ุงูููุงู)
        function showLibCard(libName) {
            const lib = allLibs[libName];
            if (lib) {
                document.getElementById('mLibName').innerText = lib.libName;
                document.getElementById('mCity').innerText = lib.city || "-";
                document.getElementById('mUni').innerText = lib.university || "-";
                document.getElementById('mManager').innerText = lib.manager || "-";
                document.getElementById('mPhone').innerText = lib.phone || "-";
                document.getElementById('libModal').style.display = 'flex';
            } else {
                alert("ุจูุงูุงุช ุฌูุฉ ุงูุฅูุฏุงุน ุณูุชู ุชุญุฏูุซูุง ูุฑูุจุงู");
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.ุงูุจุงุญุซ}</td>
                    <td class="font-bold text-blue-900 text-right pr-4">${item.ุงูุนููุงู}</td>
                    <td>${item.ุงููุดุฑู || "-"}</td>
                    <td>${item.ุงูุฌุงูุนุฉ}</td>
                    <td>${item.ุงููููุฉ}</td>
                    <td>${item.ุงููุณู}</td>
                    <td>${item.ุงูุณูุฉ}</td>
                    <td><span class="bg-gray-100 px-2 py-0.5 rounded text-[10px]">${item.ุงูุฏุฑุฌุฉ}</span></td>
                    <td class="cursor-pointer text-blue-600 font-bold hover:underline" onclick="showLibCard('${item.ุงูููุงู}')">
                        ${item.ุงูููุงู} โน๏ธ
                    </td>
                    <td>
                        ${item.ุงูุฑุงุจุท && item.ุงูุฑุงุจุท !== "#" ? `<a href="${item.ุงูุฑุงุจุท}" target="_blank" title="ุชุญููู/ุนุฑุถ">๐</a>` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function searchData() {
            const txt = document.getElementById('mainSearch').value.toLowerCase();
            const uni = document.getElementById('filterUni').value;
            const col = document.getElementById('filterCol').value;
            const dep = document.getElementById('filterDep').value;
            const yr = document.getElementById('filterYear').value;
            const deg = document.getElementById('filterDeg').value;

            const filtered = allTheses.filter(t => {
                return (t.ุงูุนููุงู + t.ุงูุจุงุญุซ).toLowerCase().includes(txt) &&
                       (!uni || t.ุงูุฌุงูุนุฉ === uni) &&
                       (!col || t.ุงููููุฉ === col) &&
                       (!dep || t.ุงููุณู === dep) &&
                       (!yr || t.ุงูุณูุฉ === yr) &&
                       (!deg || t.ุงูุฏุฑุฌุฉ === deg);
            });
            renderTable(filtered);
        }

        function populateFilters() {
            const fill = (id, prop) => {
                const vals = [...new Set(allTheses.map(t => t[prop]))].filter(Boolean).sort();
                const el = document.getElementById(id);
                const current = el.value;
                el.innerHTML = `<option value="">${el.options[0].text}</option>` + 
                               vals.map(v => `<option ${v===current?'selected':''}>${v}</option>`).join('');
            };
            fill('filterUni', 'ุงูุฌุงูุนุฉ'); fill('filterCol', 'ุงููููุฉ'); 
            fill('filterDep', 'ุงููุณู'); fill('filterYear', 'ุงูุณูุฉ');
        }

        window.onload = fetchInitialData;
    </script>
</body>
</html>

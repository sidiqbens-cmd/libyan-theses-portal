<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استعراض الرسائل | الفهرس الليبي الموحد</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f8fafc; }
        .filter-select { padding: 4px; border-radius: 4px; border: 1px solid #cbd5e1; font-size: 12px; background: white; outline: none; }
        th { background-color: #1e40af; color: white; font-weight: bold; font-size: 12px; padding: 8px; position: sticky; top: 0; }
        td { font-size: 12px; border-bottom: 1px solid #e2e8f0; }
        tr:hover { background-color: #f1f5f9; }
        /* واجهة مكثفة لتقليل التمرير */
        .dense-container { height: calc(100vh - 120px); overflow-y: auto; }
    </style>
</head>
<body class="p-2">

    <div class="bg-white shadow-sm rounded-lg p-3 mb-2 border-r-4 border-blue-700">
        <div class="flex flex-wrap items-center gap-3">
            <h1 class="text-sm font-bold text-blue-900 ml-4">الفهرس الليبي الموحد</h1>
            
            <input type="text" id="searchInput" placeholder="بحث بالعنوان أو الباحث..." class="filter-select w-64 border-blue-300 focus:ring-1 focus:ring-blue-500">
            
            <select id="uniFilter" class="filter-select"><option value="">كل الجامعات</option></select>
            <select id="yearFilter" class="filter-select"><option value="">كل السنوات</option></select>
            <select id="statusFilter" class="filter-select">
                <option value="">كل الحالات</option>
                <option value="متوفرة">✅ متوفرة</option>
                <option value="غير متوفرة">❌ غير متوفرة</option>
            </select>
            
            <div id="stats" class="text-[11px] text-gray-500 mr-auto font-bold">جاري تحميل البيانات...</div>
        </div>
    </div>

    <div class="bg-white shadow-md rounded-lg overflow-hidden dense-container">
        <table class="w-full text-right border-collapse">
            <thead>
                <tr>
                    <th class="w-16">رقم الرسالة</th>
                    <th>عنوان الرسالة العلمية</th>
                    <th>اسم الباحث</th>
                    <th>الجامعة/الكلية</th>
                    <th class="w-16 text-center">السنة</th>
                    <th class="w-20 text-center">الحالة</th>
                    <th class="w-20 text-center">الرابط</th>
                    <th>الملاحظات</th>
                </tr>
            </thead>
            <tbody id="thesesBody">
                </tbody>
        </table>
    </div>

    <script>
        // إعدادات Firebase الخاصة بك
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNito9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            projectId: "libyan-theses-portal",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            appId: "1:80818219253:web:5ca7224ac6a5c8a7377dbc"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allTheses = [];

        // جلب البيانات فورياً
        db.ref('theses').on('value', (snapshot) => {
            allTheses = [];
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    allTheses.push({ key: child.key, ...child.val() });
                });
                updateFilters();
                applyFilters();
            } else {
                document.getElementById('thesesBody').innerHTML = '<tr><td colspan="8" class="text-center py-10">لا توجد رسائل مرفوعة حالياً</td></tr>';
                document.getElementById('stats').innerText = "0 رسالة";
            }
        });

        // تحديث القوائم المنسدلة بناءً على البيانات الموجودة
        function updateFilters() {
            const unis = [...new Set(allTheses.map(t => t.uni || t["الجامعة"]))].filter(Boolean);
            const years = [...new Set(allTheses.map(t => t.year || t["السنة"]))].filter(Boolean).sort((a,b)=>b-a);
            
            const uniSelect = document.getElementById('uniFilter');
            const yearSelect = document.getElementById('yearFilter');
            
            uniSelect.innerHTML = '<option value="">كل الجامعات</option>' + unis.map(u => `<option value="${u}">${u}</option>`).join('');
            yearSelect.innerHTML = '<option value="">كل السنوات</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
        }

        // دالة الفلترة والعرض
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedUni = document.getElementById('uniFilter').value;
            const selectedYear = document.getElementById('yearFilter').value;
            const selectedStatus = document.getElementById('statusFilter').value;

            const filtered = allTheses.filter(t => {
                const title = (t.title || t["العنوان"] || "").toLowerCase();
                const author = (t.author || t["الباحث"] || "").toLowerCase();
                const uni = t.uni || t["الجامعة"] || "";
                const year = t

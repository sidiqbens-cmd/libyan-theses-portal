<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #f8fafc; font-family: 'Segoe UI', Tahoma, sans-serif; font-size: 11px; direction: rtl; overflow-x: hidden; }
        .header-bg { background: white; border-bottom: 2px solid #1e3a8a; }
        
        /* Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø© */
        #libModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 15px; border-radius: 8px; width: 320px; border-top: 5px solid #1e3a8a; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); text-align: right; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø£ÙÙ‚ÙŠ Ø§Ù„Ù…ÙƒØ«Ù */
        .filter-row { display: flex; gap: 4px; background: #fff; padding: 8px; border: 1px solid #1e3a8a; margin-bottom: 5px; align-items: center; }
        .filter-item { flex: 1; min-width: 0; }
        .filter-box { width: 100%; height: 28px; border: 1px solid #cbd5e1; border-radius: 4px; padding: 0 8px; outline: none; font-size: 10px; text-align: right; }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-container { background: white; border: 1px solid #1e3a8a; border-radius: 4px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #334155; color: white; padding: 5px; border: 1px solid #1e293b; text-align: center; font-size: 10px; position: sticky; top: 0; z-index: 10; }
        td { padding: 4px; border: 1px solid #e2e8f0; text-align: center; color: #334155; white-space: nowrap; }
        tr:hover { background-color: #f1f5f9; }
        .status-badge { padding: 2px 6px; border-radius: 10px; font-weight: bold; font-size: 9px; }
    </style>
</head>
<body>

    <div id="libModal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="text-center mb-3">
                <div class="text-3xl mb-1">ğŸ›ï¸</div>
                <h2 id="mLibName" class="font-bold text-blue-900 text-sm"></h2>
                <p class="text-gray-500 text-[9px]">Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù‡Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</p>
            </div>
            <div class="space-y-1.5 text-[11px] border-t pt-3">
                <div class="flex justify-between border-b pb-1"><b>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</b> <span id="mCity" class="text-blue-700"></span></div>
                <div class="flex justify-between border-b pb-1"><b>Ø§Ù„ØªØ¨Ø¹ÙŠØ©:</b> <span id="mUni" class="text-blue-700"></span></div>
                <div class="flex justify-between border-b pb-1"><b>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</b> <span id="mManager" class="text-blue-700"></span></div>
                <div class="flex justify-between border-b pb-1"><b>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</b> <span id="mPhone" class="text-blue-700" dir="ltr"></span></div>
                <div class="flex justify-between border-b pb-1"><b>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„:</b> <span id="mHours" class="text-blue-700"></span></div>
                <div id="mMapRow" class="flex justify-between border-b pb-1 bg-green-50 p-1 rounded">
                    <b>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ:</b> 
                    <a id="mMap" href="#" target="_blank" class="text-green-700 font-bold underline">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
                </div>
            </div>
            <button onclick="document.getElementById('libModal').style.display='none'" class="w-full mt-4 bg-blue-900 text-white py-1.5 rounded text-[10px] font-bold">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <header class="header-bg p-2 flex justify-between items-center">
        <div class="text-[9px] text-gray-400 font-bold">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹Ø§Ù„ÙŠ ÙˆØ§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù„Ù…ÙŠ</div>
        <div class="flex items-center gap-3">
            <button onclick="window.location.href='join.html'" class="bg-green-600 text-white px-3 py-1 rounded text-[10px] font-bold hover:bg-green-700 transition-colors"> + Ø§Ù†Ø¶Ù…Ø§Ù… Ù…ÙƒØªØ¨Ø©</button>
            <h1 class="text-xl font-black text-blue-900">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ©</h1>
        </div>
    </header>

    <main class="p-1">
        <div class="filter-row">
            <div class="filter-item" style="flex: 2;"><input list="listSearch" id="fSearch" oninput="searchData()" placeholder="Ø¨Ø­Ø« Ø´Ø§Ù…Ù„ (Ø¹Ù†ÙˆØ§Ù†ØŒ Ø¨Ø§Ø­Ø«...)" class="filter-box"></div>
            <div class="filter-item"><input list="listUni" id="fUni" oninput="searchData()" placeholder="Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©" class="filter-box"></div>
            <div class="filter-item"><input list="listCol" id="fCol" oninput="searchData()" placeholder="Ø§Ù„ÙƒÙ„ÙŠØ©" class="filter-box"></div>
            <div class="filter-item"><input list="listDep" id="fDep" oninput="searchData()" placeholder="Ø§Ù„Ù‚Ø³Ù…" class="filter-box"></div>
            <div class="filter-item"><input list="listYear" id="fYear" oninput="searchData()" placeholder="Ø§Ù„Ø³Ù†Ø©" class="filter-box"></div>
            <div class="filter-item"><input list="listDeg" id="fDeg" oninput="searchData()" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø©" class="filter-box"></div>
            <div class="filter-item"><input list="listStatus" id="fStatus" oninput="searchData()" placeholder="Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©" class="filter-box"></div>
        </div>

        <datalist id="listSearch"></datalist><datalist id="listUni"></datalist><datalist id="listCol"></datalist>
        <datalist id="listDep"></datalist><datalist id="listYear"></datalist><datalist id="listDeg"></datalist>
        <datalist id="listStatus"><option value="Ù…ØªÙˆÙØ±Ø©"><option value="ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©"></datalist>

        <div class="table-container">
            <div class="overflow-y-auto" style="height: calc(100vh - 120px);">
                <table id="mainTable">
                    <thead>
                        <tr>
                            <th width="12%">Ø§Ù„Ø¨Ø§Ø­Ø«</th>
                            <th width="28%">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                            <th width="10%">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</th> <th width="10%">Ø§Ù„ÙƒÙ„ÙŠØ©</th>
                            <th width="10%">Ø§Ù„Ù‚Ø³Ù…</th>
                            <th width="5%">Ø§Ù„Ø³Ù†Ø©</th>
                            <th width="7%">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                            <th width="7%">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th width="10%">Ù…ÙƒØ§Ù† Ø§Ù„ØªÙˆØ§Ø¬Ø¯</th>
                            <th width="1%">ğŸ”—</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNITo9D9AXVyAjSjmu-DYotc",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "libyan-theses-portal",
            appId: "1:782635467382:web:48a60589a194519f964082"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allTheses = [];
        let allLibs = {};

        function fetchInitialData() {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
            db.ref('approved_libraries').once('value', snap => {
                allLibs = {};
                snap.forEach(child => {
                    const lib = child.val();
                    if(lib.libName) allLibs[lib.libName.trim()] = lib;
                });
                fetchTheses();
            });
        }

        function fetchTheses() {
            db.ref('Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„').on('value', snap => {
                allTheses = [];
                snap.forEach(child => { 
                    let item = child.val();
                    allTheses.push(item); 
                });
                renderTable(allTheses);
                updateDatalists();
            });
        }

        function showLibCard(name) {
            const cleanName = name ? name.trim() : "";
            const lib = allLibs[cleanName];
            if (lib) {
                document.getElementById('mLibName').innerText = lib.libName;
                document.getElementById('mCity').innerText = lib.city || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                document.getElementById('mUni').innerText = lib.affiliation || "-";
                document.getElementById('mManager').innerText = lib.manager || "-";
                document.getElementById('mPhone').innerText = lib.phone || "-";
                document.getElementById('mHours').innerText = lib.workHours || "-";
                
                const mapRow = document.getElementById('mMapRow');
                const mapLink = document.getElementById('mMap');
                if (lib.mapLocation && lib.mapLocation.startsWith('http')) {
                    mapLink.href = lib.mapLocation;
                    mapRow.style.display = 'flex';
                } else {
                    mapRow.style.display = 'none';
                }
                document.getElementById('libModal').style.display = 'flex';
            } else {
                alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø© (" + cleanName + ") Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="p-4 text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©..</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                const researcher = item.Ø§Ù„Ø¨Ø§Ø­Ø« || item.researcher || "-";
                const title = item.Ø§Ù„Ø¹Ù†ÙˆØ§Ù† || item.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
                const university = item.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© || item.university || "-"; // Ø¯Ø¹Ù… Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const college = item.Ø§Ù„ÙƒÙ„ÙŠØ© || item.college || "-";
                const department = item.Ø§Ù„Ù‚Ø³Ù… || item.department || "-";
                const year = item.Ø§Ù„Ø³Ù†Ø© || item.year || "-";
                const degree = item.Ø§Ù„Ø¯Ø±Ø¬Ø© || item.degree || "-";
                const status = item.Ø§Ù„Ø­Ø§Ù„Ø© || item.status || "-";
                const place = item.Ø§Ù„Ù…ÙƒØ§Ù† || item.location || "-";
                const url = item.Ø§Ù„Ø±Ø§Ø¨Ø· || item.link || "#";

                return `
                <tr>
                    <td>${researcher}</td>
                    <td class="font-bold text-blue-900 text-right pr-2">${title}</td>
                    <td>${university}</td>
                    <td>${college}</td>
                    <td>${department}</td>
                    <td>${year}</td>
                    <td>${degree}</td>
                    <td><span class="status-badge ${status === 'Ù…ØªÙˆÙØ±Ø©' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${status}</span></td>
                    <td class="cursor-pointer text-blue-600 font-bold hover:underline" onclick="showLibCard('${place}')">
                        ${place} â„¹ï¸
                    </td>
                    <td>${url !== "#" ? `<a href="${url}" target="_blank">ğŸŒ</a>` : '-'}</td>
                </tr>`;
            }).join('');
        }

        function searchData() {
            const s = document.getElementById('fSearch').value.toLowerCase();
            const u = document.getElementById('fUni').value;
            const c = document.getElementById('fCol').value;
            const p = document.getElementById('fDep').value;
            const y = document.getElementById('fYear').value;
            const d = document.getElementById('fDeg').value;
            const st = document.getElementById('fStatus').value;

            const filtered = allTheses.filter(t => {
                const searchStr = (t.Ø§Ù„Ø¹Ù†ÙˆØ§Ù† || "") + (t.Ø§Ù„Ø¨Ø§Ø­Ø« || "");
                return searchStr.toLowerCase().includes(s) &&
                       (!u || (t.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© || t.university) === u) &&
                       (!c || (t.Ø§Ù„ÙƒÙ„ÙŠØ© || t.college) === c) &&
                       (!p || (t.Ø§Ù„Ù‚Ø³Ù… || t.department) === p) &&
                       (!y || (t.Ø§Ù„Ø³Ù†Ø© || t.year) === y) &&
                       (!d || (t.Ø§Ù„Ø¯Ø±Ø¬Ø© || t.degree) === d) &&
                       (!st || (t.Ø§Ù„Ø­Ø§Ù„Ø© || t.status) === st);
            });
            renderTable(filtered);
        }

        function updateDatalists() {
            const fill = (id, prop) => {
                const list = document.getElementById(id);
                const unique = [...new Set(allTheses.map(t => t[prop]))].filter(Boolean).sort();
                list.innerHTML = unique.map(v => `<option value="${v}">`).join('');
            };
            fill('listUni', 'Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©'); fill('listCol', 'Ø§Ù„ÙƒÙ„ÙŠØ©'); fill('listDep', 'Ø§Ù„Ù‚Ø³Ù…');
            fill('listYear', 'Ø§Ù„Ø³Ù†Ø©'); fill('listDeg', 'Ø§Ù„Ø¯Ø±Ø¬Ø©');
        }

        window.onload = fetchInitialData;
    </script>
</body>
</html>

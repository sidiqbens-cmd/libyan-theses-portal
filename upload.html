<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ุงูููุฑุณ ุงูููุจู ุงูููุญุฏ | ุจูุงุจุฉ ุฑูุน ุงูููุชุจุงุช</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        body { background: #f1f5f9; font-family: 'Segoe UI', Tahoma, sans-serif; font-size: 11px; margin: 0; padding: 5px; overflow: hidden; }
        .dense-input { border: 1px solid #cbd5e1; padding: 2px 4px; border-radius: 2px; width: 100%; height: 24px; text-align: right; background: white; }
        .label-dense { width: 95px; text-align: right; color: #1e3a8a; font-weight: bold; font-size: 10px; }
        table { width: 100%; border-collapse: collapse; background: white; direction: rtl; table-layout: fixed; }
        th { background: #1e3a8a; color: white; padding: 6px; border: 1px solid #334155; position: sticky; top: 0; z-index: 20; font-size: 10px; }
        td { border: 1px solid #e2e8f0; padding: 3px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bg-portal { background-color: #1e3a8a; }
    </style>
</head>
<body>

    <div class="flex justify-between items-center mb-1 bg-white p-2 border rounded shadow-sm">
        <div class="flex gap-2">
            <button onclick="logout()" class="bg-red-600 text-white px-3 py-1 rounded font-bold text-[10px] hover:bg-red-700">ุฎุฑูุฌ</button>
            <label class="bg-green-700 text-white px-3 py-1 rounded font-bold text-[10px] cursor-pointer hover:bg-green-800">
                ุฑูุน ุฅูุณู ๐ <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls">
            </label>
            <button onclick="downloadFullTemplate()" class="bg-green-600 text-white px-3 py-1 rounded font-bold text-[10px] hover:bg-green-700">ุชุญููู ุงููุงูุจ</button>
        </div>
        <div class="flex flex-col items-end">
            <div class="text-blue-900 font-bold text-xs">ุงูููุฑุณ ุงูููุจู ุงูููุญุฏ | ุจูุงุจุฉ ุงูุฑูุน</div>
            <div id="libBadge" class="text-[9px] text-gray-500 font-bold italic">ุฌุงุฑู ุงูุชุญููู...</div>
        </div>
    </div>

    <div class="bg-white border p-3 mb-1 rounded shadow-sm">
        <form id="uploadForm">
            <input type="hidden" id="editKey">
            <div class="grid grid-cols-4 gap-x-4 gap-y-2">
                <div class="flex items-center"><span class="label-dense">ุงูุจุงุญุซ</span><input type="text" id="ุงูุจุงุญุซ" class="dense-input" required></div>
                <div class="flex items-center"><span class="label-dense">ุงูุนููุงู</span><input type="text" id="ุงูุนููุงู" class="dense-input" required></div>
                <div class="flex items-center"><span class="label-dense">ุงููุดุฑู</span><input type="text" id="ุงููุดุฑู" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">ุฑูู ุงูุฑุณุงูุฉ</span><input type="text" id="ุงูุฑูู" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">ุงูุฌุงูุนุฉ</span><input type="text" id="ุงูุฌุงูุนุฉ" class="dense-input bg-gray-50 text-blue-800 font-bold" readonly></div>
                <div class="flex items-center"><span class="label-dense">ุงููููุฉ</span><input type="text" id="ุงููููุฉ" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">ุงููุณู</span><input type="text" id="ุงููุณู" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">ุงูููุงู</span><input type="text" id="ุงูููุงู" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">ุงูุฏุฑุฌุฉ</span><select id="ุงูุฏุฑุฌุฉ" class="dense-input"><option>ูุงุฌุณุชูุฑ</option><option>ุฏูุชูุฑุงู</option></select></div>
                <div class="flex items-center"><span class="label-dense">ุงูุญุงูุฉ</span><select id="ุงูุญุงูุฉ" class="dense-input"><option>ูุชููุฑุฉ</option><option>ุบูุฑ ูุชููุฑุฉ</option></select></div>
                <div class="flex items-center"><span class="label-dense">ุงูุณูุฉ</span><input type="number" id="ุงูุณูุฉ" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">ุฑุงุจุท PDF</span><input type="url" id="ุงูุฑุงุจุท" class="dense-input" placeholder="http://..."></div>
            </div>
            <div class="grid grid-cols-4 gap-4 mt-2">
                <button type="submit" id="saveBtn" class="bg-blue-900 text-white py-1 rounded font-bold hover:bg-blue-800 transition-colors">ุงุนุชูุงุฏ ูุญูุธ ุงูุจูุงูุงุช โ</button>
                <div class="col-span-3"><input type="text" placeholder="ููุงุญุธุงุช ุฅุถุงููุฉ ููููุชุจุฉ..." id="ุงูููุงุญุธุงุช" class="dense-input"></div>
            </div>
        </form>
    </div>

    <div class="bg-white border rounded shadow-sm overflow-hidden" style="height: calc(100vh - 170px);">
        <div class="bg-blue-50 px-2 py-1 text-[10px] font-bold text-blue-800 border-b">ุงูุฑุณุงุฆู ุงูุชู ุชู ุฑูุนูุง ุนุจุฑ ูุฐู ุงูุจูุงุจุฉ:</div>
        <div class="overflow-y-auto h-full">
            <table>
                <thead>
                    <tr>
                        <th width="40px">#</th>
                        <th width="120px">ุงูุจุงุญุซ</th>
                        <th width="220px">ุงูุนููุงู</th>
                        <th width="100px">ุงููููุฉ / ุงููุณู</th>
                        <th width="50px">ุงูุณูุฉ</th>
                        <th width="60px">ุงูุฏุฑุฌุฉ</th>
                        <th width="40px">๐</th>
                        <th width="90px">ุงูุฅุฌุฑุงุก</th>
                    </tr>
                </thead>
                <tbody id="thesesTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ุชูููู Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNITo9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "libyan-theses-portal",
            storageBucket: "libyan-theses-portal.appspot.com",
            messagingSenderId: "782635467382",
            appId: "1:782635467382:web:48a60589a194519f964082"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ุฌูุจ ุจูุงูุงุช ุงูููุชุจุฉ ุงูุญุงููุฉ ูู Session
        const currentLib = JSON.parse(sessionStorage.getItem('authenticatedLib'));

        if (!currentLib) {
            alert("ุฌูุณุฉ ุงูุชูุชุ ูุฑุฌู ุงูุฏุฎูู ูุฌุฏุฏุงู");
            window.location.href = 'login.html';
        }

        // ุฅุนุฏุงุฏ ุงููุงุฌูุฉ ุนูุฏ ุงููุชุญ
        document.getElementById('libBadge').innerText = "ุจูุงุจุฉ: " + currentLib.libName;
        document.getElementById('ุงูุฌุงูุนุฉ').value = currentLib.libName;

        // ุชุญููู ุงูุจูุงูุงุช ุงูุฎุงุตุฉ ุจูุฐู ุงูููุชุจุฉ ููุท
        function loadData() {
            db.ref('ุจูุงูุงุช_ุงูุฑุณุงุฆู').orderByChild('id_ุงูููุชุจุฉ').equalTo(currentLib.id).on('value', snap => {
                const tbody = document.getElementById('thesesTable');
                tbody.innerHTML = "";
                let count = 1;
                snap.forEach(child => {
                    const d = child.val();
                    tbody.innerHTML += `<tr class="hover:bg-blue-50">
                        <td>${count++}</td>
                        <td class="text-right px-2">${d.ุงูุจุงุญุซ}</td>
                        <td class="text-right font-bold px-2 text-blue-900">${d.ุงูุนููุงู}</td>
                        <td class="text-[9px] text-gray-600">${d.ุงููููุฉ} - ${d.ุงููุณู}</td>
                        <td>${d.ุงูุณูุฉ}</td>
                        <td>${d.ุงูุฏุฑุฌุฉ}</td>
                        <td>${d.ุงูุฑุงุจุท && d.ุงูุฑุงุจุท !== '#' ? `<a href="${d.ุงูุฑุงุจุท}" target="_blank" title="ุชุญููู">๐ฅ</a>` : '-'}</td>
                        <td class="flex justify-center gap-1 py-1">
                            <button onclick="editItem('${child.key}')" class="bg-yellow-500 text-white px-2 rounded text-[9px] hover:bg-yellow-600">ุชุนุฏูู</button>
                            <button onclick="deleteItem('${child.key}')" class="bg-red-600 text-white px-2 rounded text-[9px] hover:bg-red-700">ุญุฐู</button>
                        </td>
                    </tr>`;
                });
            });
        }

        // ุญูุธ ุงูุจูุงูุงุช
        document.getElementById('uploadForm').onsubmit = function(e) {
            e.preventDefault();
            const key = document.getElementById('editKey').value;
            const data = {
                ุงูุจุงุญุซ: document.getElementById('ุงูุจุงุญุซ').value,
                ุงูุนููุงู: document.getElementById('ุงูุนููุงู').value,
                ุงููุดุฑู: document.getElementById('ุงููุดุฑู').value,
                ุงูุฑูู: document.getElementById('ุงูุฑูู').value,
                ุงูุฌุงูุนุฉ: document.getElementById('ุงูุฌุงูุนุฉ').value,
                ุงููููุฉ: document.getElementById('ุงููููุฉ').value,
                ุงููุณู: document.getElementById('ุงููุณู').value,
                ุงูููุงู: document.getElementById('ุงูููุงู').value,
                ุงูุฏุฑุฌุฉ: document.getElementById('ุงูุฏุฑุฌุฉ').value,
                ุงูุญุงูุฉ: document.getElementById('ุงูุญุงูุฉ').value,
                ุงูุณูุฉ: document.getElementById('ุงูุณูุฉ').value,
                ุงูุฑุงุจุท: document.getElementById('ุงูุฑุงุจุท').value || "#",
                ุงูููุงุญุธุงุช: document.getElementById('ุงูููุงุญุธุงุช').value,
                id_ุงูููุชุจุฉ: currentLib.id,
                ุชุงุฑูุฎ_ุงูุฑูุน: new Date().toISOString()
            };

            if (key) {
                db.ref('ุจูุงูุงุช_ุงูุฑุณุงุฆู/' + key).update(data).then(() => {
                    alert("โ ุชู ุงูุชุนุฏูู ุจูุฌุงุญ");
                    document.getElementById('editKey').value = "";
                });
            } else {
                db.ref('ุจูุงูุงุช_ุงูุฑุณุงุฆู').push(data).then(() => {
                    alert("โ ุชู ุงูุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช");
                });
            }
            this.reset();
            document.getElementById('ุงูุฌุงูุนุฉ').value = currentLib.libName; // ุฅุนุงุฏุฉ ููุก ุงุณู ุงูุฌุงูุนุฉ
        };

        // ุชุญููู ูุงูุจ ุงูุฅูุณู
        window.downloadFullTemplate = function() {
            const cols = ["ุงูุจุงุญุซ", "ุงูุนููุงู", "ุงููุดุฑู", "ุฑูู ุงูุฑุณุงูุฉ", "ุงููููุฉ", "ุงููุณู", "ุงูููุงู", "ุงูุฏุฑุฌุฉ", "ุงูุญุงูุฉ", "ุงูุณูุฉ", "ุฑุงุจุท PDF", "ุงูููุงุญุธุงุช"];
            const ws = XLSX.utils.json_to_sheet([Object.fromEntries(cols.map(c => [c, ""]))]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ุจูุงูุงุช ุงูุฑุณุงุฆู");
            XLSX.writeFile(wb, "LUC_Template.xlsx");
        };

        // ุฑูุน ููู ุงูุฅูุณู
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const workbook = XLSX.read(evt.target.result, {type: 'binary'});
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                let successCount = 0;
                data.forEach(item => {
                    db.ref('ุจูุงูุงุช_ุงูุฑุณุงุฆู').push({
                        ุงูุจุงุญุซ: item["ุงูุจุงุญุซ"] || "-",
                        ุงูุนููุงู: item["ุงูุนููุงู"] || "-",
                        ุงููุดุฑู: item["ุงููุดุฑู"] || "-",
                        ุงูุฑูู: item["ุฑูู ุงูุฑุณุงูุฉ"] || "-",
                        ุงูุฌุงูุนุฉ: currentLib.libName,
                        ุงููููุฉ: item["ุงููููุฉ"] || "-",
                        ุงููุณู: item["ุงููุณู"] || "-",
                        ุงูููุงู: item["ุงูููุงู"] || "-",
                        ุงูุฏุฑุฌุฉ: item["ุงูุฏุฑุฌุฉ"] || "ูุงุฌุณุชูุฑ",
                        ุงูุญุงูุฉ: item["ุงูุญุงูุฉ"] || "ูุชููุฑุฉ",
                        ุงูุณูุฉ: item["ุงูุณูุฉ"] || "-",
                        ุงูุฑุงุจุท: item["ุฑุงุจุท PDF"] || "#",
                        ุงูููุงุญุธุงุช: item["ุงูููุงุญุธุงุช"] || "",
                        id_ุงูููุชุจุฉ: currentLib.id,
                        ุชุงุฑูุฎ_ุงูุฑูุน: new Date().toISOString()
                    });
                    successCount++;
                });
                alert(`โ ุชูุช ุงููุนุงูุฌุฉ! ุชู ุฑูุน ${successCount} ุฑุณุงูุฉ ุจูุฌุงุญ.`);
            };
            reader.readAsBinaryString(e.target.files[0]);
        });

        // ุชุนุฏูู ูุญุฐู
        window.editItem = function(key) {
            db.ref('ุจูุงูุงุช_ุงูุฑุณุงุฆู/' + key).once('value').then(s => {
                const d = s.val();
                document.getElementById('editKey').value = key;
                document.getElementById('ุงูุจุงุญุซ').value = d.ุงูุจุงุญุซ || "";
                document.getElementById('ุงูุนููุงู').value = d.ุงูุนููุงู || "";
                document.getElementById('ุงููุดุฑู').value = d.ุงููุดุฑู || "";
                document.getElementById('ุงูุฑูู').value = d.ุงูุฑูู || "";
                document.getElementById('ุงููููุฉ').value = d.ุงููููุฉ || "";
                document.getElementById('ุงููุณู').value = d.ุงููุณู || "";
                document.getElementById('ุงูููุงู').value = d.ุงูููุงู || "";
                document.getElementById('ุงูุฏุฑุฌุฉ').value = d.ุงูุฏุฑุฌุฉ || "ูุงุฌุณุชูุฑ";
                document.getElementById('ุงูุญุงูุฉ').value = d.ุงูุญุงูุฉ || "ูุชููุฑุฉ";
                document.getElementById('ุงูุณูุฉ').value = d.ุงูุณูุฉ || "";
                document.getElementById('ุงูุฑุงุจุท').value = d.ุงูุฑุงุจุท || "";
                document.getElementById('ุงูููุงุญุธุงุช').value = d.ุงูููุงุญุธุงุช || "";
                document.getElementById('saveBtn').innerText = "ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญุฏุฏุฉ ๐";
            });
        };

        window.deleteItem = function(key) {
            if(confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงูุฑุณุงูุฉ ููุงุฆูุงูุ")) {
                db.ref('ุจูุงูุงุช_ุงูุฑุณุงุฆู/' + key).remove();
            }
        };

        function logout() { sessionStorage.clear(); window.location.href = 'lib-dashboard.html'; }
        
        loadData();
    </script>
</body>
</html>

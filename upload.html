<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ | Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        body { background: #f1f5f9; font-family: 'Segoe UI', sans-serif; font-size: 11px; margin: 0; padding: 5px; overflow: hidden; }
        .dense-input { border: 1px solid #cbd5e1; padding: 2px 4px; border-radius: 2px; width: 100%; height: 24px; text-align: right; background: white; }
        .label-dense { width: 95px; text-align: right; color: #1e3a8a; font-weight: bold; font-size: 10px; }
        .filter-select { background: #fff; border: 1px solid #94a3b8; padding: 1px 4px; border-radius: 4px; font-size: 10px; height: 24px; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; background: white; table-layout: fixed; }
        th { background: #1e3a8a; color: white; padding: 6px; border: 1px solid #334155; position: sticky; top: 0; z-index: 20; }
        td { border: 1px solid #e2e8f0; padding: 3px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        #libModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 350px; border-top: 5px solid #1e3a8a; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body>

    <div id="libModal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="text-center mb-4">
                <span class="text-4xl">ğŸ›ï¸</span>
                <h2 id="mLibName" class="font-bold text-blue-900 text-lg mt-2"></h2>
                <p class="text-gray-500 text-[10px]">Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</p>
            </div>
            <div class="space-y-2 border-t pt-3 text-[12px]">
                <div class="flex justify-between"><b>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</b> <span id="mCity"></span></div>
                <div class="flex justify-between"><b>Ø§Ù„ØªØ¨Ø¹ÙŠØ©:</b> <span id="mUni"></span></div>
                <div class="flex justify-between"><b>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</b> <span id="mManager"></span></div>
                <div class="flex justify-between"><b>Ø§Ù„Ø§ØªØµØ§Ù„:</b> <span id="mPhone"></span></div>
            </div>
            <button onclick="document.getElementById('libModal').style.display='none'" class="w-full mt-4 bg-gray-200 py-2 rounded font-bold">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="flex justify-between items-center mb-1 bg-white p-2 border rounded shadow-sm">
        <div class="flex gap-2">
            <button onclick="logout()" class="bg-red-600 text-white px-3 py-1 rounded font-bold text-[10px]">Ø®Ø±ÙˆØ¬</button>
            <label class="bg-green-700 text-white px-3 py-1 rounded font-bold text-[10px] cursor-pointer">Ø±ÙØ¹ Ø¥ÙƒØ³Ù„ ğŸ“ <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls"></label>
            <button onclick="downloadFullTemplate()" class="bg-green-600 text-white px-3 py-1 rounded font-bold text-[10px]">Ø§Ù„Ù‚Ø§Ù„Ø¨</button>
        </div>
        
        <div class="flex gap-1 items-center bg-blue-50 p-1 rounded border flex-grow mx-4">
            <input type="text" id="fSearch" onkeyup="applyFilters()" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." class="filter-select w-32">
            <select id="fUni" onchange="applyFilters()" class="filter-select"><option value="">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</option></select>
            <select id="fCol" onchange="applyFilters()" class="filter-select"><option value="">Ø§Ù„ÙƒÙ„ÙŠØ©</option></select>
            <select id="fDep" onchange="applyFilters()" class="filter-select"><option value="">Ø§Ù„Ù‚Ø³Ù…</option></select>
            <select id="fYear" onchange="applyFilters()" class="filter-select w-16"><option value="">Ø³Ù†Ø©</option></select>
        </div>

        <div class="text-right">
            <div id="libNameDisplay" class="text-blue-900 font-bold text-[10px]">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <div class="bg-white border p-3 mb-1 rounded shadow-sm">
        <form id="uploadForm">
            <input type="hidden" id="editKey">
            <div class="grid grid-cols-4 gap-x-4 gap-y-1">
                <div class="flex items-center"><span class="label-dense">Ø§Ù„Ø¨Ø§Ø­Ø«</span><input type="text" id="Ø§Ù„Ø¨Ø§Ø­Ø«" class="dense-input" required></div>
                <div class="flex items-center"><span class="label-dense">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span><input type="text" id="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" class="dense-input" required></div>
                <div class="flex items-center"><span class="label-dense">Ø§Ù„Ù…Ø´Ø±Ù</span><input type="text" id="Ø§Ù„Ù…Ø´Ø±Ù" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">Ø±Ù‚Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span><input type="text" id="Ø§Ù„Ø±Ù‚Ù…" class="dense-input"></div>
                
                <div class="flex items-center"><span class="label-dense">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</span><input type="text" id="Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">Ø§Ù„ÙƒÙ„ÙŠØ©</span><input type="text" id="Ø§Ù„ÙƒÙ„ÙŠØ©" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">Ø§Ù„Ù‚Ø³Ù…</span><input type="text" id="Ø§Ù„Ù‚Ø³Ù…" class="dense-input"></div>
                
                <div class="flex items-center gap-1">
                    <span class="label-dense text-blue-700 underline cursor-help" title="Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø©" onclick="showLibDetails()">Ø§Ù„Ù…ÙƒØ§Ù† ğŸ›ï¸</span>
                    <input type="text" id="Ø§Ù„Ù…ÙƒØ§Ù†" class="dense-input bg-blue-50 cursor-pointer text-blue-800 font-bold" readonly onclick="showLibDetails()">
                </div>
                
                <div class="flex items-center"><span class="label-dense">Ø§Ù„Ø¯Ø±Ø¬Ø©</span><select id="Ø§Ù„Ø¯Ø±Ø¬Ø©" class="dense-input"><option>Ù…Ø§Ø¬Ø³ØªÙŠØ±</option><option>Ø¯ÙƒØªÙˆØ±Ø§Ù‡</option></select></div>
                <div class="flex items-center"><span class="label-dense">Ø§Ù„Ø­Ø§Ù„Ø©</span><select id="Ø§Ù„Ø­Ø§Ù„Ø©" class="dense-input"><option>Ù…ØªÙˆÙØ±Ø©</option><option>ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</option></select></div>
                <div class="flex items-center"><span class="label-dense">Ø§Ù„Ø³Ù†Ø©</span><input type="number" id="Ø§Ù„Ø³Ù†Ø©" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">Ø±Ø§Ø¨Ø· PDF</span><input type="url" id="Ø§Ù„Ø±Ø§Ø¨Ø·" class="dense-input" placeholder="http://..."></div>
            </div>
            <div class="flex gap-2 mt-2">
                <button type="submit" id="saveBtn" class="bg-blue-900 text-white px-8 py-1 rounded font-bold text-[10px]">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…</button>
                <input type="text" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..." id="Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª" class="dense-input">
            </div>
        </form>
    </div>

    <div class="bg-white border rounded shadow-sm overflow-hidden" style="height: calc(100vh - 175px);">
        <div class="overflow-y-auto h-full text-[10px]">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th width="100px">Ø§Ù„Ø¨Ø§Ø­Ø«</th><th width="200px">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                        <th width="80px">Ø§Ù„ÙƒÙ„ÙŠØ©</th><th width="120px">Ø§Ù„Ù…ÙƒØ§Ù†</th>
                        <th width="40px">Ø§Ù„Ø³Ù†Ø©</th><th width="50px">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                        <th width="30px">ğŸ”—</th><th width="90px">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody id="thesesTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNITo9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "libyan-theses-portal",
            storageBucket: "libyan-theses-portal.appspot.com",
            messagingSenderId: "782635467382",
            appId: "1:782635467382:web:48a60589a194519f964082"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
        const currentLib = JSON.parse(sessionStorage.getItem('authenticatedLib'));
        if(!currentLib) window.location.href = 'lib-dashboard.html';

        document.getElementById('libNameDisplay').innerText = currentLib.libName;
        document.getElementById('Ø§Ù„Ù…ÙƒØ§Ù†').value = currentLib.libName;

        let allData = [];

        function loadData() {
            db.ref('Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„').orderByChild('id_Ø§Ù„Ù…ÙƒØªØ¨Ø©').equalTo(currentLib.id).on('value', snap => {
                allData = [];
                snap.forEach(child => { allData.push({key: child.key, ...child.val()}); });
                updateFilterOptions();
                applyFilters();
            });
        }

        function showLibDetails() {
            document.getElementById('mLibName').innerText = currentLib.libName;
            document.getElementById('mCity').innerText = currentLib.city || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            document.getElementById('mUni').innerText = currentLib.university || "ØªØ¨Ø¹ÙŠØ© Ø¹Ø§Ù…Ø©";
            document.getElementById('mManager').innerText = currentLib.manager || "ØºÙŠØ± Ù…Ø³Ø¬Ù„";
            document.getElementById('mPhone').innerText = currentLib.phone || "-";
            document.getElementById('libModal').style.display = 'flex';
        }

        function applyFilters() {
            const s = document.getElementById('fSearch').value.toLowerCase();
            const uni = document.getElementById('fUni').value;
            const col = document.getElementById('fCol').value;
            const filtered = allData.filter(d => {
                return (d.Ø§Ù„Ø¨Ø§Ø­Ø«+d.Ø§Ù„Ø¹Ù†ÙˆØ§Ù†).toLowerCase().includes(s) &&
                       (!uni || d.Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© == uni) && (!col || d.Ø§Ù„ÙƒÙ„ÙŠØ© == col);
            });

            const tbody = document.getElementById('thesesTable');
            tbody.innerHTML = filtered.map(d => `
                <tr>
                    <td>${d.Ø§Ù„Ø¨Ø§Ø­Ø«}</td><td class="font-bold text-blue-900">${d.Ø§Ù„Ø¹Ù†ÙˆØ§Ù†}</td>
                    <td>${d.Ø§Ù„ÙƒÙ„ÙŠØ©}</td>
                    <td class="cursor-pointer text-blue-700 hover:underline font-bold" onclick="showLibDetails()">${d.Ø§Ù„Ù…ÙƒØ§Ù†} â„¹ï¸</td>
                    <td>${d.Ø§Ù„Ø³Ù†Ø©}</td><td>${d.Ø§Ù„Ø¯Ø±Ø¬Ø©}</td>
                    <td>${d.Ø§Ù„Ø±Ø§Ø¨Ø· && d.Ø§Ù„Ø±Ø§Ø¨Ø· !== '#' ? `<a href="${d.Ø§Ù„Ø±Ø§Ø¨Ø·}" target="_blank" title="ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ">ğŸŒ</a>` : '-'}</td>
                    <td class="flex justify-center gap-1 py-1">
                        <button onclick="editItem('${d.key}')" class="bg-yellow-500 text-white px-2 rounded text-[9px]">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button onclick="deleteItem('${d.key}')" class="bg-red-600 text-white px-2 rounded text-[9px]">Ø­Ø°Ù</button>
                    </td>
                </tr>`).join('');
        }

        // Ø§Ù„Ø­ÙØ¸ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
        document.getElementById('uploadForm').onsubmit = function(e) {
            e.preventDefault();
            const key = document.getElementById('editKey').value;
            const linkVal = document.getElementById('Ø§Ù„Ø±Ø§Ø¨Ø·').value;
            
            const data = {
                Ø§Ù„Ø¨Ø§Ø­Ø«: document.getElementById('Ø§Ù„Ø¨Ø§Ø­Ø«').value, Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: document.getElementById('Ø§Ù„Ø¹Ù†ÙˆØ§Ù†').value,
                Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©: document.getElementById('Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©').value, Ø§Ù„ÙƒÙ„ÙŠØ©: document.getElementById('Ø§Ù„ÙƒÙ„ÙŠØ©').value,
                Ø§Ù„Ù‚Ø³Ù…: document.getElementById('Ø§Ù„Ù‚Ø³Ù…').value, Ø§Ù„Ù…ÙƒØ§Ù†: currentLib.libName,
                Ø§Ù„Ø¯Ø±Ø¬Ø©: document.getElementById('Ø§Ù„Ø¯Ø±Ø¬Ø©').value, Ø§Ù„Ø³Ù†Ø©: document.getElementById('Ø§Ù„Ø³Ù†Ø©').value,
                Ø§Ù„Ø±Ø§Ø¨Ø·: linkVal ? linkVal : "#", // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· ÙØ§Ø±ØºØ§Ù‹ Ø£Ùˆ Ø¨Ù…Ø±Ø¬Ø¹ Ø¯Ø§Ø®Ù„ÙŠ
                id_Ø§Ù„Ù…ÙƒØªØ¨Ø©: currentLib.id
            };
            if(key) db.ref('Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„/'+key).update(data); else db.ref('Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„').push(data);
            this.reset();
            document.getElementById('Ø§Ù„Ù…ÙƒØ§Ù†').value = currentLib.libName;
            document.getElementById('editKey').value = "";
        };

        function logout() { sessionStorage.clear(); window.location.href = 'lib-dashboard.html'; }
        loadData();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>بوابة رفع الرسائل | بوابة الرسائل الجامعية الليبية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #f1f5f9; font-family: sans-serif; font-size: 11px; overflow: hidden; margin: 0; padding: 10px; }
        .dense-card { background: white; padding: 12px; border: 1px solid #cbd5e1; border-radius: 4px; margin-bottom: 8px; }
        input, select { border: 1px solid #94a3b8; padding: 3px 6px; border-radius: 3px; width: 100%; outline: none; font-size: 11px; }
        input:focus { border-color: #1e3a8a; }
        label { font-weight: bold; color: #1e3a8a; display: block; margin-bottom: 1px; }
        .grid-layout { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #1e3a8a; color: white; padding: 5px; position: sticky; top: 0; font-weight: normal; }
        td { border: 1px solid #e2e8f0; padding: 4px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-action { padding: 4px 10px; border-radius: 3px; font-weight: bold; transition: 0.2s; }
    </style>
</head>
<body>

    <div class="dense-card flex justify-between items-center bg-blue-50">
        <div class="flex gap-2">
            <button class="bg-red-600 text-white btn-action hover:bg-red-700" onclick="logout()">تسجيل الخروج</button>
            <button class="bg-blue-600 text-white btn-action hover:bg-blue-700">رفع ملف Excel</button>
            <button class="bg-green-700 text-white btn-action hover:bg-green-800">تحميل قالب Excel</button>
        </div>
        <h2 class="text-blue-900 font-bold text-sm">بوابة رفع الرسائل الجامعية الليبية</h2>
    </div>

    <div class="dense-card">
        <form id="uploadForm">
            <div class="grid-layout">
                <div><label>اسم الباحث</label><input type="text" id="author" required></div>
                <div><label>عنوان الرسالة</label><input type="text" id="title" required></div>
                <div><label>الجامعة</label><input type="text" id="university" required></div>
                <div><label>الكلية</label><input type="text" id="college" required></div>
                <div><label>القسم</label><input type="text" id="dept" required></div>
                <div><label>الدرجة العلمية</label>
                    <select id="degree">
                        <option>ماجستير</option>
                        <option>دكتوراه</option>
                    </select>
                </div>
                <div><label>سنة المناقشة</label><input type="number" id="year" required></div>
                <div><label>اسم المشرف</label><input type="text" id="supervisor" required></div>
                <div class="col-span-3"><label>رابط ملف الرسالة (PDF/Drive)</label><input type="url" id="link" placeholder="https://..." required></div>
                <div class="flex items-end">
                    <button type="submit" id="saveBtn" class="w-full bg-blue-900 text-white py-1 rounded font-bold hover:bg-black transition-colors">اعتماد وحفظ البيانات</button>
                </div>
            </div>
        </form>
    </div>

    <div class="dense-card p-0 overflow-hidden" style="max-height: calc(100vh - 200px);">
        <div class="overflow-y-auto" style="max-height: calc(100vh - 210px);">
            <table>
                <thead>
                    <tr>
                        <th width="5%">إجراء</th>
                        <th>الباحث</th>
                        <th>العنوان</th>
                        <th>الدرجة</th>
                        <th>الكلية</th>
                        <th>السنة</th>
                        <th>الرابط</th>
                    </tr>
                </thead>
                <tbody id="thesesTable">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNITo9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "libyan-theses-portal",
            storageBucket: "libyan-theses-portal.appspot.com",
            messagingSenderId: "782635467382",
            appId: "1:782635467382:web:48a60589a194519f964082"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // جلب البيانات فوراً
        function loadTheses() {
            db.ref('theses').on('value', snap => {
                const tbody = document.getElementById('thesesTable');
                tbody.innerHTML = "";
                snap.forEach(child => {
                    const d = child.val();
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td><button onclick="deleteItem('${child.key}')" class="text-red-600 font-bold hover:scale-125 transition-transform">X</button></td>
                            <td>${d.author}</td>
                            <td class="text-right px-2">${d.title}</td>
                            <td>${d.degree}</td>
                            <td>${d.college}</td>
                            <td>${d.year}</td>
                            <td><a href="${d.link}" target="_blank" class="text-blue-700 underline font-bold">فتح</a></td>
                        </tr>`;
                });
            });
        }

        // حفظ البيانات
        document.getElementById('uploadForm').onsubmit = function(e) {
            e.preventDefault();
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerText = "جاري الحفظ...";

            const data = {
                author: document.getElementById('author').value,
                title: document.getElementById('title').value,
                university: document.getElementById('university').value,
                college: document.getElementById('college').value,
                dept: document.getElementById('dept').value,
                degree: document.getElementById('degree').value,
                year: document.getElementById('year').value,
                supervisor: document.getElementById('supervisor').value,
                link: document.getElementById('link').value,
                timestamp: Date.now()
            };

            db.ref('theses').push(data).then(() => {
                document.getElementById('uploadForm').reset();
                btn.disabled = false;
                btn.innerText = "اعتماد وحفظ البيانات";
            }).catch(err => {
                alert("خطأ: " + err.message);
                btn.disabled = false;
            });
        };

        function deleteItem(id) {
            if(confirm("هل أنت متأكد من حذف هذه الرسالة؟")) db.ref('theses').child(id).remove();
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        window.onload = loadTheses;
    </script>
</body>
</html>

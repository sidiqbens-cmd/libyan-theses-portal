<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ | Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±ÙØ¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        body { background: #f1f5f9; font-family: 'Segoe UI', Tahoma, sans-serif; font-size: 10px; margin: 0; padding: 5px; overflow: hidden; }
        .dense-input { border: 1px solid #cbd5e1; padding: 2px 4px; border-radius: 2px; width: 100%; outline: none; height: 22px; }
        .label-dense { display: inline-block; width: 85px; text-align: right; color: #475569; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: white; table-layout: fixed; }
        th { background: #1e3a8a; color: white; padding: 4px; font-weight: bold; border: 1px solid #334155; position: sticky; top: 0; z-index: 20; }
        td { border: 1px solid #e2e8f0; padding: 2px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .btn-header { font-size: 9px; padding: 2px 8px; border-radius: 2px; color: white; font-weight: bold; cursor: pointer; }
        .hint-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 5px; border-radius: 3px; font-size: 9px; margin-bottom: 5px; display: none; }
    </style>
</head>
<body>

    <div class="flex justify-between items-center mb-1 border-b pb-1 bg-white p-1 rounded shadow-sm">
        <div class="flex items-center gap-2">
            <button onclick="logout()" class="btn-header bg-red-600 hover:bg-red-700">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            <label class="btn-header bg-green-700 hover:bg-green-800" onmouseover="showHint('Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ù„Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø¨Ø¹Ø¯ ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯')">Ø±ÙØ¹ Ù…Ù„Ù Excel <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls"></label>
            <button onclick="downloadFullTemplate()" class="btn-header bg-green-600 hover:bg-green-700" onmouseover="showHint('Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø¹Ø¨Ø¦Ù‡ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø«Ù… Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø±ÙØ¹')">ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Excel</button>
        </div>
        <div class="text-blue-900 font-bold text-xs italic">Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ | Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</div>
    </div>

    <div id="libraryHint" class="hint-box text-blue-900 font-bold">ğŸ’¡ ØªÙ„Ù…ÙŠØ­ Ù„Ù„Ù…ÙƒØªØ¨Ø©: <span id="hintText">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙØ¹.</span></div>

    <div class="bg-white border p-2 mb-1 shadow-sm rounded">
        <form id="uploadForm">
            <input type="hidden" id="editKey">
            <div class="grid grid-cols-4 gap-x-4 gap-y-1">
                <div class="flex items-center"><span class="label-dense">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø­Ø«</span><input type="text" id="author" class="dense-input" required></div>
                <div class="flex items-center"><span class="label-dense">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span><input type="text" id="title" class="dense-input" required></div>
                <div class="flex items-center"><span class="label-dense">Ø§Ù„Ù…Ø´Ø±Ù</span><input type="text" id="supervisor" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">Ø±Ù‚Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span><input type="text" id="id_num" class="dense-input"></div>
                
                <div class="flex items-center"><span class="label-dense">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</span><input type="text" id="university" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">Ø§Ù„ÙƒÙ„ÙŠØ©</span><input type="text" id="college" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">Ø§Ù„Ù‚Ø³Ù…</span><input type="text" id="dept" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">Ù…ÙƒØ§Ù† Ø§Ù„ØªÙˆØ§Ø¬Ø¯</span><input type="text" id="location" class="dense-input"></div>

                <div class="flex items-center"><span class="label-dense">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</span>
                    <select id="degree" class="dense-input"><option>Ù…Ø§Ø¬Ø³ØªÙŠØ±</option><option>Ø¯ÙƒØªÙˆØ±Ø§Ù‡</option></select>
                </div>
                <div class="flex items-center"><span class="label-dense">Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span>
                    <select id="status" class="dense-input"><option>Ù…ØªÙˆÙØ±Ø©</option><option>ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</option></select>
                </div>
                <div class="flex items-center"><span class="label-dense">Ø³Ù†Ø© Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø©</span><input type="number" id="year" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù</span><input type="url" id="link" class="dense-input" placeholder="Ø±Ø§Ø¨Ø· PDF Ø§Ù„Ù…Ø¨Ø§Ø´Ø±"></div>
            </div>
            
            <div class="grid grid-cols-4 gap-4 mt-1">
                <button type="submit" id="saveBtn" class="bg-blue-900 text-white py-1 rounded font-bold hover:bg-black transition-all">Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…</button>
                <div class="col-span-3"><input type="text" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" id="notes" class="dense-input"></div>
            </div>
        </form>
    </div>

    <div class="bg-white border shadow-sm overflow-hidden rounded" style="height: calc(100vh - 165px);">
        <div class="overflow-y-auto h-full">
            <table>
                <thead>
                    <tr>
                        <th width="80px">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th><th width="40px">Ø§Ù„Ø±Ø§Ø¨Ø·</th><th width="80px">Ø§Ù„Ù…ÙƒØ§Ù†</th><th width="70px">Ø±Ù‚Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
                        <th width="60px">Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th width="50px">Ø§Ù„Ø³Ù†Ø©</th><th width="80px">Ø§Ù„Ù‚Ø³Ù…</th><th width="100px">Ø§Ù„ÙƒÙ„ÙŠØ©</th>
                        <th width="100px">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</th><th width="100px">Ø§Ù„Ù…Ø´Ø±Ù</th><th width="200px">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th width="120px">Ø§Ù„Ø¨Ø§Ø­Ø«</th>
                    </tr>
                </thead>
                <tbody id="thesesTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNITo9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "libyan-theses-portal",
            storageBucket: "libyan-theses-portal.appspot.com",
            messagingSenderId: "782635467382",
            appId: "1:782635467382:web:48a60589a194519f964082"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function showHint(text) {
            const box = document.getElementById('libraryHint');
            const hint = document.getElementById('hintText');
            box.style.display = 'block';
            hint.innerText = text;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø´Ø§Ù…Ù„ (RTL ÙˆÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„)
        window.downloadFullTemplate = function() {
            const data = [{
                "Ø§Ù„Ø¨Ø§Ø­Ø«": "Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø­Ø«", "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†": "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©", "Ø§Ù„Ù…Ø´Ø±Ù": "Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù", "Ø±Ù‚Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©": "123",
                "Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©": "Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©", "Ø§Ù„ÙƒÙ„ÙŠØ©": "Ø§Ù„ÙƒÙ„ÙŠØ©", "Ø§Ù„Ù‚Ø³Ù…": "Ø§Ù„Ù‚Ø³Ù…", "Ø§Ù„Ø¯Ø±Ø¬Ø©": "Ù…Ø§Ø¬Ø³ØªÙŠØ±", "Ø§Ù„Ø³Ù†Ø©": 2024,
                "Ø±Ø§Ø¨Ø· PDF": "http://...", "Ø§Ù„Ù…ÙƒØ§Ù†": "Ù…ÙƒØªØ¨Ø© Ø·Ø±Ø§Ø¨Ù„Ø³", "Ø§Ù„Ø­Ø§Ù„Ø©": "Ù…ØªÙˆÙØ±Ø©", "Ù…Ù„Ø§Ø­Ø¸Ø§Øª": "..."
            }];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            XLSX.writeFile(wb, "Ø§Ù„ÙÙ‡Ø±Ø³_Ø§Ù„Ù„ÙŠØ¨ÙŠ_Ø§Ù„Ù…ÙˆØ­Ø¯_Ù‚Ø§Ù„Ø¨_ÙƒØ§Ù…Ù„.xlsx");
        };

        // Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const workbook = XLSX.read(evt.target.result, {type: 'binary'});
                const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                rawData.forEach(item => {
                    db.ref('theses').push({
                        author: item["Ø§Ù„Ø¨Ø§Ø­Ø«"], title: item["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"], supervisor: item["Ø§Ù„Ù…Ø´Ø±Ù"], id_num: item["Ø±Ù‚Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©"],
                        university: item["Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©"], college: item["Ø§Ù„ÙƒÙ„ÙŠØ©"], dept: item["Ø§Ù„Ù‚Ø³Ù…"], degree: item["Ø§Ù„Ø¯Ø±Ø¬Ø©"],
                        year: item["Ø§Ù„Ø³Ù†Ø©"], link: item["Ø±Ø§Ø¨Ø· PDF"], location: item["Ø§Ù„Ù…ÙƒØ§Ù†"], status: item["Ø§Ù„Ø­Ø§Ù„Ø©"], notes: item["Ù…Ù„Ø§Ø­Ø¸Ø§Øª"]
                    });
                });
                alert("ØªÙ… Ø±ÙØ¹ " + rawData.length + " Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
            };
            reader.readAsBinaryString(e.target.files[0]);
        });

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ (RTL)
        function loadData() {
            db.ref('theses').on('value', snap => {
                const tbody = document.getElementById('thesesTable');
                tbody.innerHTML = "";
                snap.forEach(child => {
                    const d = child.val();
                    tbody.innerHTML += `<tr class="hover:bg-blue-50">
                        <td class="flex justify-center gap-1 py-1">
                            <button onclick="editItem('${child.key}')" class="bg-yellow-500 text-white px-1 rounded text-[8px]">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="deleteItem('${child.key}')" class="bg-red-600 text-white px-1 rounded text-[8px]">X</button>
                        </td>
                        <td><a href="${d.link}" target="_blank" class="text-blue-700">ğŸ”—</a></td>
                        <td>${d.location || '-'}</td><td>${d.id_num || '-'}</td>
                        <td>${d.degree}</td><td>${d.year}</td><td>${d.dept}</td><td>${d.college}</td>
                        <td>${d.university}</td><td>${d.supervisor}</td>
                        <td class="text-right px-1 font-bold text-blue-900">${d.title}</td><td>${d.author}</td>
                    </tr>`;
                });
            });
        }

        document.getElementById('uploadForm').onsubmit = function(e) {
            e.preventDefault();
            const key = document.getElementById('editKey').value;
            const data = {
                author: document.getElementById('author').value, title: document.getElementById('title').value,
                supervisor: document.getElementById('supervisor').value, id_num: document.getElementById('id_num').value,
                university: document.getElementById('university').value, college: document.getElementById('college').value,
                dept: document.getElementById('dept').value, location: document.getElementById('location').value,
                degree: document.getElementById('degree').value, status: document.getElementById('status').value,
                year: document.getElementById('year').value, link: document.getElementById('link').value, notes: document.getElementById('notes').value
            };
            if (key) { db.ref('theses/' + key).update(data).then(() => { document.getElementById('editKey').value = ""; document.getElementById('saveBtn').innerText = "Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…"; }); }
            else { db.ref('theses').push(data); }
            this.reset();
        };

        window.editItem = function(key) {
            db.ref('theses/' + key).once('value').then(s => {
                const d = s.val(); document.getElementById('editKey').value = key;
                document.getElementById('author').value = d.author; document.getElementById('title').value = d.title;
                document.getElementById('university').value = d.university; document.getElementById('college').value = d.college;
                document.getElementById('dept').value = d.dept; document.getElementById('year').value = d.year;
                document.getElementById('link').value = d.link; document.getElementById('supervisor').value = d.supervisor || "";
                document.getElementById('id_num').value = d.id_num || ""; document.getElementById('location').value = d.location || "";
                document.getElementById('saveBtn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù† ğŸ”„";
            });
        };

        window.deleteItem = function(key) { if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ")) db.ref('theses/' + key).remove(); };
        function logout() { localStorage.clear(); window.location.href = 'login.html'; }
        loadData();
    </script>
</body>
</html>

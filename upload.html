<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>بوابة الرفع | الفهرس الليبي الموحد</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        body { background: #f1f5f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 11px; margin: 0; padding: 8px; overflow: hidden; }
        .dense-input { border: 1px solid #cbd5e1; padding: 2px 6px; border-radius: 3px; width: 100%; outline: none; height: 24px; }
        .label-dense { font-weight: bold; color: #1e3a8a; width: 90px; }
        table { width: 100%; border-collapse: collapse; background: white; table-layout: fixed; }
        th { background: #1e3a8a; color: white; padding: 4px; border: 1px solid #334155; position: sticky; top: 0; z-index: 10; }
        td { border: 1px solid #e2e8f0; padding: 3px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-header { padding: 3px 10px; border-radius: 3px; color: white; font-weight: bold; font-size: 10px; transition: 0.2s; }
    </style>
</head>
<body>

    <div class="flex justify-between items-center bg-white p-2 border rounded shadow-sm mb-2">
        <h2 class="text-blue-900 font-bold text-sm italic">الفهرس الليبي الموحد - بوابة الرفع</h2>
        <div class="flex gap-2">
            <button onclick="downloadTemplate()" class="btn-header bg-green-700 hover:bg-green-800">تحميل قالب Excel</button>
            <label class="btn-header bg-blue-600 hover:bg-blue-700 cursor-pointer">
                رفع ملف Excel <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls">
            </label>
            <button onclick="logout()" class="btn-header bg-red-600 hover:bg-red-700">تسجيل الخروج</button>
        </div>
    </div>

    <div class="bg-white border p-3 rounded shadow-sm mb-2">
        <form id="uploadForm">
            <input type="hidden" id="editKey"> <div class="grid grid-cols-4 gap-3">
                <div class="flex items-center"><span class="label-dense">اسم الباحث</span><input type="text" id="author" class="dense-input" required></div>
                <div class="flex items-center"><span class="label-dense">عنوان الرسالة</span><input type="text" id="title" class="dense-input" required></div>
                <div class="flex items-center"><span class="label-dense">المشرف</span><input type="text" id="supervisor" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">رقم الرسالة</span><input type="text" id="id_num" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">الجامعة</span><input type="text" id="university" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">الكلية</span><input type="text" id="college" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">القسم</span><input type="text" id="dept" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">الدرجة</span>
                    <select id="degree" class="dense-input"><option>ماجستير</option><option>دكتوراه</option></select>
                </div>
                <div class="flex items-center"><span class="label-dense">السنة</span><input type="number" id="year" class="dense-input"></div>
                <div class="flex items-center"><span class="label-dense">الحالة</span>
                    <select id="status" class="dense-input"><option>متوفرة</option><option>غير متوفرة</option></select>
                </div>
                <div class="flex items-center"><span class="label-dense">رابط الملف</span><input type="url" id="link" class="dense-input"></div>
                <button type="submit" id="saveBtn" class="bg-blue-900 text-white font-bold rounded h-6 hover:bg-black">اعتماد وحفظ البيانات</button>
            </div>
        </form>
    </div>

    <div class="bg-white border rounded shadow-sm overflow-hidden" style="height: calc(100vh - 180px);">
        <div class="overflow-y-auto h-full overflow-x-auto">
            <table dir="rtl">
                <thead>
                    <tr>
                        <th width="100px">الباحث</th>
                        <th width="150px">العنوان</th>
                        <th width="100px">الجامعة</th>
                        <th width="80px">الكلية</th>
                        <th width="80px">القسم</th>
                        <th width="60px">السنة</th>
                        <th width="60px">الدرجة</th>
                        <th width="50px">الرابط</th>
                        <th width="100px">الإجراء</th>
                    </tr>
                </thead>
                <tbody id="thesesTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNITo9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "libyan-theses-portal",
            storageBucket: "libyan-theses-portal.appspot.com",
            messagingSenderId: "782635467382",
            appId: "1:782635467382:web:48a60589a194519f964082"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. جلب البيانات
        function loadData() {
            db.ref('theses').on('value', snap => {
                const tbody = document.getElementById('thesesTable');
                tbody.innerHTML = "";
                snap.forEach(child => {
                    const d = child.val();
                    tbody.innerHTML += `
                        <tr class="hover:bg-blue-50">
                            <td>${d.author}</td>
                            <td class="text-right font-bold px-2">${d.title}</td>
                            <td>${d.university}</td>
                            <td>${d.college}</td>
                            <td>${d.dept}</td>
                            <td>${d.year}</td>
                            <td>${d.degree}</td>
                            <td><a href="${d.link}" target="_blank" class="text-blue-600 font-bold underline">فتح</a></td>
                            <td class="flex gap-1 justify-center py-1">
                                <button onclick="editItem('${child.key}')" class="bg-yellow-500 text-white px-2 py-1 rounded text-[9px]">تعديل</button>
                                <button onclick="deleteItem('${child.key}')" class="bg-red-600 text-white px-2 py-1 rounded text-[9px]">حذف</button>
                            </td>
                        </tr>`;
                });
            });
        }

        // 2. حفظ أو تعديل البيانات
        document.getElementById('uploadForm').onsubmit = function(e) {
            e.preventDefault();
            const key = document.getElementById('editKey').value;
            const data = {
                author: document.getElementById('author').value,
                title: document.getElementById('title').value,
                university: document.getElementById('university').value,
                college: document.getElementById('college').value,
                dept: document.getElementById('dept').value,
                degree: document.getElementById('degree').value,
                year: document.getElementById('year').value,
                supervisor: document.getElementById('supervisor').value,
                id_num: document.getElementById('id_num').value,
                status: document.getElementById('status').value,
                link: document.getElementById('link').value
            };

            if (key) {
                db.ref('theses/' + key).update(data).then(() => {
                    alert("تم التعديل!");
                    document.getElementById('editKey').value = "";
                });
            } else {
                db.ref('theses').push(data);
            }
            this.reset();
        };

        // 3. وظيفة التعديل
        window.editItem = function(key) {
            db.ref('theses/' + key).once('value').then(s => {
                const d = s.val();
                document.getElementById('editKey').value = key;
                document.getElementById('author').value = d.author;
                document.getElementById('title').value = d.title;
                document.getElementById('university').value = d.university;
                document.getElementById('college').value = d.college;
                document.getElementById('dept').value = d.dept;
                document.getElementById('year').value = d.year;
                document.getElementById('link').value = d.link;
                document.getElementById('saveBtn').innerText = "تحديث البيانات الآن";
            });
        };

        // 4. وظيفة حذف
        window.deleteItem = function(key) { if(confirm("هل أنت متأكد؟")) db.ref('theses/' + key).remove(); };

        // 5. وظيفة الإكسيل (رفع)
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(evt) {
                const workbook = XLSX.read(evt.target.result, {type: 'binary'});
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                data.forEach(item => db.ref('theses').push(item));
                alert("تم رفع " + data.length + " سجل بنجاح!");
            };
            reader.readAsBinaryString(file);
        });

        // 6. تحميل القالب
        window.downloadTemplate = function() {
            const data = [{ author: "اسم الباحث", title: "عنوان الرسالة", university: "الجامعة", college: "الكلية", dept: "القسم", degree: "ماجستير", year: 2024, link: "http://..." }];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "Library_Template.xlsx");
        };

        function logout() { localStorage.clear(); window.location.href = 'login.html'; }
        loadData();
    </script>
</body>
</html>

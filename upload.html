<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฑูุน ุงูุจูุงูุงุช | ุงูููุฑุณ ุงูููุจู ุงูููุญุฏ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f1f5f9; font-size: 11px; }
        .input-field { padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 4px; width: 100%; outline: none; transition: 0.2s; }
        .input-field:focus { border-color: #1e40af; box-shadow: 0 0 0 1px #1e40af; }
        label { display: block; margin-bottom: 2px; font-weight: bold; color: #1e3a8a; font-size: 10px; }
        th { background: #1e3a8a; color: white; padding: 6px; font-size: 11px; border: 1px solid #1e40af; position: sticky; top: 0; }
        td { padding: 4px; border: 1px solid #e2e8f0; background: white; white-space: nowrap; }
        .card { background: white; border-radius: 8px; shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body class="p-2">

    <div class="max-w-[1500px] mx-auto">
        <div class="bg-white p-3 rounded-t-lg border-b-2 border-blue-900 flex justify-between items-center shadow-sm">
            <div>
                <h1 class="text-sm font-bold text-blue-900">ููุญุฉ ุชุญูู ุงูููุงุฏูุจ - ุงูููุฑุณ ุงูููุจู ุงูููุญุฏ</h1>
                <p class="text-[10px] text-gray-500">ุฅุถุงูุฉ ุงูุฑุณุงุฆู ุงูุนูููุฉ (ูุฑุฏู / ุฌูุงุนู)</p>
            </div>
            <div class="flex gap-2">
                <button onclick="downloadTemplate()" class="bg-green-700 hover:bg-green-800 text-white px-4 py-1.5 rounded flex items-center gap-1 font-bold transition">
                    ๐ฅ ุชุญููู ูุงูุจ ุงูุฅูุณู (RTL)
                </button>
                <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls" onchange="handleExcel(event)">
                <button onclick="document.getElementById('excelFile').click()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-1.5 rounded flex items-center gap-1 font-bold transition">
                    ๐ค ุฑูุน ููู ุฅูุณู ุฌุงูุฒ
                </button>
            </div>
        </div>

        <div class="bg-blue-50 p-3 border-x border-b border-gray-200">
            <form id="uploadForm" class="grid grid-cols-6 gap-x-3 gap-y-2">
                <div><label>ุงุณู ุงูุจุงุญุซ</label><input type="text" id="author" class="input-field" required></div>
                <div class="col-span-2"><label>ุนููุงู ุงูุฑุณุงูุฉ</label><input type="text" id="title" class="input-field" required></div>
                <div><label>ุงููุดุฑู</label><input type="text" id="sup" class="input-field"></div>
                <div><label>ุงูุฌุงูุนุฉ</label><input type="text" id="uni" class="input-field" required></div>
                <div><label>ุงููููุฉ</label><input type="text" id="college" class="input-field"></div>
                
                <div><label>ุงููุณู</label><input type="text" id="dept" class="input-field"></div>
                <div>
                    <label>ุงูุฏุฑุฌุฉ ุงูุนูููุฉ</label>
                    <select id="degree" class="input-field">
                        <option value="ูุงุฌุณุชูุฑ">ูุงุฌุณุชูุฑ</option>
                        <option value="ุฏูุชูุฑุงู">ุฏูุชูุฑุงู</option>
                        <option value="ุฏุจููู ุนุงูู">ุฏุจููู ุนุงูู</option>
                    </select>
                </div>
                <div><label>ุงูุณูุฉ</label><input type="number" id="year" class="input-field"></div>
                <div><label>ุฑูู ุงูุฑุณุงูุฉ</label><input type="text" id="id" class="input-field"></div>
                <div>
                    <label>ุงูุญุงูุฉ</label>
                    <select id="status" class="input-field">
                        <option value="ูุชููุฑุฉ">โ ูุชููุฑุฉ</option>
                        <option value="ุบูุฑ ูุชููุฑุฉ">โ ุบูุฑ ูุชููุฑุฉ</option>
                    </select>
                </div>
                <div><label>ุฑุงุจุท ุงูุฑุณุงูุฉ (URL)</label><input type="url" id="link" class="input-field" placeholder="https://.."></div>
                
                <div class="col-span-5"><label>ููุงุญุธุงุช ุฅุถุงููุฉ</label><input type="text" id="notes" class="input-field"></div>
                <div class="flex items-end">
                    <button type="submit" class="bg-blue-900 text-white w-full py-1.5 rounded font-bold hover:bg-black transition">ุญูุธ ุงูุจูุงูุงุช</button>
                </div>
            </form>
        </div>

        <div class="bg-white mt-2 rounded-b-lg shadow-inner overflow-x-auto max-h-[450px]">
            <table class="w-full text-right border-collapse">
                <thead>
                    <tr>
                        <th>ุงูุจุงุญุซ</th><th>ุงูุนููุงู</th><th>ุงููุดุฑู</th><th>ุงูุฌุงูุนุฉ</th><th>ุงููููุฉ</th><th>ุงููุณู</th><th>ุงูุฏุฑุฌุฉ</th><th>ุงูุณูุฉ</th><th>ุฑูู ุงูุฑุณุงูุฉ</th><th>ุงูุญุงูุฉ</th><th>๐</th><th>ุงูููุงุญุธุงุช</th>
                    </tr>
                </thead>
                <tbody id="previewBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // ุฅุนุฏุงุฏุงุช Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAogBGo2_OzNito9D9AXVyAjSjmu-DYotc",
            authDomain: "libyan-theses-portal.firebaseapp.com",
            projectId: "libyan-theses-portal",
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
            appId: "1:80818219253:web:5ca7224ac6a5c8a7377dbc"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. ูุธููุฉ ุชุญููู ูุงูุจ ุงูุฅูุณู (RTL)
        function downloadTemplate() {
            const headers = [["ุงูุจุงุญุซ", "ุงูุนููุงู", "ุงููุดุฑู", "ุงูุฌุงูุนุฉ", "ุงููููุฉ", "ุงููุณู", "ุงูุฏุฑุฌุฉ", "ุงูุณูุฉ", "ุฑูู ุงูุฑุณุงูุฉ", "ุงูุญุงูุฉ", "ุงูุฑุงุจุท", "ุงูููุงุญุธุงุช"]];
            const ws = XLSX.utils.aoa_to_sheet(headers);
            
            // ุถุจุท ุงูุงุชุฌุงู ูู ุงููููู ุฅูู ุงููุณุงุฑ
            if(!ws['!views']) ws['!views'] = [];
            ws['!views'][0] = { RTL: true };

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ุงูููุฑุณ ุงูููุจู ุงูููุญุฏ");
            XLSX.writeFile(wb, "Libyan_Theses_Template.xlsx");
        }

        // 2. ูุนุงูุฌุฉ ูุญูุธ ุงูููุฑู ุงููุฑุฏู
        document.getElementById('uploadForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = {
                author: document.getElementById('author').value,
                title: document.getElementById('title').value,
                sup: document.getElementById('sup').value,
                uni: document.getElementById('uni').value,
                college: document.getElementById('college').value,
                dept: document.getElementById('dept').value,
                degree: document.getElementById('degree').value,
                year: document.getElementById('year').value,
                id: document.getElementById('id').value,
                status: document.getElementById('status').value,
                link: document.getElementById('link').value,
                notes: document.getElementById('notes').value
            };
            db.ref('theses').push(data).then(() => {
                alert('ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ ูู ุงูููุฑุณ ุงูููุญุฏ');
                document.getElementById('uploadForm').reset();
            });
        });

        // 3. ุฑูุน ุงูุฅูุณู ุงูุฌูุงุนู
        function handleExcel(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                let count = 0;
                jsonData.forEach(row => {
                    db.ref('theses').push({
                        author: row["ุงูุจุงุญุซ"], title: row["ุงูุนููุงู"], sup: row["ุงููุดุฑู"],
                        uni: row["ุงูุฌุงูุนุฉ"], college: row["ุงููููุฉ"], dept: row["ุงููุณู"],
                        degree: row["ุงูุฏุฑุฌุฉ"], year: row["ุงูุณูุฉ"], id: row["ุฑูู ุงูุฑุณุงูุฉ"],
                        status: row["ุงูุญุงูุฉ"], link: row["ุงูุฑุงุจุท"], notes: row["ุงูููุงุญุธุงุช"]
                    });
                    count++;
                });
                alert('ุชู ุจูุฌุงุญ ุฑูุน ' + count + ' ุฑุณุงูุฉ ุฅูู ุงูููุฑุณ.');
                location.reload();
            };
            reader.readAsArrayBuffer(file);
        }

        // 4. ุนุฑุถ ุขุฎุฑ ุงูุจูุงูุงุช ุงููุฑููุนุฉ ูููุนุงููุฉ
        db.ref('theses').limitToLast(10).on('value', (snap) => {
            const tbody = document.getElementById('previewBody');
            tbody.innerHTML = '';
            snap.forEach(child => {
                const val = child.val();
                tbody.innerHTML += `
                    <tr>
                        <td class="font-bold">${val.author || '-'}</td>
                        <td class="text-blue-800">${val.title || '-'}</td>
                        <td>${val.sup || '-'}</td>
                        <td>${val.uni || '-'}</td>
                        <td>${val.college || '-'}</td>
                        <td>${val.dept || '-'}</td>
                        <td class="text-center font-bold text-blue-600">${val.degree || '-'}</td>
                        <td class="text-center font-mono">${val.year || '-'}</td>
                        <td class="text-center text-gray-400 font-mono">${val.id || '-'}</td>
                        <td class="text-center"><span class="px-1 py-0.5 rounded text-[9px] ${val.status==='ูุชููุฑุฉ'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${val.status || '-'}</span></td>
                        <td class="text-center">${val.link ? '๐' : '-'}</td>
                        <td class="text-[9px] italic text-gray-500">${val.notes || '-'}</td>
                    </tr>
                `;
            });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ | Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-size: 11px; background-color: #f8fafc; font-family: sans-serif; }
        .dense-input { border: 1px solid #cbd5e1; padding: 4px; border-radius: 2px; width: 100%; font-size: 11px; }
        th { background: #1e3a8a; color: white; padding: 4px; border: 1px solid #475569; }
        td { padding: 4px; border: 1px solid #cbd5e1; text-align: center; background: white; }
    </style>
</head>
<body class="p-2">

    <div class="flex justify-between items-center bg-white p-2 border border-slate-300 mb-2 shadow-sm">
        <div>
            <h1 class="text-blue-900 font-bold text-sm italic">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ©</h1>
            <span id="libBadge" class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-[10px] font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span>
        </div>
        <button onclick="logout()" class="text-red-600 border border-red-200 px-2 py-1 rounded font-bold hover:bg-red-50">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="bg-white p-3 border border-slate-300 mb-2">
        <form id="thesisForm" class="grid grid-cols-5 gap-2">
            <div class="col-span-2">
                <input type="text" id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ©" class="dense-input font-bold" required>
            </div>
            <input type="text" id="author" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø­Ø«" class="dense-input" required>
            <input type="text" id="year" placeholder="Ø§Ù„Ø³Ù†Ø©" class="dense-input">
            <button type="submit" class="bg-blue-900 text-white font-bold rounded hover:bg-blue-800">Ø­ÙØ¸ Ø§Ù„Ø¢Ù†</button>
        </form>
    </div>

    <div class="bg-white border border-slate-300 overflow-x-auto shadow-md">
        <table class="w-full border-collapse">
            <thead>
                <tr>
                    <th class="w-2/3 text-right pr-4 italic">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
                    <th>Ø§Ù„Ø¨Ø§Ø­Ø«</th>
                    <th>Ø§Ù„Ø³Ù†Ø©</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="dataTableBody"></tbody>
        </table>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
        const libID = localStorage.getItem('libToken');
        const libName = localStorage.getItem('libName');

        // Ø§Ù„Ø­Ù…Ø§ÙŠØ©: Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø©
        if (!libID || !libName) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('libBadge').innerText = "ğŸ“ " + libName;
        }

        // Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹ Ø®ØªÙ… Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø©
        document.getElementById('thesisForm').onsubmit = (e) => {
            e.preventDefault();
            db.ref('theses_data').push({
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                year: document.getElementById('year').value,
                location: libName, // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø«Ø§Ø¨ØªØ© Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©
                libID: libID,      // Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„ÙÙ„ØªØ±Ø©
                timestamp: Date.now()
            }).then(() => {
                alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­");
                document.getElementById('thesisForm').reset();
            });
        };

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙÙ‚Ø· (Ø®ØµÙˆØµÙŠØ© ØªØ§Ù…Ø©)
        function loadData() {
            db.ref('theses_data').orderByChild('libID').equalTo(libID).on('value', snap => {
                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = '';
                snap.forEach(child => {
                    const v = child.val();
                    tbody.innerHTML += `
                        <tr>
                            <td class="text-right pr-4 font-bold text-blue-900">${v.title}</td>
                            <td>${v.author}</td>
                            <td>${v.year || '-'}</td>
                            <td><button onclick="db.ref('theses_data/${child.key}').remove()" class="text-red-600">Ø­Ø°Ù</button></td>
                        </tr>`;
                });
            });
        }

        function logout() { localStorage.clear(); window.location.href = 'login.html'; }
        loadData();
    </script>
</body>
</html>

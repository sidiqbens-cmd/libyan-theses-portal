<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-size: 14px; background-color: #f1f5f9; padding: 5px; font-family: sans-serif; }
        .main-card { background: white; border-radius: 4px; border-top: 4px solid #1e3a8a; margin-bottom: 5px; border: 1px solid #ddd; }
        input, select { width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; font-size: 11px; outline: none; }
        th { background: #1e3a8a; color: white; padding: 4px; border: 1px solid #cbd5e1; white-space: nowrap; }
        td { padding: 3px; border: 1px solid #e2e8f0; text-align: center; background: white; }
        .excel-btn { background: #15803d; color: white; padding: 3px 8px; border-radius: 3px; font-weight: bold; cursor: pointer; font-size: 10px; }
    </style>
</head>
<body>
    <div class="flex justify-between items-center mb-1 px-1">
        <h1 class="text-blue-900 font-bold text-xs italic">Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
        <div class="flex gap-3 items-center">
            <a href="#" onclick="downloadTemplate()" class="text-green-700 underline font-bold text-[10px]">ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Excel</a>
            <label class="excel-btn"> Ø±ÙØ¹ Ù…Ù„Ù Excel <input type="file" id="excelFile" accept=".xlsx, .xls" hidden onchange="uploadExcel(this)"> </label>
        </div>
    </div>

    <div class="main-card p-3">
        <form id="thesisForm">
            <input type="hidden" id="editKey">
            <div class="grid grid-cols-4 gap-2 mb-2">
                <input type="text" id="author" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø­Ø«" required>
                <input type="text" id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©" required>
                <input type="text" id="supervisor" placeholder="Ø§Ù„Ù…Ø´Ø±Ù" required>
                <input type="text" id="serialNum" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©">
            </div>
            <div class="grid grid-cols-4 gap-2 mb-2">
                <input type="text" id="university" placeholder="Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©" required>
                <input type="text" id="college" placeholder="Ø§Ù„ÙƒÙ„ÙŠØ©" required>
                <input type="text" id="department" placeholder="Ø§Ù„Ù‚Ø³Ù…" required>
                <input type="text" id="location" placeholder="Ù…ÙƒØ§Ù† Ø§Ù„ØªÙˆØ§Ø¬Ø¯ (Ø§Ù„Ù…ÙƒØªØ¨Ø©)" required>
            </div>
            <div class="grid grid-cols-4 gap-2 mb-2">
                <select id="degree"><option>Ù…Ø§Ø¬Ø³ØªÙŠØ±</option><option>Ø¯ÙƒØªÙˆØ±Ø§Ù‡</option></select>
                <select id="status"><option>Ù…ØªÙˆÙØ±Ø©</option><option>ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</option></select>
                <input type="number" id="year" placeholder="Ø§Ù„Ø³Ù†Ø©">
                <input type="url" id="link" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·">
            </div>
            <div class="flex gap-2">
                <input type="text" id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
                <button type="submit" id="submitBtn" class="bg-blue-900 text-white font-bold px-6 py-1 rounded cursor-pointer">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…</button>
                <button type="button" id="cancelEdit" class="hidden bg-gray-500 text-white px-4 py-1 rounded">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            </div>
        </form>
    </div>

    <div class="main-card p-2 bg-blue-50 grid grid-cols-7 gap-2 border-blue-200 border">
        <input type="text" id="f_gs" placeholder="ğŸ” Ø¨Ø­Ø« Ø´Ø§Ù…Ù„..." onkeyup="filterTable()">
        <input type="text" id="f_uni" placeholder="ØªØµÙÙŠØ© Ø¨Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©" onkeyup="filterTable()">
        <input type="text" id="f_coll" placeholder="ØªØµÙÙŠØ© Ø¨Ø§Ù„ÙƒÙ„ÙŠØ©" onkeyup="filterTable()">
        <input type="text" id="f_dept" placeholder="ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù‚Ø³Ù…" onkeyup="filterTable()">
        <input type="text" id="f_year" placeholder="ØªØµÙÙŠØ© Ø¨Ø§Ù„Ø³Ù†Ø©" onkeyup="filterTable()">
        <input type="text" id="f_loc" placeholder="ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù…ÙƒØ§Ù†" onkeyup="filterTable()">
        <select id="f_deg" onchange="filterTable()"><option value="">ÙƒÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</option><option>Ù…Ø§Ø¬Ø³ØªÙŠØ±</option><option>Ø¯ÙƒØªÙˆØ±Ø§Ø©</option></select>
    </div>

    <div class="main-card overflow-x-auto">
        <table class="w-full border-collapse min-w-[1400px]">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø¨Ø§Ø­Ø«</th><th class="w-1/4">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù…Ø´Ø±Ù</th><th>Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ„ÙŠØ©</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø³Ù†Ø©</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>Ø±Ù‚Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th><th>Ø§Ù„Ù…ÙƒØ§Ù†</th><th>Ø§Ù„Ø±Ø§Ø¨Ø·</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="thesesTableBody"></tbody>
        </table>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAogBGo2_OzNito9D9AXVyAjSjmu-DYotc", authDomain: "libyan-theses-portal.firebaseapp.com", projectId: "libyan-theses-portal", databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app", appId: "1:80818219253:web:5ca7224ac6a5c8a7377dbc" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function loadData() {
        db.ref('theses_data').on('value', snap => {
            const tbody = document.getElementById('thesesTableBody');
            tbody.innerHTML = '';
            snap.forEach(child => {
                const v = child.val();
                tbody.innerHTML += `<tr>
                    <td>${v.author || ''}</td><td>${v.title || ''}</td><td>${v.supervisor || ''}</td><td>${v.university || ''}</td><td>${v.college || ''}</td><td>${v.department || ''}</td><td>${v.year || ''}</td><td>${v.degree ||   ''}</td><td>${v.serialNum ||''}</td><td>${v.location || ''}</td>
                    <td>${v.link ? `<a href="${v.link}" target="_blank" class="text-blue-600 underline">Ø¹Ø±Ø¶</a>` : '-'}</td>
                    <td class="flex gap-1 justify-center">
                        <button onclick="editRow('${child.key}')" class="bg-blue-600 text-white px-2 rounded">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button onclick="if(confirm('Ø­Ø°ÙØŸ')) db.ref('theses_data/${child.key}').remove()" class="bg-red-600 text-white px-2 rounded font-bold">X</button>
                    </td>
                </tr>`;
            });
        });
    }
    loadData();

    document.getElementById('thesisForm').onsubmit = (e) => {
        e.preventDefault();
        const key = document.getElementById('editKey').value;
        const data = {
            author: document.getElementById('author').value, title: document.getElementById('title').value,
            supervisor: document.getElementById('supervisor').value, serialNum: document.getElementById('serialNum').value,
            university: document.getElementById('university').value, college: document.getElementById('college').value,
            department: document.getElementById('department').value, location: document.getElementById('location').value,
            degree: document.getElementById('degree').value, status: document.getElementById('status').value,
            year: document.getElementById('year').value, link: document.getElementById('link').value || "",
            notes: document.getElementById('notes').value || ""
        };
        if(key) {
            db.ref('theses_data/' + key).update(data).then(() => { resetForm(); alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…"); });
        } else {
            db.ref('theses_data').push(data).then(() => { resetForm(); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…"); });
        }
    };

    function editRow(key) {
        db.ref('theses_data/' + key).once('value', snap => {
            const v = snap.val();
            document.getElementById('editKey').value = key;
            document.getElementById('author').value = v.author || '';
            document.getElementById('title').value = v.title || '';
            document.getElementById('supervisor').value = v.supervisor || '';
            document.getElementById('university').value = v.university || '';
            document.getElementById('college').value = v.college || '';
            document.getElementById('department').value = v.department || '';
            document.getElementById('location').value = v.location || '';
            document.getElementById('degree').value = v.degree || '';
            document.getElementById('serialNum').value = v.serialNum || '';
            document.getElementById('status').value = v.status || '';
            document.getElementById('year').value = v.year || '';
            document.getElementById('link').value = v.link || '';
            document.getElementById('notes').value = v.notes || '';
            document.getElementById('submitBtn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ”„";
            document.getElementById('cancelEdit').classList.remove('hidden');
            window.scrollTo(0,0);
        });
    }

    function resetForm() {
        document.getElementById('thesisForm').reset();
        document.getElementById('editKey').value = "";
        document.getElementById('submitBtn').innerText = "Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…";
        document.getElementById('cancelEdit').classList.add('hidden');
    }

    document.getElementById('cancelEdit').onclick = resetForm;

    function uploadExcel(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet);
            rows.forEach(row => {
                db.ref('theses_data').push({
                    author: row['Ø§Ù„Ø¨Ø§Ø­Ø«'] || '', title: row['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'] || '', supervisor: row['Ø§Ù„Ù…Ø´Ø±Ù'] || '',
                    university: row['Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©'] || '', college: row['Ø§Ù„ÙƒÙ„ÙŠØ©'] || '', department: row['Ø§Ù„Ù‚Ø³Ù…'] || '',
                    location: row['Ù…ÙƒØ§Ù† Ø§Ù„ØªÙˆØ§Ø¬Ø¯'] || '', year: row['Ø§Ù„Ø³Ù†Ø©'] || '', degree: row['Ø§Ù„Ø¯Ø±Ø¬Ø©'] || '',
                    status: row['Ø§Ù„Ø­Ø§Ù„Ø©'] || 'Ù…ØªÙˆÙØ±Ø©', link: row['Ø§Ù„Ø±Ø§Ø¨Ø·'] || '', serialNum: row['Ø±Ù‚Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©'] || '', notes: row['Ù…Ù„Ø§Ø­Ø¸Ø§Øª'] || ''
                });
            });
            alert("ØªÙ… Ø±ÙØ¹ " + rows.length + " Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        };
        reader.readAsArrayBuffer(file);
    }

    function downloadTemplate() {
        const wb = XLSX.utils.book_new();
        // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„
        const wsData = [{ 
            "Ø§Ù„Ø¨Ø§Ø­Ø«": "", "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†": "", "Ø§Ù„Ù…Ø´Ø±Ù": "", "Ø±Ù‚Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©": "", "Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©": "", 
            "Ø§Ù„ÙƒÙ„ÙŠØ©": "", "Ø§Ù„Ù‚Ø³Ù…": "", "Ø§Ù„Ø³Ù†Ø©": "", "Ø§Ù„Ø¯Ø±Ø¬Ø©": "Ù…Ø§Ø¬Ø³ØªÙŠØ±", 
            "Ù…ÙƒØ§Ù† Ø§Ù„ØªÙˆØ§Ø¬Ø¯": "", "Ø§Ù„Ø±Ø§Ø¨Ø·": "", "Ø§Ù„Ø­Ø§Ù„Ø©": "Ù…ØªÙˆÙØ±Ø©", "Ù…Ù„Ø§Ø­Ø¸Ø§Øª": "" 
        }];
        const ws = XLSX.utils.json_to_sheet(wsData);
        
        // ØªØ¹ÙŠÙŠÙ† Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø± ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„
        if(!ws['!views']) ws['!views'] = [{}];
        ws['!views'][0].rightToLeft = true;

        XLSX.utils.book_append_sheet(wb, ws, "Template");
        XLSX.writeFile(wb, "Libyan_Theses_Template.xlsx");
    }

    function filterTable() {
    const q = document.getElementById('f_gs').value.toLowerCase().trim();
    const u = document.getElementById('f_uni').value.toLowerCase().trim();
    const c = document.getElementById('f_coll').value.toLowerCase().trim();
    const d = document.getElementById('f_dept').value.toLowerCase().trim();
    const y = document.getElementById('f_year').value.toLowerCase().trim();
    const loc = document.getElementById('f_loc').value.toLowerCase().trim(); // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const deg = document.getElementById('f_deg').value.toLowerCase().trim();

    document.querySelectorAll('#thesesTableBody tr').forEach(row => {
        const cells = row.children;
        
        const match = row.innerText.toLowerCase().includes(q) && 
                      cells[3].innerText.toLowerCase().includes(u) && 
                      cells[4].innerText.toLowerCase().includes(c) && 
                      cells[5].innerText.toLowerCase().includes(d) && 
                      cells[6].innerText.toLowerCase().includes(y) && 
                      cells[9].innerText.toLowerCase().includes(loc) && // Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø¹Ù…ÙˆØ¯ Ù…ÙƒØ§Ù† Ø§Ù„ØªÙˆØ§Ø¬Ø¯
                      (deg === "" || cells[7].innerText.toLowerCase().includes(deg));

        row.style.display = match ? "" : "none";
    });
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¯Ø§Ø±Ø© ÙˆØ±ÙØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ | Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-size: 11px; background-color: #f1f5f9; font-family: sans-serif; }
        .dense-input { border: 1px solid #cbd5e1; padding: 4px; border-radius: 2px; width: 100%; outline: none; }
        .dense-input:focus { border-color: #1e3a8a; }
        th { background: #1e3a8a; color: white; padding: 4px; border: 1px solid #475569; text-align: center; }
        td { padding: 4px; border: 1px solid #cbd5e1; text-align: center; background: white; }
        .card { background: white; border: 1px solid #cbd5e1; padding: 8px; margin-bottom: 5px; }
    </style>
</head>
<body class="p-2">

    <div class="card flex justify-between items-center border-b-2 border-blue-900">
        <div>
            <h1 class="text-blue-900 font-bold text-sm italic">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ù„ÙŠØ¨ÙŠØ©</h1>
            <span id="libInfo" class="text-green-700 font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span>
        </div>
        <button onclick="logout()" class="bg-red-50 text-red-600 border border-red-200 px-3 py-1 rounded font-bold">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="card">
        <form id="uploadForm" class="grid grid-cols-6 gap-2">
            <div class="col-span-2">
                <label class="block text-[10px] text-gray-500">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                <input type="text" id="title" class="dense-input font-bold" required>
            </div>
            <div>
                <label class="block text-[10px] text-gray-500">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø­Ø«</label>
                <input type="text" id="author" class="dense-input" required>
            </div>
            <div>
                <label class="block text-[10px] text-gray-500">Ø§Ù„Ø³Ù†Ø©</label>
                <input type="text" id="year" class="dense-input">
            </div>
            <div>
                <label class="block text-[10px] text-gray-500">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…</label>
                <input type="text" id="serial" class="dense-input">
            </div>
            <div class="flex items-end">
                <button type="submit" class="w-full bg-blue-900 text-white font-bold py-1 rounded hover:bg-blue-800">Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
            </div>
        </form>
    </div>

    <div class="card overflow-x-auto shadow-sm">
        <div class="mb-1 flex justify-between items-center">
            <span class="font-bold text-blue-900 italic underline">Ø±Ø³Ø§Ø¦Ù„ Ù…ÙƒØªØ¨ØªÙƒÙ… Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:</span>
            <div id="count" class="text-gray-600 font-bold">Ø§Ù„Ø¹Ø¯Ø¯: 0</div>
        </div>
        <table class="w-full border-collapse">
            <thead>
                <tr>
                    <th class="w-1/12 text-center">Ø§Ù„Ø±Ù‚Ù…</th>
                    <th class="w-5/12 text-right pr-2">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
                    <th class="w-3/12 text-right pr-2">Ø§Ù„Ø¨Ø§Ø­Ø«</th>
                    <th class="w-1/12 text-center">Ø§Ù„Ø³Ù†Ø©</th>
                    <th class="w-2/12 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="dataTableBody"></tbody>
        </table>
    </div>

    <script>
        const firebaseConfig = { 
            databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ÙƒØªØ¨Ø©
        const libID = localStorage.getItem('libToken');
        const libName = localStorage.getItem('libName');

        if (!libID || !libName) {
            alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
            window.location.href = 'login.html';
        } else {
            document.getElementById('libInfo').innerText = "ğŸ“ Ù…ÙƒØªØ¨Ø©: " + libName;
        }

        // 2. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø±Ø¨Ø·Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ù„Ù…ÙƒØªØ¨Ø©
        document.getElementById('uploadForm').onsubmit = (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                year: document.getElementById('year').value,
                serialNum: document.getElementById('serial').value,
                location: libName, // ØªÙØ¶Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
                libID: libID,      // ØªÙØ³ØªØ®Ø¯Ù… Ù„Ù„ÙÙ„ØªØ±Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø®ØµÙˆØµÙŠØ©
                timestamp: Date.now()
            };

            db.ref('theses_data').push(data).then(() => {
                alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                document.getElementById('uploadForm').reset();
            });
        };

        // 3. Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙÙ‚Ø·
        function loadMyData() {
            db.ref('theses_data').orderByChild('libID').equalTo(libID).on('value', snap => {
                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = '';
                let total = 0;
                snap.forEach(child => {
                    const v = child.val();
                    const k = child.key;
                    total++;
                    tbody.innerHTML += `
                        <tr>
                            <td>${v.serialNum || '-'}</td>
                            <td class="text-right pr-2 font-bold text-blue-900">${v.title}</td>
                            <td class="text-right pr-2">${v.author}</td>
                            <td>${v.year || '-'}</td>
                            <td>
                                <button onclick="deleteRecord('${k}')" class="text-red-600 font-bold hover:underline">Ø­Ø°Ù</button>
                            </td>
                        </tr>`;
                });
                document.getElementById('count').innerText = "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø±Ø³Ø§Ø¦Ù„ÙƒÙ…: " + total;
            });
        }

        function deleteRecord(key) {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
                db.ref('theses_data/' + key).remove();
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        loadMyData();
    </script>
</body>
</html>

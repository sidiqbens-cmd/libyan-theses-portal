<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ | Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-size: 11px; background-color: #f1f5f9; padding: 5px; }
        .main-card { background: white; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-top: 4px solid #1e3a8a; margin-bottom: 5px; }
        input, select { width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; font-size: 11px; }
        th { background: #1e3a8a; color: white; padding: 4px; border: 1px solid #cbd5e1; sticky; top: 0; }
        td { padding: 3px; border: 1px solid #e2e8f0; text-align: center; background: white; }
        .edit-input { background: #fffde7; border: 1px solid #fbc02d !important; font-weight: bold; color: #000; }
        .btn { padding: 2px 8px; border-radius: 3px; font-weight: bold; cursor: pointer; font-size: 10px; margin: 0 1px; }
        .btn-save-row { background: #16a34a; color: white; }
        .btn-cancel-row { background: #94a3b8; color: white; }
        .btn-edit-row { background: #ca8a04; color: white; }
        .btn-delete-row { background: #dc2626; color: white; }
    </style>
</head>
<body>

    <div class="flex justify-between items-center mb-2 px-2">
        <div class="flex gap-2">
            <button onclick="downloadTemplate()" class="bg-green-700 text-white px-3 py-1 rounded font-bold">ğŸ“¥ Ù‚Ø§Ù„Ø¨ Ø¥ÙƒØ³Ù„</button>
            <button onclick="document.getElementById('xlFile').click()" class="bg-orange-600 text-white px-3 py-1 rounded font-bold">ğŸ“¤ Ø±ÙØ¹ Ø¥ÙƒØ³Ù„</button>
            <input type="file" id="xlFile" class="hidden" accept=".xlsx, .xls" onchange="importExcel(event)">
        </div>
        <h1 class="text-blue-900 font-bold text-xs italic">Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ</h1>
    </div>

    <div class="main-card p-3 border">
        <form id="thesisForm">
            <div class="grid grid-cols-4 gap-2 mb-2">
                <input type="text" id="author" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø­Ø«" required>
                <input type="text" id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©" required>
                <input type="text" id="supervisor" placeholder="Ø§Ù„Ù…Ø´Ø±Ù">
                <input type="text" id="serialNum" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©">
            </div>
            <div class="grid grid-cols-3 gap-2 mb-2">
                <input type="text" id="university" placeholder="Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©" required>
                <input type="text" id="college" placeholder="Ø§Ù„ÙƒÙ„ÙŠØ©" required>
                <input type="text" id="department" placeholder="Ø§Ù„Ù‚Ø³Ù…" required>
            </div>
            <div class="grid grid-cols-5 gap-2">
                <select id="degree"><option>Ù…Ø§Ø¬Ø³ØªÙŠØ±</option><option>Ø¯ÙƒØªÙˆØ±Ø§Ø©</option></select>
                <select id="status"><option>Ù…ØªÙˆÙØ±Ø©</option><option>ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</option></select>
                <input type="number" id="year" placeholder="Ø§Ù„Ø³Ù†Ø©">
                <input type="url" id="link" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·">
                <button type="submit" class="bg-blue-900 text-white font-bold rounded">Ø­ÙØ¸ Ø¬Ø¯ÙŠØ¯ âœ…</button>
            </div>
        </form>
    </div>

    <div class="main-card overflow-hidden">
        <table class="w-full border-collapse">
            <thead>
                <tr>
                    <th class="w-1/6">Ø§Ù„Ø¨Ø§Ø­Ø«</th>
                    <th class="w-1/3">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                    <th>Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</th>
                    <th>Ø§Ù„ÙƒÙ„ÙŠØ©</th>
                    <th>Ø§Ù„Ø³Ù†Ø©</th>
                    <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="thesesTableBody"></tbody>
        </table>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAogBGo2_OzNito9D9AXVyAjSjmu-DYotc",
        authDomain: "libyan-theses-portal.firebaseapp.com",
        projectId: "libyan-theses-portal",
        databaseURL: "https://libyan-theses-portal-default-rtdb.europe-west1.firebasedatabase.app",
        appId: "1:80818219253:web:5ca7224ac6a5c8a7377dbc"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    db.ref('theses_data').on('value', (snap) => {
        const tbody = document.getElementById('thesesTableBody');
        tbody.innerHTML = '';
        snap.forEach(child => {
            const v = child.val();
            const id = child.key;
            tbody.innerHTML += `
                <tr id="row-${id}">
                    <td class="text-right pr-2 font-bold text-blue-900">${v.author}</td>
                    <td class="text-right text-blue-800">${v.title}</td>
                    <td>${v.university}</td>
                    <td>${v.college}</td>
                    <td>${v.year}</td>
                    <td>${v.degree}</td>
                    <td>
                        <button onclick="enableEdit('${id}')" class="btn btn-edit-row">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button onclick="deleteRecord('${id}')" class="btn btn-delete-row">Ø­Ø°Ù</button>
                    </td>
                </tr>`;
        });
    });

    // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„Ø³Ø·Ø±
    function enableEdit(id) {
        const row = document.getElementById(`row-${id}`);
        const cells = row.getElementsByTagName('td');
        const oldData = {
            author: cells[0].innerText,
            title: cells[1].innerText,
            university: cells[2].innerText,
            college: cells[3].innerText,
            year: cells[4].innerText,
            degree: cells[5].innerText
        };

        row.innerHTML = `
            <td><input type="text" class="edit-input" id="edit-author-${id}" value="${oldData.author}"></td>
            <td><input type="text" class="edit-input" id="edit-title-${id}" value="${oldData.title}"></td>
            <td><input type="text" class="edit-input" id="edit-uni-${id}" value="${oldData.university}"></td>
            <td><input type="text" class="edit-input" id="edit-coll-${id}" value="${oldData.college}"></td>
            <td><input type="number" class="edit-input" id="edit-year-${id}" value="${oldData.year}"></td>
            <td><select class="edit-input" id="edit-deg-${id}">
                <option ${oldData.degree === 'Ù…Ø§Ø¬Ø³ØªÙŠØ±' ? 'selected' : ''}>Ù…Ø§Ø¬Ø³ØªÙŠØ±</option>
                <option ${oldData.degree === 'Ø¯ÙƒØªÙˆØ±Ø§Ø©' ? 'selected' : ''}>Ø¯ÙƒØªÙˆØ±Ø§Ø©</option>
            </select></td>
            <td>
                <button onclick="saveEdit('${id}')" class="btn btn-save-row">Ø­ÙØ¸</button>
                <button onclick="location.reload()" class="btn btn-cancel-row">Ø¥Ù„ØºØ§Ø¡</button>
            </td>
        `;
    }

    // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¥Ù„Ù‰ Firebase
    function saveEdit(id) {
        const updatedData = {
            author: document.getElementById(`edit-author-${id}`).value,
            title: document.getElementById(`edit-title-${id}`).value,
            university: document.getElementById(`edit-uni-${id}`).value,
            college: document.getElementById(`edit-coll-${id}`).value,
            year: document.getElementById(`edit-year-${id}`).value,
            degree: document.getElementById(`edit-deg-${id}`).value
        };

        db.ref('theses_data').child(id).update(updatedData)
            .then(() => alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…"));
    }

    // (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„: Ø­Ø°ÙØŒ Ø­ÙØ¸ Ø¬Ø¯ÙŠØ¯ØŒ Ø¥ÙƒØ³Ù„ ØªØ¸Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ)
    document.getElementById('thesisForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const data = {
            author: document.getElementById('author').value,
            title: document.getElementById('title').value,
            university: document.getElementById('university').value,
            college: document.getElementById('college').value,
            year: document.getElementById('year').value,
            degree: document.getElementById('degree').value,
            status: document.getElementById('status').value
        };
        db.ref('theses_data').push(data).then(() => {
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸!");
            document.getElementById('thesisForm').reset();
        });
    });

    function deleteRecord(id) {
        if(confirm("Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) db.ref('theses_data').child(id).remove();
    }

    function downloadTemplate() {
        const h = [["Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø­Ø«", "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©", "Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©", "Ø§Ù„ÙƒÙ„ÙŠØ©", "Ø§Ù„Ø³Ù†Ø©", "Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ©"]];
        const ws = XLSX.utils.aoa_to_sheet(h);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, "Template.xlsx");
    }

    function importExcel(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = new Uint8Array(event.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            json.forEach(r => {
                db.ref('theses_data').push({
                    author: r["Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø­Ø«"] || "",
                    title: r["Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©"] || "",
                    university: r["Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©"] || "",
                    college: r["Ø§Ù„ÙƒÙ„ÙŠØ©"] || "",
                    year: r["Ø§Ù„Ø³Ù†Ø©"] || "",
                    degree: r["Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ©"] || "Ù…Ø§Ø¬Ø³ØªÙŠØ±"
                });
            });
            alert("ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­");
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>
